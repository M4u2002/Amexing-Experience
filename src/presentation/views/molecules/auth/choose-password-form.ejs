<%
/**
 * Choose Password Form Molecule
 * Form for setting new password with confirmation and security features
 *
 * @param {string} error - Error message to display (optional)
 * @param {string} success - Success message to display (optional)
 * @param {string} csrfToken - CSRF token for form security
 * @param {string} token - Password reset token
 * @param {string} title - Form title (optional)
 */

// Default parameters
const chooseError = typeof error !== 'undefined' ? error : '';
const chooseSuccess = typeof success !== 'undefined' ? success : '';
const chooseCsrfToken = typeof csrfToken !== 'undefined' ? csrfToken : '';
const chooseToken = typeof token !== 'undefined' ? token : '';
const chooseTitle = typeof title !== 'undefined' ? title : 'Choose New Password';
%>

<div class="choose-password-container">
    <!-- Header -->
    <div class="text-center mb-4">
        <div class="reset-icon mb-3">
            <i class="ti ti-shield-lock fs-1 text-success"></i>
        </div>
        <h2 class="fw-bold text-dark mb-3"><%= chooseTitle %></h2>
        <p class="text-muted">Create a strong password to secure your account</p>
    </div>

    <!-- Success Message -->
    <% if (chooseSuccess) { %>
        <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
            <i class="ti ti-circle-check me-2"></i>
            <div><%= chooseSuccess %></div>
        </div>
    <% } %>

    <!-- Error Message -->
    <% if (chooseError) { %>
        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
            <i class="ti ti-alert-circle me-2"></i>
            <div><%= chooseError %></div>
        </div>
    <% } %>

    <!-- Password Form -->
    <form action="/auth/choose-password" method="POST" class="needs-validation" novalidate id="choosePasswordForm">
        <input type="hidden" name="csrfToken" value="<%= chooseCsrfToken %>">
        <input type="hidden" name="token" value="<%= chooseToken %>">

        <!-- New Password -->
        <div class="mb-4">
            <%- include('../../atoms/auth/password-input', {
                name: 'password',
                id: 'newPassword',
                label: 'New Password',
                placeholder: 'Create a strong password',
                required: true,
                showStrength: true,
                showRequirements: true,
                autocomplete: 'new-password',
                size: 'md'
            }) %>
        </div>

        <!-- Confirm Password -->
        <div class="mb-4">
            <label for="confirmPassword" class="form-label text-dark fw-semibold d-flex align-items-center">
                <i class="ti ti-shield-check me-2 text-primary"></i>
                Confirm Password
                <span class="text-danger ms-1">*</span>
            </label>

            <div class="input-group input-group-lg confirm-password-group">
                <span class="input-group-text bg-light-subtle border-end-0">
                    <i class="ti ti-shield-check text-muted"></i>
                </span>

                <input
                    type="password"
                    class="form-control form-control-lg border-start-0 border-end-0"
                    id="confirmPassword"
                    name="confirmPassword"
                    placeholder="Confirm your new password"
                    required
                    autocomplete="new-password"
                >

                <button class="btn btn-outline-secondary confirm-password-toggle"
                        type="button"
                        data-target="confirmPassword"
                        aria-label="Toggle confirm password visibility">
                    <i class="ti ti-eye confirm-password-toggle-icon"></i>
                </button>

                <div class="invalid-feedback">
                    Passwords must match exactly.
                </div>

                <div class="valid-feedback">
                    Passwords match! ✓
                </div>
            </div>

            <!-- Password Match Indicator -->
            <div class="password-match-status mt-2 d-none">
                <small class="password-match-message d-flex align-items-center">
                    <i class="ti ti-x text-danger me-1"></i>
                    Passwords don't match
                </small>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="security-notice mb-4">
            <div class="card border-0 bg-info-subtle">
                <div class="card-body p-3">
                    <h6 class="card-title text-info mb-2">
                        <i class="ti ti-info-circle me-1"></i>Security Tips
                    </h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-1">• Use a unique password you haven't used elsewhere</li>
                        <li class="mb-1">• Mix uppercase, lowercase, numbers, and symbols</li>
                        <li class="mb-1">• Avoid personal information like names or dates</li>
                        <li class="mb-0">• Consider using a password manager</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-success btn-lg w-100 mb-4" id="submitBtn">
            <i class="ti ti-shield-check me-2"></i>Update Password
        </button>
    </form>

    <!-- Password Strength Visualization -->
    <div class="strength-visualization d-none">
        <div class="row text-center">
            <div class="col">
                <div class="strength-indicator" data-strength="1">
                    <div class="strength-bar"></div>
                    <small>Weak</small>
                </div>
            </div>
            <div class="col">
                <div class="strength-indicator" data-strength="2">
                    <div class="strength-bar"></div>
                    <small>Fair</small>
                </div>
            </div>
            <div class="col">
                <div class="strength-indicator" data-strength="3">
                    <div class="strength-bar"></div>
                    <small>Good</small>
                </div>
            </div>
            <div class="col">
                <div class="strength-indicator" data-strength="4">
                    <div class="strength-bar"></div>
                    <small>Strong</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Login -->
    <div class="text-center mt-4">
        <p class="text-muted mb-0">
            Remember your password?
            <a href="/auth/login" class="text-primary text-decoration-none fw-semibold">
                <i class="ti ti-arrow-left me-1"></i>Back to Login
            </a>
        </p>
    </div>
</div>

<style>
    .choose-password-container {
        max-width: 480px;
        margin: 0 auto;
    }

    .reset-icon {
        background: rgba(40, 167, 69, 0.1);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        position: relative;
        overflow: hidden;
    }

    .reset-icon::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: conic-gradient(from 0deg, #28a745, #20c997, #28a745);
        border-radius: 50%;
        z-index: -1;
        animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Confirm Password Styling */
    .confirm-password-group .form-control {
        transition: all 0.3s ease;
    }

    .confirm-password-group .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .confirm-password-group .input-group-text {
        transition: all 0.3s ease;
    }

    .confirm-password-group:focus-within .input-group-text {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .confirm-password-group:focus-within .input-group-text i {
        color: #28a745 !important;
    }

    .confirm-password-toggle {
        border-left: none !important;
        background: rgba(248, 249, 250, 0.8);
        transition: all 0.3s ease;
    }

    .confirm-password-toggle:hover {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    /* Password Match Status */
    .password-match-status.show {
        display: block !important;
    }

    .password-match-message.match {
        color: #28a745;
    }

    .password-match-message.match i {
        color: #28a745;
    }

    .password-match-message.match i::before {
        content: "\ea5b"; /* ti-check icon */
    }

    /* Security Notice */
    .security-notice .card {
        border-left: 4px solid #0dcaf0;
        box-shadow: 0 2px 10px rgba(13, 202, 240, 0.1);
    }

    /* Strength Visualization */
    .strength-visualization {
        background: rgba(248, 249, 250, 0.8);
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .strength-indicator {
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .strength-bar {
        width: 100%;
        height: 6px;
        background: rgba(0,0,0,0.1);
        border-radius: 3px;
        margin-bottom: 0.5rem;
        position: relative;
        overflow: hidden;
    }

    .strength-bar::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 0%;
        border-radius: 3px;
        transition: all 0.3s ease;
    }

    .strength-indicator.active .strength-bar::after {
        width: 100%;
    }

    .strength-indicator[data-strength="1"] .strength-bar::after {
        background: #dc3545;
    }

    .strength-indicator[data-strength="2"] .strength-bar::after {
        background: #fd7e14;
    }

    .strength-indicator[data-strength="3"] .strength-bar::after {
        background: #ffc107;
    }

    .strength-indicator[data-strength="4"] .strength-bar::after {
        background: #28a745;
    }

    .strength-indicator.active {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0,0,0,0.1);
    }

    /* Form States */
    .choose-password-container.loading #submitBtn {
        position: relative;
        color: transparent;
    }

    .choose-password-container.loading #submitBtn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .choose-password-container.success .reset-icon {
        background: rgba(40, 167, 69, 0.2);
        animation: successPulse 2s ease infinite;
    }

    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Validation States */
    .form-control.is-valid {
        border-color: #28a745;
        background-image: none;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        background-image: none;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .choose-password-container {
            padding: 0 1rem;
        }

        .reset-icon {
            width: 60px;
            height: 60px;
        }

        .security-notice .card-body {
            padding: 1rem !important;
        }

        .strength-visualization {
            padding: 0.75rem;
        }
    }

    /* Accessibility and reduced motion */
    @media (prefers-reduced-motion: reduce) {
        .reset-icon::before,
        .strength-bar,
        .strength-indicator {
            animation: none !important;
            transition: none !important;
        }
    }

    /* High contrast support */
    @media (prefers-contrast: high) {
        .confirm-password-group .form-control,
        .confirm-password-toggle {
            border-width: 2px;
        }

        .security-notice .card {
            border-width: 3px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('choosePasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    const container = document.querySelector('.choose-password-container');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const confirmToggleBtn = document.querySelector('.confirm-password-toggle');
    const confirmToggleIcon = document.querySelector('.confirm-password-toggle-icon');
    const matchStatus = document.querySelector('.password-match-status');
    const matchMessage = document.querySelector('.password-match-message');

    // Password visibility toggle for confirm password
    if (confirmToggleBtn) {
        confirmToggleBtn.addEventListener('click', function() {
            const isPassword = confirmPasswordInput.type === 'password';
            confirmPasswordInput.type = isPassword ? 'text' : 'password';
            confirmToggleIcon.className = isPassword ?
                'ti ti-eye-off confirm-password-toggle-icon' :
                'ti ti-eye confirm-password-toggle-icon';
        });
    }

    // Password matching validation
    function validatePasswordMatch() {
        const password = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword.length === 0) {
            matchStatus.classList.remove('show');
            confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
            return true;
        }

        matchStatus.classList.add('show');

        if (password === confirmPassword) {
            matchMessage.className = 'password-match-message match d-flex align-items-center';
            matchMessage.innerHTML = '<i class="ti ti-check text-success me-1"></i>Passwords match!';
            confirmPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.add('is-valid');
            return true;
        } else {
            matchMessage.className = 'password-match-message d-flex align-items-center';
            matchMessage.innerHTML = '<i class="ti ti-x text-danger me-1"></i>Passwords don\'t match';
            confirmPasswordInput.classList.remove('is-valid');
            confirmPasswordInput.classList.add('is-invalid');
            return false;
        }
    }

    // Real-time password matching
    [newPasswordInput, confirmPasswordInput].forEach(input => {
        input.addEventListener('input', validatePasswordMatch);
        input.addEventListener('blur', validatePasswordMatch);
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Validate password match
        const passwordsMatch = validatePasswordMatch();

        if (form.checkValidity() && passwordsMatch) {
            submitForm();
        }

        form.classList.add('was-validated');
    });

    function submitForm() {
        // Show loading state
        container.classList.add('loading');
        submitBtn.disabled = true;

        // Simulate password update (replace with actual submission)
        setTimeout(() => {
            // Success state
            container.classList.remove('loading');
            container.classList.add('success');

            // Show success and redirect
            showSuccessMessage();

            // Track event

            // Optional analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', 'password_reset_complete');
            }

            // Redirect to login after delay
            setTimeout(() => {
                window.location.href = '/auth/login?message=password_updated';
            }, 3000);

        }, 2000);
    }

    function showSuccessMessage() {
        const alertHtml = `
            <div class="alert alert-success d-flex align-items-center mb-4 password-success-alert" role="alert">
                <i class="ti ti-circle-check me-2"></i>
                <div>
                    <strong>Password updated!</strong>
                    Redirecting to login page...
                </div>
            </div>
        `;

        form.insertAdjacentHTML('beforebegin', alertHtml);
    }

    // Password strength visualization
    function updateStrengthVisualization(strength) {
        const visualization = document.querySelector('.strength-visualization');
        if (!visualization) return;

        visualization.classList.remove('d-none');

        const indicators = visualization.querySelectorAll('.strength-indicator');
        indicators.forEach((indicator, index) => {
            if (index < strength) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        });
    }

    // Listen for password strength changes from the password input atom
    if (newPasswordInput) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    // React to strength changes
                    const strengthBar = document.querySelector('.password-strength-bar');
                    if (strengthBar) {
                        const classList = strengthBar.classList;
                        let strength = 0;
                        if (classList.contains('strong')) strength = 4;
                        else if (classList.contains('good')) strength = 3;
                        else if (classList.contains('fair')) strength = 2;
                        else if (classList.contains('weak')) strength = 1;

                        updateStrengthVisualization(strength);
                    }
                }
            });
        });

        // Start observing
        const strengthBar = document.querySelector('.password-strength-bar');
        if (strengthBar) {
            observer.observe(strengthBar, { attributes: true });
        }
    }

    // Auto-focus first input
    if (newPasswordInput) {
        newPasswordInput.focus();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });

});
</script>