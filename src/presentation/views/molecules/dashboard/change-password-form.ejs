<%
/**
 * Change Password Form Molecule
 * Secure form for users to change their password
 * Created by Denisse Maldonado
 */
%>

<!-- Change Password Form -->
<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-4">Change Password</h5>
    <p class="text-muted mb-4">Please enter your current password and choose a new password.</p>
    
    <!-- Error/Success Messages -->
    <div id="message-container" class="d-none mb-3">
      <div id="message-alert" class="alert" role="alert">
        <span id="message-text"></span>
      </div>
    </div>
    
    <form id="change-password-form" novalidate>
      <div class="row">
        <!-- Current Password -->
        <div class="col-12 mb-3">
          <label for="currentPassword" class="form-label">
            Current Password <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            <input 
              type="password" 
              class="form-control" 
              id="currentPassword" 
              name="currentPassword" 
              required 
              autocomplete="current-password">
            <button class="btn btn-outline-secondary" type="button" data-toggle-field="currentPassword">
              <i class="ti ti-eye" id="currentPassword-icon"></i>
            </button>
          </div>
          <div class="invalid-feedback">
            Please enter your current password.
          </div>
        </div>
        
        <!-- New Password -->
        <div class="col-12 mb-3">
          <label for="newPassword" class="form-label">
            New Password <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            <input 
              type="password" 
              class="form-control" 
              id="newPassword" 
              name="newPassword" 
              required 
              minlength="8"
              autocomplete="new-password">
            <button class="btn btn-outline-secondary" type="button" data-toggle-field="newPassword">
              <i class="ti ti-eye" id="newPassword-icon"></i>
            </button>
          </div>
          <div class="form-text">
            Password must be at least 8 characters long and contain uppercase, lowercase, number, and special character.
          </div>
          <div class="invalid-feedback">
            Please enter a valid new password.
          </div>
        </div>
        
        <!-- Confirm New Password -->
        <div class="col-12 mb-4">
          <label for="confirmPassword" class="form-label">
            Confirm New Password <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            <input 
              type="password" 
              class="form-control" 
              id="confirmPassword" 
              name="confirmPassword" 
              required 
              autocomplete="new-password">
            <button class="btn btn-outline-secondary" type="button" data-toggle-field="confirmPassword">
              <i class="ti ti-eye" id="confirmPassword-icon"></i>
            </button>
          </div>
          <div class="invalid-feedback">
            Please confirm your new password.
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary" id="submit-btn">
          <i class="ti ti-lock me-1"></i>
          Change Password
        </button>
        <button type="button" class="btn btn-secondary" id="cancel-btn">
          <i class="ti ti-arrow-left me-1"></i>
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript -->
<script>
// CSRF token (this should be provided by the server)
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

// Password visibility toggle
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + '-icon');
  
  if (field.type === 'password') {
    field.type = 'text';
    icon.className = 'ti ti-eye-off';
  } else {
    field.type = 'password';
    icon.className = 'ti ti-eye';
  }
}

// Show message
function showMessage(text, type = 'info') {
  const container = document.getElementById('message-container');
  const alert = document.getElementById('message-alert');
  const messageText = document.getElementById('message-text');
  
  // Set alert type
  alert.className = `alert alert-${type}`;
  messageText.textContent = text;
  container.className = 'd-block mb-3';
  
  // Auto-hide after 5 seconds for success messages
  if (type === 'success') {
    setTimeout(() => {
      container.className = 'd-none mb-3';
    }, 5000);
  }
}

// Password strength validation
function validatePassword(password) {
  const minLength = password.length >= 8;
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /\d/.test(password);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  return {
    isValid: minLength && hasUpper && hasLower && hasNumber && hasSpecial,
    issues: {
      minLength,
      hasUpper,
      hasLower,
      hasNumber,
      hasSpecial
    }
  };
}

// Form submission handler
document.getElementById('change-password-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submit-btn');
  const form = this;
  
  // Get form data
  const formData = new FormData(form);
  const currentPassword = formData.get('currentPassword');
  const newPassword = formData.get('newPassword');
  const confirmPassword = formData.get('confirmPassword');
  
  // Reset validation states
  form.classList.remove('was-validated');
  document.getElementById('message-container').className = 'd-none mb-3';
  
  // Basic validation
  if (!currentPassword || !newPassword || !confirmPassword) {
    showMessage('Please fill in all required fields.', 'danger');
    form.classList.add('was-validated');
    return;
  }
  
  // Password confirmation check
  if (newPassword !== confirmPassword) {
    showMessage('New passwords do not match.', 'danger');
    document.getElementById('confirmPassword').setCustomValidity('Passwords do not match');
    form.classList.add('was-validated');
    return;
  } else {
    document.getElementById('confirmPassword').setCustomValidity('');
  }
  
  // Password strength validation
  const passwordValidation = validatePassword(newPassword);
  if (!passwordValidation.isValid) {
    let issues = [];
    if (!passwordValidation.issues.minLength) issues.push('at least 8 characters');
    if (!passwordValidation.issues.hasUpper) issues.push('uppercase letter');
    if (!passwordValidation.issues.hasLower) issues.push('lowercase letter');
    if (!passwordValidation.issues.hasNumber) issues.push('number');
    if (!passwordValidation.issues.hasSpecial) issues.push('special character');
    
    showMessage(`Password must contain: ${issues.join(', ')}.`, 'danger');
    document.getElementById('newPassword').setCustomValidity('Password does not meet requirements');
    form.classList.add('was-validated');
    return;
  } else {
    document.getElementById('newPassword').setCustomValidity('');
  }
  
  // Same password check
  if (currentPassword === newPassword) {
    showMessage('New password must be different from current password.', 'danger');
    document.getElementById('newPassword').setCustomValidity('New password must be different');
    form.classList.add('was-validated');
    return;
  }
  
  // Disable submit button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Changing Password...';
  
  try {
    // Submit to API
    const response = await fetch('/auth/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(csrfToken && { 'x-csrf-token': csrfToken })
      },
      credentials: 'include',
      body: JSON.stringify({
        currentPassword,
        newPassword,
        confirmPassword
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      showMessage('Password changed successfully!', 'success');
      form.reset();
      
      // Redirect to profile after 2 seconds
      setTimeout(() => {
        window.location.href = window.location.pathname.replace('/change-password', '/profile');
      }, 2000);
    } else {
      throw new Error(result.error || 'Failed to change password');
    }
    
  } catch (error) {
    console.error('Change password error:', error);
    showMessage(error.message || 'An error occurred while changing password. Please try again.', 'danger');
  } finally {
    // Re-enable submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="ti ti-lock me-1"></i>Change Password';
  }
});

// Real-time password validation feedback
document.getElementById('newPassword').addEventListener('input', function() {
  const password = this.value;
  if (password.length > 0) {
    const validation = validatePassword(password);
    if (validation.isValid) {
      this.setCustomValidity('');
      this.classList.remove('is-invalid');
      this.classList.add('is-valid');
    } else {
      this.setCustomValidity('Password does not meet requirements');
      this.classList.remove('is-valid');
      this.classList.add('is-invalid');
    }
  } else {
    this.setCustomValidity('');
    this.classList.remove('is-valid', 'is-invalid');
  }
});

// Real-time confirmation validation
document.getElementById('confirmPassword').addEventListener('input', function() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = this.value;
  
  if (confirmPassword.length > 0) {
    if (newPassword === confirmPassword) {
      this.setCustomValidity('');
      this.classList.remove('is-invalid');
      this.classList.add('is-valid');
    } else {
      this.setCustomValidity('Passwords do not match');
      this.classList.remove('is-valid');
      this.classList.add('is-invalid');
    }
  } else {
    this.setCustomValidity('');
    this.classList.remove('is-valid', 'is-invalid');
  }
});

// Add event listeners for password toggle buttons
document.querySelectorAll('[data-toggle-field]').forEach(button => {
  button.addEventListener('click', function() {
    const fieldId = this.getAttribute('data-toggle-field');
    togglePassword(fieldId);
  });
});

// Add event listener for cancel button
document.getElementById('cancel-btn').addEventListener('click', function() {
  history.back();
});
</script>