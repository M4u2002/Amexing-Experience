<!-- Admin Dashboard - Driver Management -->
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-sm-flex d-block align-items-center justify-content-between mb-3">
                    <div class="mb-3 mb-sm-0">
                        <h5 class="card-title fw-semibold">Driver Management</h5>
                        <p class="card-subtitle mb-0">Manage drivers, applications, and fleet assignments</p>
                    </div>
                    <div>
                        <span class="badge bg-light-warning text-warning fs-2">
                            Admin View
                        </span>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row">
                    <div class="col-md-3">
                        <%- include('../../atoms/dashboard/stats-card', {
                            icon: 'ti ti-car',
                            title: 'Total Drivers',
                            value: typeof stats !== 'undefined' ? stats.totalDrivers : '156',
                            color: 'primary',
                            trend: '+8 this month',
                            trendColor: 'success'
                        }) %>
                    </div>
                    <div class="col-md-3">
                        <%- include('../../atoms/dashboard/stats-card', {
                            icon: 'ti ti-user-check',
                            title: 'Active Drivers',
                            value: typeof stats !== 'undefined' ? stats.activeDrivers : '142',
                            color: 'success',
                            trend: '91% availability',
                            trendColor: 'success'
                        }) %>
                    </div>
                    <div class="col-md-3">
                        <%- include('../../atoms/dashboard/stats-card', {
                            icon: 'ti ti-clock',
                            title: 'Pending Applications',
                            value: typeof stats !== 'undefined' ? stats.pendingApplications : '23',
                            color: 'warning',
                            trend: 'Needs review',
                            trendColor: 'warning'
                        }) %>
                    </div>
                    <div class="col-md-3">
                        <%- include('../../atoms/dashboard/stats-card', {
                            icon: 'ti ti-calendar-stats',
                            title: 'Monthly Trips',
                            value: typeof stats !== 'undefined' ? stats.monthlyTrips : '2,847',
                            color: 'info',
                            trend: '+15% vs last month',
                            trendColor: 'success'
                        }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Driver Management -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Navigation Tabs -->
                <ul class="nav nav-pills mb-3" id="driverTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-drivers-tab" data-bs-toggle="pill" data-bs-target="#active-drivers" type="button" role="tab">
                            <i class="ti ti-car me-2"></i>Active Drivers
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-applications-tab" data-bs-toggle="pill" data-bs-target="#pending-applications" type="button" role="tab">
                            <i class="ti ti-clock me-2"></i>Pending Applications
                            <span class="badge bg-warning ms-1">3</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="driver-performance-tab" data-bs-toggle="pill" data-bs-target="#driver-performance" type="button" role="tab">
                            <i class="ti ti-chart-line me-2"></i>Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inactive-drivers-tab" data-bs-toggle="pill" data-bs-target="#inactive-drivers" type="button" role="tab">
                            <i class="ti ti-user-off me-2"></i>Inactive
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="driverTabsContent">
                    <!-- Active Drivers Tab -->
                    <div class="tab-pane fade show active" id="active-drivers" role="tabpanel">
                        <div id="driverTableContainer"></div>
                    </div>

                    <!-- Pending Applications Tab -->
                    <div class="tab-pane fade" id="pending-applications" role="tabpanel">
                        <div id="pendingDriverTableContainer"></div>
                    </div>

                    <!-- Driver Performance Tab -->
                    <div class="tab-pane fade" id="driver-performance" role="tabpanel">
                        <div id="performanceDriverTableContainer"></div>
                    </div>

                    <!-- Inactive Drivers Tab -->
                    <div class="tab-pane fade" id="inactive-drivers" role="tabpanel">
                        <div id="inactiveDriverTableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include CSS -->
<link rel="stylesheet" href="/css/components/user-management.css">

<!-- JavaScript -->
<script src="/js/components/UserTableManager.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current user context
    const currentUser = {
        id: '<%= user.id %>',
        role: '<%= user.role %>',
        email: '<%= user.email %>'
    };

    // Initialize Active Drivers Table
    window.driverTable = new UserTableManager('driverTableContainer', {
        userRole: 'driver',
        userId: currentUser.id,
        currentUserRole: currentUser.role,
        pageSize: 25,
        apiBaseUrl: '/api',
        permissions: {
            canCreateUsers: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canModifyUsers: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canDeactivateUsers: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canViewAll: <%= ['superadmin', 'admin'].includes(user.role) %>
        },
        filters: {
            role: 'driver',
            active: true,
            approved: true
        },
        customizations: {
            title: 'Active Drivers',
            showBulkActions: true,
            showExport: true,
            showFilters: true,
            extraColumns: ['licenseNumber', 'vehicleAssigned', 'lastActiveDate']
        }
    });

    // Initialize Pending Applications Table
    window.pendingDriverTable = new UserTableManager('pendingDriverTableContainer', {
        userRole: 'driver',
        userId: currentUser.id,
        currentUserRole: currentUser.role,
        pageSize: 25,
        apiBaseUrl: '/api',
        permissions: {
            canCreateUsers: false,
            canModifyUsers: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canDeactivateUsers: false,
            canViewAll: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canApproveApplications: <%= ['superadmin', 'admin'].includes(user.role) %>
        },
        filters: {
            role: 'driver',
            active: true,
            approved: false
        },
        customizations: {
            title: 'Pending Driver Applications',
            showBulkActions: true,
            showExport: false,
            showFilters: false,
            showApprovalButtons: true,
            highlightPending: true
        }
    });

    // Initialize Performance Drivers Table
    window.performanceDriverTable = new UserTableManager('performanceDriverTableContainer', {
        userRole: 'driver',
        userId: currentUser.id,
        currentUserRole: currentUser.role,
        pageSize: 25,
        apiBaseUrl: '/api',
        permissions: {
            canCreateUsers: false,
            canModifyUsers: false,
            canDeactivateUsers: false,
            canViewAll: <%= ['superadmin', 'admin'].includes(user.role) %>
        },
        filters: {
            role: 'driver',
            active: true,
            approved: true,
            sortBy: 'performance'
        },
        customizations: {
            title: 'Driver Performance Metrics',
            showBulkActions: false,
            showExport: true,
            showFilters: true,
            extraColumns: ['totalTrips', 'rating', 'completionRate', 'earnings'],
            readonly: true
        }
    });

    // Initialize Inactive Drivers Table
    window.inactiveDriverTable = new UserTableManager('inactiveDriverTableContainer', {
        userRole: 'driver',
        userId: currentUser.id,
        currentUserRole: currentUser.role,
        pageSize: 25,
        apiBaseUrl: '/api',
        permissions: {
            canCreateUsers: false,
            canModifyUsers: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canDeactivateUsers: false,
            canViewAll: <%= ['superadmin', 'admin'].includes(user.role) %>,
            canReactivateUsers: <%= ['superadmin', 'admin'].includes(user.role) %>
        },
        filters: {
            role: 'driver',
            active: false
        },
        customizations: {
            title: 'Inactive Drivers',
            showBulkActions: true,
            showExport: true,
            showFilters: true,
            showReactivateButton: true,
            extraColumns: ['deactivationReason', 'deactivationDate']
        }
    });

    // Tab switching logic
    const tabs = document.querySelectorAll('[data-bs-toggle="pill"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetTab = event.target.getAttribute('data-bs-target');

            // Refresh the appropriate table when tab is shown
            switch(targetTab) {
                case '#active-drivers':
                    window.driverTable.refresh();
                    break;
                case '#pending-applications':
                    window.pendingDriverTable.refresh();
                    break;
                case '#driver-performance':
                    window.performanceDriverTable.refresh();
                    break;
                case '#inactive-drivers':
                    window.inactiveDriverTable.refresh();
                    break;
            }
        });
    });

    // Auto-refresh pending applications every 30 seconds
    setInterval(() => {
        if (document.querySelector('#pending-applications-tab').classList.contains('active')) {
            window.pendingDriverTable.refresh();
        }
    }, 30000);

    // Load initial data
    window.driverTable.loadUsers();
});
</script>