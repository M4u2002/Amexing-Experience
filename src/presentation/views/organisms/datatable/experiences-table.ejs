<%
/**
 * Experiences DataTable Organism
 * DataTable component for experiences management
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'experiences-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/experiences';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
const canViewImages = ['superadmin', 'admin', 'department_manager'].includes(dtUserRole);
%>

<style>
/* Enhanced TomSelect Dropdown Styles */
.tomselect-option-enhanced {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}

.tomselect-option-enhanced:last-child {
    border-bottom: none;
}

.tomselect-option-enhanced .option-main {
    margin-bottom: 4px;
}

.tomselect-option-enhanced .option-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.tomselect-item-enhanced {
    display: flex;
    align-items: center;
    gap: 4px;
}

.tomselect-item-enhanced .item-name {
    font-weight: 500;
}

.no-results {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}

.no-results i {
    font-size: 2rem;
    margin-bottom: 8px;
    display: block;
    opacity: 0.5;
}

/* Enhanced validation styles */
.form-control.is-valid:focus,
.form-control.is-invalid:focus {
    box-shadow: none;
}

.form-control.is-valid {
    border-color: #28a745;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

/* TomSelect improvements */
.ts-dropdown .option {
    padding: 0;
}

.ts-dropdown .option.active {
    background-color: #f8f9fa !important;
}

.ts-dropdown .option:hover {
    background-color: #e9ecef !important;
}

/* Better visual hierarchy for badges */
.tomselect-option-enhanced .badge {
    font-size: 0.65rem;
    padding: 2px 6px;
}
</style>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    <i class="ti ti-star me-2"></i>Experiencias
                </h5>
                <small class="text-white" style="opacity: 0.9;">Gestión completa del catálogo de experiencias</small>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" id="createExperienceBtn">
                        <i class="ti ti-plus me-1"></i>Nueva Experiencia
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body" id="experiences-content">
        <!-- Filter Controls -->
        <div class="d-flex justify-content-end align-items-center mb-3">
            <!-- Trailing Dropdowns -->
            <div class="d-flex gap-2 align-items-center">
                <!-- Currency Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="currencyFilter-<%= dtTableId %>" class="form-label mb-0 text-muted">Moneda:</label>
                    <select class="form-select" id="currencyFilter-<%= dtTableId %>" style="min-width: 100px;">
                        <option value="MXN" selected>MXN</option>
                        <option value="USD">USD</option>
                    </select>
                </div>

                <!-- Payment Type Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="paymentTypeFilter-<%= dtTableId %>" class="form-label mb-0 text-muted">Pago:</label>
                    <select class="form-select" id="paymentTypeFilter-<%= dtTableId %>" style="min-width: 140px;">
                        <option value="efectivo" selected>Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="transf_agencias">Transf. Agencias</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <% if (dtUserRole !== 'department_manager') { %><th>Contenido</th><% } %>
                        <th>Duración</th>
                        <th>Mín. Personas</th>
                        <th>Precio</th>
                        <% if (dtUserRole !== 'department_manager') { %><th>Última Act.</th><% } %>
                        <% if (dtUserRole !== 'department_manager') { %><th>Estado</th><% } %>
                        <% if (dtShowActions || canViewImages) { %>
                            <th class="text-center">Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<%- include('../modal/experience-images-modal.ejs') %>

<!-- Experience Modal -->
<div class="modal fade" id="experienceModal" tabindex="-1" aria-labelledby="experienceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="experienceModalLabel">
                    <i class="ti ti-star-plus me-2"></i><span id="modalTitle">Crear Nueva Experiencia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Alert container for modal-specific errors -->
                <div id="experienceModalAlerts"></div>

                <form id="experienceForm">
                    <input type="hidden" id="experienceId">
                    <input type="hidden" id="type" value="Experience">

                    <!-- Sección: Información Básica -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-info-circle me-1"></i>
                            Información Básica
                        </h6>

                        <div class="mb-3">
                            <label for="name" class="form-label">Nombre de la Experiencia <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required maxlength="200" placeholder="Ej: Tour Gastronómico en el Centro Histórico">
                            <div class="invalid-feedback" id="name-error"></div>
                            <div class="form-text">Nombre descriptivo de la experiencia</div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description" required rows="4" maxlength="1000" placeholder="Describe la experiencia en detalle..."></textarea>
                            <div class="invalid-feedback" id="description-error"></div>
                            <div class="form-text">Descripción completa de la experiencia</div>
                        </div>
                    </div>

                    <!-- Sección: Detalles de la Experiencia -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-settings me-1"></i>
                            Detalles de la Experiencia
                        </h6>

                        <%- include('../../atoms/common/tom-select', {
                            id: 'experiences',
                            name: 'experiences',
                            multiple: true,
                            placeholder: 'Buscar y seleccionar otras experiencias...',
                            maxItems: 20,
                            label: 'Otras Experiencias Incluidas (Opcional)',
                            helpText: 'Selecciona otras experiencias que forman parte de este paquete (máximo 20).',
                            options: [],
                            selected: []
                        }) %>

                        <%- include('../../atoms/common/tom-select', {
                            id: 'provider-experiences',
                            name: 'providerExperiences',
                            multiple: true,
                            placeholder: 'Buscar y seleccionar experiencias de proveedores...',
                            maxItems: 20,
                            label: 'Experiencias de Proveedores Incluidas (Opcional)',
                            helpText: 'Selecciona las experiencias específicas de proveedores que forman parte de este paquete (máximo 20).',
                            options: [],
                            selected: []
                        }) %>

                        <%- include('../../atoms/common/tom-select', {
                            id: 'tours',
                            name: 'tours',
                            multiple: true,
                            placeholder: 'Buscar y seleccionar tours...',
                            maxItems: 20,
                            label: 'Tours Incluidos (Opcional)',
                            helpText: 'Selecciona los tours que forman parte de este paquete (máximo 20).',
                            options: [],
                            selected: []
                        }) %>

                        <!-- Tabla de Costo Sugerido (inicialmente oculta) -->
                        <div id="suggestedCostContainer" style="display: none;" class="mb-3">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10 py-2">
                                    <h6 class="mb-0 text-info">
                                        <i class="ti ti-calculator me-2"></i>Costo Sugerido (Informativo)
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0" id="suggestedCostTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Experiencia/Proveedor</th>
                                                    <th class="text-end" style="width: 150px;">Costo</th>
                                                </tr>
                                            </thead>
                                            <tbody id="suggestedCostBody">
                                                <!-- Filas dinámicas generadas por JavaScript -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <th>Total Sugerido</th>
                                                    <th class="text-end">
                                                        <span id="suggestedTotal" class="fw-bold text-primary">$0.00 MXN</span>
                                                    </th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer bg-light py-2">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle me-1"></i>
                                        Este es un cálculo sugerido basado en los costos individuales.
                                        Puedes establecer el precio final en el campo "Costo" siguiente.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Costo -->
                        <div class="mb-3">
                            <label for="cost" class="form-label">Costo <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="cost" name="cost" required min="0" step="0.01" placeholder="0.00">
                                <span class="input-group-text">MXN</span>
                            </div>
                            <div class="invalid-feedback" id="cost-error"></div>
                            <div class="form-text">Costo de la experiencia en pesos mexicanos</div>
                        </div>

                        <!-- Campos Opcionales - Layout Compacto -->
                        <div class="row">
                            <!-- Duración -->
                            <div class="col-md-6 mb-3">
                                <label for="duration" class="form-label">Duración</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="duration" name="duration" min="0" step="0.5" placeholder="2.5">
                                    <span class="input-group-text">horas</span>
                                </div>
                                <div class="form-text">Duración estimada (opcional)</div>
                            </div>

                            <!-- Mínimo personas -->
                            <div class="col-md-6 mb-3">
                                <label for="min_people" class="form-label">Mínimo personas</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="min_people" name="min_people" min="1" step="1" placeholder="4">
                                    <span class="input-group-text">personas</span>
                                </div>
                                <div class="form-text">Número mínimo requerido (opcional)</div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Tiempo traslado -->
                            <div class="col-md-6 mb-3">
                                <label for="time_journey" class="form-label">Tiempo traslado</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="time_journey" name="time_journey" min="0" step="0.1" placeholder="2.5">
                                    <span class="input-group-text">horas</span>
                                </div>
                                <div class="form-text">Tiempo de traslado (opcional)</div>
                            </div>

                            <!-- Tipo de Vehículo -->
                            <div class="col-md-6 mb-3">
                                <label for="vehicleType" class="form-label">Tipo de Vehículo</label>
                                <select class="form-select" id="vehicleType" name="vehicleType">
                                    <option value="">Sin tipo específico</option>
                                </select>
                                <div class="form-text">Vehículo requerido (opcional)</div>
                            </div>
                        </div>


                        <!-- Sección: Disponibilidad (Opcional) -->
                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                <i class="ti ti-calendar-time me-1"></i>
                                Disponibilidad <span class="text-muted fw-normal">(Opcional)</span>
                            </h6>

                            <div class="mb-3">
                                <label class="form-label">Selecciona Días y Configura Horarios</label>
                                <div class="d-flex gap-2 flex-wrap mb-3" id="experienceAvailableDaysContainer">
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="1" data-day-name="Lunes">
                                        <i class="ti ti-calendar"></i> Lu
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="2" data-day-name="Martes">
                                        <i class="ti ti-calendar"></i> Ma
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="3" data-day-name="Miércoles">
                                        <i class="ti ti-calendar"></i> Mi
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="4" data-day-name="Jueves">
                                        <i class="ti ti-calendar"></i> Ju
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="5" data-day-name="Viernes">
                                        <i class="ti ti-calendar"></i> Vi
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="6" data-day-name="Sábado">
                                        <i class="ti ti-calendar"></i> Sa
                                    </button>
                                    <button type="button" class="btn btn-outline-primary day-btn" data-day="0" data-day-name="Domingo">
                                        <i class="ti ti-calendar"></i> Do
                                    </button>
                                </div>
                                <div class="form-text">Selecciona días para configurar horarios individuales</div>
                            </div>

                            <!-- Contenedor de horarios por día -->
                            <div id="experienceDaySchedulesContainer" class="mb-3">
                                <div id="experienceNoDaysSelected" class="text-center text-muted py-4 border rounded bg-light">
                                    <i class="ti ti-calendar-off fs-3 d-block mb-2"></i>
                                    <p class="mb-0">Selecciona días para configurar sus horarios</p>
                                    <small class="text-muted">Cada día puede tener horarios diferentes</small>
                                </div>
                            </div>

                            <!-- Disponibilidad Sugerida de Proveedores (inicialmente oculto) -->
                            <div id="suggestedAvailabilityContainer" style="display: none;" class="mb-3">
                                <div class="alert alert-success border-0" role="alert">
                                    <h6 class="alert-heading text-success mb-2">
                                        <i class="ti ti-info-circle me-2"></i>Disponibilidad de Proveedores Seleccionados
                                    </h6>
                                    <div id="suggestedAvailabilityContent">
                                        <div class="text-center text-muted py-2">
                                            <i class="ti ti-calendar-off fs-5 d-block mb-1"></i>
                                            <small>Selecciona experiencias de proveedores para ver su disponibilidad</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info" role="alert">
                                <i class="ti ti-info-circle me-2"></i>
                                <small>Si no se especifica disponibilidad, la experiencia estará disponible todos los días sin restricción de horario</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveExperienceBtn">
                    <i class="ti ti-check me-1"></i><span id="saveButtonText">Crear Experiencia</span>
                </button>
            </div>

            <%- include('../../atoms/common/modal-loader', { text: 'Cargando datos de la experiencia...' }) %>
        </div>
    </div>
</div>

<!-- Template para fila de horario por día -->
<template id="experienceDayScheduleRowTemplate">
    <div class="day-schedule-row mb-3 p-3 border rounded bg-light" data-day="">
        <div class="row align-items-center">
            <div class="col-md-3">
                <strong class="day-name text-primary">
                    <i class="ti ti-calendar me-1"></i>
                    <span></span>
                </strong>
            </div>
            <div class="col-md-4">
                <label class="form-label small mb-1">Hora de Inicio</label>
                <input type="text" class="form-control form-control-sm day-start-time time-input" placeholder="HH:MM" maxlength="5">
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label small mb-1">Hora de Fin</label>
                <input type="text" class="form-control form-control-sm day-end-time time-input" placeholder="HH:MM" maxlength="5">
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-day-btn" title="Eliminar día">
                    <i class="ti ti-x"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<script>
(function() {
    function initWhenReady() {
        if (typeof jQuery === 'undefined') {
            setTimeout(initWhenReady, 100);
            return;
        }
        if (!jQuery.fn.dataTable) {
            setTimeout(initWhenReady, 100);
            return;
        }
        initExperiencesTable();
    }

    function initExperiencesTable() {
        const tableId = '<%= dtTableId %>';
        const apiEndpoint = '<%= dtApiEndpoint %>';
        const showActions = <%= dtShowActions %>;
        const canEdit = <%= canEdit %>;
        const canDelete = <%= canDelete %>;
        const canViewImages = <%= canViewImages %>;
        const userRole = '<%= dtUserRole %>';

        // Variables globales para almacenar datos con costos
        let experiencesDataMap = {};
        let providerExperiencesDataMap = {};
        let toursDataMap = {};

        /**
         * Format money amount with thousands separator and 2 decimals
         * @param {number} amount - Amount to format
         * @returns {string} Formatted money string
         */
        function formatMoney(amount) {
            return parseFloat(amount || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        /**
         * Update suggested cost table based on selected experiences, provider experiences, and tours
         */
        function updateSuggestedCostTable() {
            const experiencesSelectElement = document.getElementById('experiences');
            const providerExperiencesSelectElement = document.getElementById('provider-experiences');
            const toursSelectElement = document.getElementById('tours');
            const experiencesTomSelect = experiencesSelectElement?.tomselect;
            const providerExperiencesTomSelect = providerExperiencesSelectElement?.tomselect;
            const toursTomSelect = toursSelectElement?.tomselect;
            const selectedExperienceIds = experiencesTomSelect?.getValue() || [];
            const selectedProviderExperienceIds = providerExperiencesTomSelect?.getValue() || [];
            const selectedTourIds = toursTomSelect?.getValue() || [];

            const container = $('#suggestedCostContainer');
            const tbody = $('#suggestedCostBody');

            if (selectedExperienceIds.length === 0 && selectedProviderExperienceIds.length === 0 && selectedTourIds.length === 0) {
                // No selections, hide table
                container.hide();
                return;
            }

            // Clear tbody
            tbody.empty();

            let total = 0;

            // Generate rows for each selected experience
            selectedExperienceIds.forEach(function(id) {
                const item = experiencesDataMap[id];
                if (item) {
                    const cost = parseFloat(item.cost || 0);
                    total += cost;

                    const row = `
                        <tr>
                            <td>${item.name} <span class="badge bg-primary badge-sm">Experiencia</span></td>
                            <td class="text-end">$${formatMoney(cost)} MXN</td>
                        </tr>
                    `;
                    tbody.append(row);
                }
            });

            // Generate rows for each selected provider experience
            selectedProviderExperienceIds.forEach(function(id) {
                const item = providerExperiencesDataMap[id];
                if (item) {
                    const cost = parseFloat(item.price || 0);
                    total += cost;

                    const providerName = item.provider ? item.provider.name : 'Sin proveedor';
                    const row = `
                        <tr>
                            <td>${item.name} <span class="badge bg-warning badge-sm">Proveedor</span> <small class="text-muted">(${providerName})</small></td>
                            <td class="text-end">$${formatMoney(cost)} MXN</td>
                        </tr>
                    `;
                    tbody.append(row);
                }
            });

            // Generate rows for each selected tour
            selectedTourIds.forEach(function(id) {
                const item = toursDataMap[id];
                if (item) {
                    const cost = parseFloat(item.price || 0);
                    total += cost;

                    const row = `
                        <tr>
                            <td>${item.name} <span class="badge bg-success badge-sm">Tour</span></td>
                            <td class="text-end">$${formatMoney(cost)} MXN</td>
                        </tr>
                    `;
                    tbody.append(row);
                }
            });

            // Update total
            $('#suggestedTotal').text(`$${formatMoney(total)} MXN`);

            // Show table
            container.show();
        }

        /**
         * Update suggested availability display based on selected experiences and provider experiences
         */
        function updateSuggestedAvailabilityDisplay() {
            const container = $('#suggestedAvailabilityContainer');
            const content = $('#suggestedAvailabilityContent');
            
            // Get selected experiences (regular)
            const experiencesSelectElement = document.getElementById('experiences');
            const experiencesTomSelectInstance = experiencesSelectElement?.tomselect;
            const selectedExperiences = experiencesTomSelectInstance ? experiencesTomSelectInstance.getValue() : [];

            // Get selected provider experiences
            const providerExperiencesSelectElement = document.getElementById('provider-experiences');
            const providerExperiencesTomSelectInstance = providerExperiencesSelectElement?.tomselect;
            const selectedProviderExperiences = providerExperiencesTomSelectInstance ? providerExperiencesTomSelectInstance.getValue() : [];
            
            // If no selections from either dropdown, hide container
            if ((!selectedExperiences || selectedExperiences.length === 0) && 
                (!selectedProviderExperiences || selectedProviderExperiences.length === 0)) {
                container.hide();
                return;
            }

            // Build availability display
            let availabilityHtml = '';
            let hasAnyAvailability = false;

            // Process regular experiences
            selectedExperiences.forEach(function(experienceId) {
                const experienceData = experiencesDataMap[experienceId];
                if (experienceData) {
                    const experienceName = experienceData.name;
                    const availability = experienceData.availability;

                    availabilityHtml += `
                        <div class="border rounded p-2 mb-2 bg-light">
                            <div class="d-flex align-items-center mb-1">
                                <i class="ti ti-package text-primary me-1"></i>
                                <strong class="text-primary">${experienceName}</strong>
                                <small class="text-muted ms-2">(Experiencia)</small>
                            </div>
                    `;

                    if (availability && Array.isArray(availability) && availability.length > 0) {
                        hasAnyAvailability = true;
                        availabilityHtml += renderAvailabilitySchedules(availability);
                    } else {
                        availabilityHtml += '<small class="text-success"><i class="ti ti-check-circle me-1"></i>Disponible todos los días</small>';
                    }

                    availabilityHtml += '</div>';
                }
            });

            // Process provider experiences
            selectedProviderExperiences.forEach(function(providerExperienceId) {
                const providerExperienceData = providerExperiencesDataMap[providerExperienceId];
                if (providerExperienceData) {
                    const providerName = providerExperienceData.provider ? providerExperienceData.provider.name : 'Sin proveedor';
                    const experienceName = providerExperienceData.name;
                    const availability = providerExperienceData.availability;

                    availabilityHtml += `
                        <div class="border rounded p-2 mb-2 bg-light">
                            <div class="d-flex align-items-center mb-1">
                                <i class="ti ti-star text-primary me-1"></i>
                                <strong class="text-primary">${experienceName}</strong>
                                <small class="text-muted ms-2">(${providerName})</small>
                            </div>
                    `;

                    if (availability && Array.isArray(availability) && availability.length > 0) {
                        hasAnyAvailability = true;
                        availabilityHtml += renderAvailabilitySchedules(availability);
                    } else {
                        availabilityHtml += '<small class="text-success"><i class="ti ti-check-circle me-1"></i>Disponible todos los días</small>';
                    }

                    availabilityHtml += '</div>';
                }
            });

            // If no availability info found, show message
            if (!hasAnyAvailability) {
                availabilityHtml = `
                    <div class="text-center text-success py-2">
                        <i class="ti ti-check-circle fs-5 d-block mb-1"></i>
                        <small>Las experiencias están disponibles todos los días</small>
                    </div>
                `;
            }

            // Update content and show container
            content.html(availabilityHtml);
            container.show();
        }

        /**
         * Helper function to render availability schedules
         */
        function renderAvailabilitySchedules(availability) {
            const dayNames = {
                0: 'Domingo',
                1: 'Lunes', 
                2: 'Martes',
                3: 'Miércoles',
                4: 'Jueves',
                5: 'Viernes',
                6: 'Sábado'
            };

            let scheduleHtml = '';
            availability.forEach(function(daySchedule) {
                const dayName = dayNames[daySchedule.day] || `Día ${daySchedule.day}`;
                scheduleHtml += `
                    <div class="d-flex align-items-center mb-1">
                        <small class="text-success fw-bold me-2" style="min-width: 70px;">${dayName}:</small>
                `;
                
                if (daySchedule.times && Array.isArray(daySchedule.times) && daySchedule.times.length > 0) {
                    const timeRanges = daySchedule.times.map(function(timeSlot) {
                        return `${timeSlot.start}-${timeSlot.end}`;
                    }).join(', ');
                    scheduleHtml += `<small>${timeRanges}</small>`;
                } else {
                    scheduleHtml += '<small class="text-muted">Sin horarios específicos</small>';
                }
                
                scheduleHtml += '</div>';
            });

            return scheduleHtml;
        }

        /**
         * Initialize suggested cost calculator by binding to Tom Select change event
         */
        let calculatorInitialized = false;
        function initializeSuggestedCostCalculator() {
            // Prevent multiple initializations
            if (calculatorInitialized) {
                return;
            }

            const experiencesSelectElement = document.getElementById('experiences');
            const experiencesTomSelectInstance = experiencesSelectElement?.tomselect;
            
            const toursSelectElement = document.getElementById('tours');
            const toursTomSelectInstance = toursSelectElement?.tomselect;

            if (experiencesTomSelectInstance) {
                experiencesTomSelectInstance.on('change', function() {
                    updateSuggestedCostTable();
                    updateSuggestedAvailabilityDisplay();
                });
            }

            // Get provider experiences Tom Select instance
            const providerExperiencesSelectElement = document.getElementById('provider-experiences');
            const providerExperiencesTomSelectInstance = providerExperiencesSelectElement?.tomselect;
            
            if (providerExperiencesTomSelectInstance) {
                providerExperiencesTomSelectInstance.on('change', function() {
                    updateSuggestedCostTable();
                    updateSuggestedAvailabilityDisplay();
                });
            }

            if (toursTomSelectInstance) {
                toursTomSelectInstance.on('change', function() {
                    updateSuggestedCostTable();
                });
            }

            if (experiencesTomSelectInstance || toursTomSelectInstance) {
                calculatorInitialized = true;
            }
        }

        // Get JWT token from localStorage or cookies
        function getAccessToken() {
            // First try localStorage (used by other parts of the app)
            const tokenFromStorage = localStorage.getItem('accessToken');
            if (tokenFromStorage) {
                return tokenFromStorage;
            }
            
            // Fallback to cookies (httpOnly cookies won't work, but try anyway)
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'accessToken') {
                    return value;
                }
            }
            return null;
        }

        // Setup global AJAX configuration to include JWT token
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAccessToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            }
        });

        // Setup experience filter functionality
        function setupExperienceFilters() {
            // Store current rates
            let currentTransferRate = 0;
            let currentAgencyRate = 0;
            let currentExchangeRate = 0;
            
            // Function to apply USD rounding rules
            function applyUSDRoundingRules(value) {
                // Find the base (nearest multiple of 5 below or equal)
                const base = Math.floor(value / 5) * 5;
                
                // Calculate remainder when dividing by 5
                const remainder = value % 5;
                
                if (remainder === 0) {
                    const lastDigitBeforeDecimal = Math.floor(value) % 10;
                    if (lastDigitBeforeDecimal === 3 || lastDigitBeforeDecimal === 8) {
                        return base + 5; // Round up
                    } else {
                        return base; // Keep as multiple of 5
                    }
                } else if (remainder <= 2.7) {
                    // Round down to nearest 5
                    return base;
                } else {
                    // Round up to next multiple of 5
                    return base + 5;
                }
            }
            
            // Function to update displayed prices
            function updatePrices(paymentType, currency) {
                const table = $(`#${tableId}`);
                if (!table.length) return;
                
                // Update price cell (column 6 - Precio)
                table.find('tbody tr').each(function() {
                    const row = $(this);
                    const priceCell = row.find('td:nth-child(6)'); // Precio column only
                    
                    priceCell.each(function() {
                        const cell = $(this);
                        let originalPrice = cell.attr('data-original-price');
                        
                        if (!originalPrice) {
                            // Extract numeric value from current display
                            const currentText = cell.text().replace(/[^0-9.]/g, '');
                            originalPrice = parseFloat(currentText) || 0;
                            cell.attr('data-original-price', originalPrice);
                        } else {
                            originalPrice = parseFloat(originalPrice);
                        }
                        
                        if (originalPrice === 0) return;
                        
                        let finalPrice = originalPrice;
                        
                        // Apply payment type rates
                        if (paymentType === 'transferencia') {
                            finalPrice = finalPrice * 1.035; // 3.5% transfer rate
                        } else if (paymentType === 'transf_agencias') {
                            finalPrice = finalPrice * 1.05; // 5% agency rate
                        }
                        
                        // Apply currency conversion
                        if (currency === 'USD') {
                            finalPrice = finalPrice / 17.5; // Example exchange rate
                            finalPrice = applyUSDRoundingRules(finalPrice);
                            
                            // Format as USD
                            const formatted = new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).format(finalPrice);
                            
                            // Update cell HTML structure
                            cell.html(`
                                <div class="text-center">
                                    <div class="fw-bold text-primary" style="font-size: 1rem;">
                                        ${formatted}
                                    </div>
                                </div>
                            `);
                        } else {
                            // Format as MXN
                            const formatted = new Intl.NumberFormat('es-MX', {
                                style: 'currency',
                                currency: 'MXN'
                            }).format(finalPrice);
                            
                            // Update cell HTML structure
                            cell.html(`
                                <div class="text-center">
                                    <div class="fw-bold text-primary" style="font-size: 1rem;">
                                        ${formatted}
                                    </div>
                                </div>
                            `);
                        }
                    });
                });
            }
            
            // Currency filter change handler
            $(`#currencyFilter-${tableId}`).on('change', function() {
                const selectedCurrency = $(this).val();
                const selectedPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                updatePrices(selectedPaymentType, selectedCurrency);
            });
            
            // Payment type filter change handler
            $(`#paymentTypeFilter-${tableId}`).on('change', function() {
                const selectedPaymentType = $(this).val();
                const selectedCurrency = $(`#currencyFilter-${tableId}`).val();
                updatePrices(selectedPaymentType, selectedCurrency);
            });
        }

        const dataTable = $(`#${tableId}`).DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: apiEndpoint + '?type=Experience',
                type: 'GET',
                dataSrc: function(json) {
                    return json.data || [];
                },
                error: function(xhr, error, thrown) {
                    console.error('Error loading experiences:', error);
                    showErrorAlert('Error al cargar las experiencias. Por favor, intente nuevamente.');
                }
            },
            columns: [
                {
                    data: 'name',
                    render: function(data) {
                        return `<div class="fw-semibold">${data}</div>`;
                    }
                },
                {
                    data: 'description',
                    render: function(data, type, row) {
                        // For department_manager, show included experiences and tours instead of description
                        if (userRole === 'department_manager') {
                            let content = '';
                            
                            // Check various possible field names for included experiences
                            const experienceDetails = row.experienceDetails || row.experiences || row.includedExperiences || [];
                            const providerExperienceDetails = row.providerExperienceDetails || row.providerExperiences || row.includedProviderExperiences || [];
                            const tourDetails = row.tourDetails || row.tours || row.includedTours || [];
                            
                            // Show included experiences
                            if (experienceDetails && experienceDetails.length > 0) {
                                content += `<div class="mb-2"><small class="text-primary fw-semibold">Experiencias:</small></div>`;
                                const experienceItems = experienceDetails.map(exp => {
                                    // Handle different object structures
                                    if (typeof exp === 'string') return exp;
                                    const name = exp.name || exp.title || exp.destinationPOI?.name || 'Experiencia sin nombre';
                                    return `<li style="color: var(--bs-primary);"><small class="text-primary">${name}</small></li>`;
                                }).join('');
                                content += `<ul class="mb-2" style="margin: 0; padding-left: 16px; list-style-type: disc;">${experienceItems}</ul>`;
                            }
                            
                            // Show included provider experiences
                            if (providerExperienceDetails && providerExperienceDetails.length > 0) {
                                content += `<div class="mb-2"><small class="text-warning fw-semibold">Experiencias de Proveedores:</small></div>`;
                                const providerExperienceItems = providerExperienceDetails.map(provExp => {
                                    // Handle different object structures
                                    if (typeof provExp === 'string') return provExp;
                                    const name = provExp.name || provExp.title || 'Experiencia de proveedor sin nombre';
                                    const providerName = provExp.provider?.name || 'Proveedor desconocido';
                                    return `<li style="color: var(--bs-warning);"><small class="text-warning">${name} (${providerName})</small></li>`;
                                }).join('');
                                content += `<ul class="mb-2" style="margin: 0; padding-left: 16px; list-style-type: disc;">${providerExperienceItems}</ul>`;
                            }
                            
                            // Show included tours
                            if (tourDetails && tourDetails.length > 0) {
                                content += `<div class="mb-2"><small class="text-success fw-semibold">Tours:</small></div>`;
                                const tourItems = tourDetails.map(tour => {
                                    // Handle different object structures
                                    if (typeof tour === 'string') return tour;
                                    
                                    // Extract POI destination name from the updated API response structure
                                    const poiName = tour.destinationPOI?.name;
                                    const name = tour.name || tour.title || poiName || 'Tour sin nombre';
                                    return `<li style="color: var(--bs-success);"><small class="text-success">${name}</small></li>`;
                                }).join('');
                                content += `<ul style="margin: 0; padding-left: 16px; list-style-type: disc;">${tourItems}</ul>`;
                            }
                            
                            // Check for experienceCount and tourCount as indicators
                            const experienceCount = row.experienceCount || 0;
                            const tourCount = row.tourCount || 0;
                            
                            if (!content && (experienceCount > 0 || tourCount > 0)) {
                                content = `<small class="text-info">Contiene: ${experienceCount > 0 ? experienceCount + ' experiencias' : ''} ${tourCount > 0 ? tourCount + ' tours' : ''}</small>`;
                            }
                            
                            // If no included content, show a placeholder
                            if (!content) {
                                content = '<small class="text-muted">Sin contenido incluido</small>';
                            }
                            
                            return content;
                        } else {
                            // For other roles, show truncated description as before
                            const truncated = data.length > 100 ? data.substring(0, 100) + '...' : data;
                            return `<small class="text-muted">${truncated}</small>`;
                        }
                    }
                },
                // 3. Contenido (only for non-department_manager roles)
                ...(userRole !== 'department_manager' ? [{
                    data: null,
                    className: 'text-center',
                    render: function(data, type, row) {
                        const experienceCount = row.experienceCount || 0;
                        const providerExperienceCount = row.providerExperienceCount || 0;
                        const tourCount = row.tourCount || 0;
                        const totalCount = experienceCount + providerExperienceCount + tourCount;
                        
                        if (totalCount === 0) {
                            return '<span class="text-muted">-</span>';
                        }
                        
                        let html = '';
                        if (experienceCount > 0) {
                            html += `<span class="badge bg-primary me-1" title="Experiencias">${experienceCount} Exp</span>`;
                        }
                        if (providerExperienceCount > 0) {
                            html += `<span class="badge bg-warning me-1" title="Experiencias de Proveedores">${providerExperienceCount} Prov</span>`;
                        }
                        if (tourCount > 0) {
                            html += `<span class="badge bg-success" title="Tours">${tourCount} Tours</span>`;
                        }
                        
                        return html;
                    }
                }] : []),
                {
                    data: 'duration',
                    render: function(data) {
                        if (!data) return '<span class="text-muted">No especificado</span>';
                        return `<span class="text-primary">${data} hrs</span>`;
                    }
                },
                {
                    data: 'min_people',
                    render: function(data) {
                        if (!data) return '<span class="text-muted">No especificado</span>';
                        return `<span class="text-info">${data} personas</span>`;
                    }
                },
                // 6. Precio (base price from database)
                {
                    data: 'cost',
                    render: function(data, type, row) {
                        const baseCost = data || 0;

                        // For sorting and filtering, use base cost
                        if (type === 'sort' || type === 'filter') {
                            return baseCost;
                        }

                        const formatMXN = (amount) => new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN'
                        }).format(amount);

                        return `
                            <div class="text-center">
                                <div class="fw-bold text-primary" style="font-size: 1rem;">
                                    ${formatMXN(baseCost)}
                                </div>
                            </div>
                        `;
                    }
                },
                // 7. Última Actualización
                ...(userRole !== 'department_manager' ? [{
                    data: 'updatedAt',
                    render: function(data) {
                        const date = new Date(data);
                        return `<small>${date.toLocaleDateString('es-MX')}</small>`;
                    }
                }] : []),
                // 8. Estado
                ...(userRole !== 'department_manager' ? [{
                    data: 'active',
                    render: function(data) {
                        return data
                            ? '<span class="badge bg-success">Activa</span>'
                            : '<span class="badge bg-secondary">Inactiva</span>';
                    }
                }] : []),
                ...((showActions || canViewImages) ? [{
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: function(data) {
                        let actions = '<div class="btn-group btn-group-sm" role="group">';
                        
                        if (canEdit) {
                            // Edit button (only for admin/superadmin)
                            actions += `<button type="button"
                                            class="btn btn-primary edit-experience-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Editar Experiencia">
                                            <i class="ti ti-edit"></i>
                                        </button>`;

                            // Manage images button (admin/superadmin can manage)
                            actions += `<button type="button"
                                            class="btn btn-info manage-images-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-name="${data.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Gestionar Imágenes">
                                            <i class="ti ti-photo"></i>
                                        </button>`;
                        } else if (canViewImages && !canEdit) {
                            // View gallery button (department_manager can only view)
                            actions += `<button type="button"
                                            class="btn btn-info view-gallery-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-name="${data.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Ver Galería de Imágenes">
                                            <i class="ti ti-photo"></i>
                                        </button>`;
                        }

                        if (canEdit) {
                            // Toggle status button
                            const statusIcon = data.active ? 'ti-archive' : 'ti-archive-off';
                            const statusTitle = data.active ? 'Desactivar Experiencia' : 'Activar Experiencia';
                            const statusClass = data.active ? 'btn-warning' : 'btn-success';

                            actions += `<button type="button"
                                            class="btn ${statusClass} toggle-experience-status-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-current-status="${data.active}"
                                            data-name="${data.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="${statusTitle}">
                                            <i class="ti ${statusIcon}"></i>
                                        </button>`;
                        }
                        if (canDelete) {
                            // Delete button
                            actions += `<button type="button"
                                            class="btn btn-danger delete-experience-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-name="${data.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Eliminar Experiencia">
                                            <i class="ti ti-trash"></i>
                                        </button>`;
                        }
                        actions += '</div>';
                        return actions;
                    }
                }] : [])
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando experiencias...'
            },
            order: userRole !== 'department_manager' ? [[6, 'desc']] : [[0, 'asc']], // Sort by updatedAt (Última Act.) or Name
            pageLength: 10,
            searchDelay: 300,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            drawCallback: function() {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        // Setup filter functionality for Moneda and Pago dropdowns
        setupExperienceFilters();

        $('#createExperienceBtn').on('click', function() { openExperienceModal(); });
        $(`#${tableId}`).on('click', '.edit-experience-btn', function() { loadExperienceData($(this).data('id')); });
        $(`#${tableId}`).on('click', '.manage-images-btn', function() {
            const experienceId = $(this).data('id');
            const name = $(this).data('name');
            window.openExperienceImagesModal(experienceId, name, false); // false for manage mode (admin)
        });
        $(`#${tableId}`).on('click', '.view-gallery-btn', function() {
            const experienceId = $(this).data('id');
            const name = $(this).data('name');
            window.openExperienceImagesModal(experienceId, name, true); // true for view-only mode
        });
        $(`#${tableId}`).on('click', '.toggle-experience-status-btn', function() {
            toggleExperienceStatus($(this).data('id'), $(this).data('current-status'), $(this).data('name'));
        });
        $(`#${tableId}`).on('click', '.delete-experience-btn', function() { deleteExperience($(this).data('id'), $(this).data('name')); });
        $('#saveExperienceBtn').on('click', function() { saveExperience(); });

        // ========== AVAILABILITY CALENDAR MANAGEMENT ==========

        // Object to store day schedules
        let daySchedules = {};

        // Day selection handling
        function initializeDaySelection() {
            $('#experienceAvailableDaysContainer .day-btn').removeClass('active btn-primary').addClass('btn-outline-primary');

            // Clear day schedules
            $('#experienceDaySchedulesContainer .day-schedule-row').remove();
            daySchedules = {};
            updateNoDaysMessage();
        }

        // Handle day button clicks
        $(document).on('click', '#experienceAvailableDaysContainer .day-btn', function() {
            const dayCode = parseInt($(this).data('day'));
            const dayName = $(this).data('day-name');
            const isSelected = $(this).hasClass('active');

            if (isSelected) {
                // Deselect: Remove day schedule
                removeDaySchedule(dayCode);
                $(this).removeClass('active btn-primary').addClass('btn-outline-primary');
            } else {
                // Select: Add day schedule
                addDaySchedule(dayCode, dayName);
                $(this).removeClass('btn-outline-primary').addClass('active btn-primary');
            }

            updateNoDaysMessage();
        });

        // Add day schedule row
        function addDaySchedule(dayCode, dayName, startTime = '', endTime = '') {
            // Check if already exists
            if (daySchedules[dayCode]) return;

            // Clone template
            const template = document.getElementById('experienceDayScheduleRowTemplate');
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.day-schedule-row');

            // Set day code and name
            row.setAttribute('data-day', dayCode);
            row.querySelector('.day-name span').textContent = dayName;

            // Set initial values if provided
            if (startTime) row.querySelector('.day-start-time').value = startTime;
            if (endTime) row.querySelector('.day-end-time').value = endTime;

            // Add to container (sorted by day code)
            insertDayScheduleSorted(row, dayCode);

            // Store in daySchedules object
            daySchedules[dayCode] = {
                dayName: dayName,
                element: row
            };

            // Attach time validation to inputs
            attachTimeInputValidation(row.querySelector('.day-start-time'));
            attachTimeInputValidation(row.querySelector('.day-end-time'));
        }

        // Insert day schedule row in chronological order (Mon-Sun)
        function insertDayScheduleSorted(row, dayCode) {
            const container = $('#experienceDaySchedulesContainer');
            const existingRows = container.find('.day-schedule-row');

            // Convert day code for sorting (Sunday = 7 for sorting purposes)
            const sortValue = dayCode === 0 ? 7 : dayCode;

            let inserted = false;
            existingRows.each(function() {
                const existingDayCode = parseInt($(this).attr('data-day'));
                const existingSortValue = existingDayCode === 0 ? 7 : existingDayCode;

                if (sortValue < existingSortValue) {
                    $(this).before(row);
                    inserted = true;
                    return false; // Break loop
                }
            });

            if (!inserted) {
                container.append(row);
            }
        }

        // Remove day schedule row
        function removeDaySchedule(dayCode) {
            if (!daySchedules[dayCode]) return;

            // Remove from DOM
            $(daySchedules[dayCode].element).remove();

            // Remove from daySchedules object
            delete daySchedules[dayCode];
        }

        // Handle remove day button clicks
        $(document).on('click', '.remove-day-btn', function() {
            const row = $(this).closest('.day-schedule-row');
            const dayCode = parseInt(row.attr('data-day'));

            // Deselect day button
            $(`#experienceAvailableDaysContainer .day-btn[data-day="${dayCode}"]`).removeClass('active btn-primary').addClass('btn-outline-primary');

            // Remove schedule
            removeDaySchedule(dayCode);
            updateNoDaysMessage();
        });

        // Update "no days selected" message visibility
        function updateNoDaysMessage() {
            const hasDays = Object.keys(daySchedules).length > 0;
            $('#experienceNoDaysSelected').toggle(!hasDays);
        }

        // Time input validation and formatting
        function attachTimeInputValidation(input) {
            const $input = $(input);

            $input.on('input', function() {
                let value = $(this).val().replace(/[^0-9]/g, ''); // Remove non-digits

                // Auto-format: add ":" after 2 digits
                if (value.length >= 2) {
                    value = value.substring(0, 2) + ':' + value.substring(2, 4);
                }

                $(this).val(value);
            });

            $input.on('blur', function() {
                const value = $(this).val();
                if (!value) return;

                // Validate format HH:MM (00:00 to 23:59)
                const timeRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(value)) {
                    $(this).addClass('is-invalid');
                    showModalError('Formato de hora inválido. Use HH:MM (00:00 a 23:59)');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
        }

        // ========== END AVAILABILITY CALENDAR MANAGEMENT ==========

        function openExperienceModal() {
            // Reset form
            $('#experienceForm')[0].reset();
            $('#experienceId').val('');
            $('#modalTitle').text('Crear Nueva Experiencia');
            $('#saveButtonText').text('Crear Experiencia');
            
            // Clear any previous alerts
            $('#experienceModalAlerts').empty();
            
            // Reset availability calendar
            initializeDaySelection();
            
            // Load dropdown data
            Promise.all([
                loadAvailableItems(),
                loadAvailableProviderExperiences(),
                loadAvailableTours(),
                loadAvailableVehicleTypes()
            ]).then(() => {
                // Initialize Tom Select for multiselect dropdowns
                initializeTomSelectDropdowns();
                
                // Show modal
                $('#experienceModal').modal('show');
            });
        }

        function loadExperienceData(experienceId) {
            // Show loading state
            $('#modalTitle').text('Cargando...');
            $('#experienceModal').modal('show');
            
            // Fetch experience data
            $.ajax({
                url: `${apiEndpoint}/${experienceId}`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        populateExperienceForm(response.data);
                    }
                },
                error: function(xhr) {
                    $('#experienceModal').modal('hide');
                    showErrorAlert('Error al cargar los datos de la experiencia');
                }
            });
        }

        function populateExperienceForm(experience) {
            $('#experienceId').val(experience.id);
            $('#modalTitle').text('Editar Experiencia');
            $('#saveButtonText').text('Actualizar Experiencia');
            
            // Populate basic fields
            $('#name').val(experience.name);
            $('#description').val(experience.description);
            $('#duration').val(experience.duration || '');
            $('#min_people').val(experience.min_people || '');
            $('#time_journey').val(experience.time_journey || '');
            $('#cost').val(experience.cost);
            
            // Load dropdown data first, then populate selections
            Promise.all([
                loadAvailableItems(experience.id),
                loadAvailableProviderExperiences(experience.id),
                loadAvailableTours(),
                loadAvailableVehicleTypes()
            ]).then(() => {
                initializeTomSelectDropdowns();
                
                // Populate vehicle type
                if (experience.vehicleTypeId) {
                    $('#vehicleType').val(experience.vehicleTypeId);
                }
                
                // Wait for a small delay to ensure all TomSelect instances are fully initialized
                setTimeout(() => {
                    // Populate selected experiences, provider experiences, and tours
                    if (experience.experienceDetails && experience.experienceDetails.length > 0) {
                        const experienceIds = experience.experienceDetails.map(exp => exp.id);
                        const experiencesSelect = document.getElementById('experiences');
                        if (experiencesSelect?.tomselect) {
                            experiencesSelect.tomselect.setValue(experienceIds);
                        }
                    }
                    
                    if (experience.providerExperienceDetails && experience.providerExperienceDetails.length > 0) {
                        const providerExperienceIds = experience.providerExperienceDetails.map(provExp => provExp.id);
                        const providerExperiencesSelect = document.getElementById('provider-experiences');
                        
                        if (providerExperiencesSelect?.tomselect) {
                            const availableOptions = Object.keys(providerExperiencesSelect.tomselect.options);
                            
                            if (availableOptions.length > 0) {
                                providerExperiencesSelect.tomselect.setValue(providerExperienceIds);
                            } else {
                                // Retry after another short delay if options aren't loaded yet
                                setTimeout(() => {
                                    const retryOptions = Object.keys(providerExperiencesSelect.tomselect.options);
                                    if (retryOptions.length > 0) {
                                        providerExperiencesSelect.tomselect.setValue(providerExperienceIds);
                                    }
                                }, 200);
                            }
                        }
                    }
                    
                    if (experience.tourDetails && experience.tourDetails.length > 0) {
                        const tourIds = experience.tourDetails.map(tour => tour.id);
                        const toursSelect = document.getElementById('tours');
                        if (toursSelect?.tomselect) {
                            toursSelect.tomselect.setValue(tourIds);
                        }
                    }
                }, 100); // Small delay to ensure options are loaded
            });
        }

        function initializeTomSelectDropdowns() {
            // Check if TomSelect is available
            if (typeof TomSelect === 'undefined') {
                console.warn('TomSelect library not available, using standard select');
                return;
            }

            // Initialize tours dropdown with Tom Select
            const toursSelect = document.getElementById('tours');
            if (toursSelect && !toursSelect.tomselect) {
                new TomSelect(toursSelect, {
                    plugins: ['remove_button'],
                    placeholder: 'Buscar tours por destino, tiempo o precio...',
                    allowEmptyOption: false,
                    searchField: ['text', 'name', 'destination'],
                    sortField: [
                        {field: 'destination', direction: 'asc'},
                        {field: 'time', direction: 'asc'},
                        {field: 'price', direction: 'asc'}
                    ],
                    render: {
                        option: function(data, escape) {
                            const tour = toursDataMap[data.value];
                            if (!tour) return `<div>${escape(data.text)}</div>`;
                            
                            const priceFormatted = formatMoney(tour.price || 0);
                            const destination = tour.destinationPOI?.name || 'Destino no especificado';
                            const time = tour.time || 'Tiempo no especificado';
                            
                            return `
                                <div class="tomselect-option-enhanced">
                                    <div class="option-main">
                                        <strong>${escape(destination)}</strong>
                                    </div>
                                    <div class="option-meta">
                                        <span class="badge bg-success me-2">Tour</span>
                                        <span class="text-primary me-2"><i class="ti ti-clock"></i> ${escape(time)}</span>
                                        <span class="text-success fw-bold">$${priceFormatted} MXN</span>
                                    </div>
                                    ${tour.vehicleType ? 
                                        `<small class="text-info"><i class="ti ti-car"></i> ${escape(tour.vehicleType)}</small>` : 
                                        '<small class="text-muted">Sin tipo de vehículo específico</small>'
                                    }
                                </div>
                            `;
                        },
                        item: function(data, escape) {
                            const tour = toursDataMap[data.value];
                            if (!tour) return `<div>${escape(data.text)}</div>`;
                            
                            const priceFormatted = formatMoney(tour.price || 0);
                            const destination = tour.destinationPOI?.name || 'Destino no especificado';
                            
                            return `
                                <div class="tomselect-item-enhanced">
                                    <span class="item-name">${escape(destination)}</span>
                                    <small class="text-primary ms-2">${escape(tour.time || '')}</small>
                                    <small class="text-success ms-2">$${priceFormatted}</small>
                                </div>
                            `;
                        },
                        no_results: function(data, escape) {
                            return `
                                <div class="no-results">
                                    <i class="ti ti-search-off"></i>
                                    <p class="mb-0">No se encontraron tours</p>
                                    <small class="text-muted">Intenta buscar por destino, tiempo o precio</small>
                                </div>
                            `;
                        }
                    },
                    onChange: function(values) {
                        updateSuggestedCostTable();
                    }
                });
            }

            // Initialize experiences dropdown if it exists
            const experiencesSelect = document.getElementById('experiences');
            if (experiencesSelect && !experiencesSelect.tomselect) {
                new TomSelect(experiencesSelect, {
                    plugins: ['remove_button'],
                    placeholder: 'Buscar experiencias por nombre o costo...',
                    allowEmptyOption: false,
                    searchField: ['text', 'name'],
                    sortField: [
                        {field: 'name', direction: 'asc'},
                        {field: 'cost', direction: 'asc'}
                    ],
                    render: {
                        option: function(data, escape) {
                            const experience = experiencesDataMap[data.value];
                            if (!experience) return `<div>${escape(data.text)}</div>`;
                            
                            const costFormatted = formatMoney(experience.cost || 0);
                            return `
                                <div class="tomselect-option-enhanced">
                                    <div class="option-main">
                                        <strong>${escape(experience.name)}</strong>
                                    </div>
                                    <div class="option-meta">
                                        <span class="badge bg-primary me-2">Experiencia</span>
                                        <span class="text-success fw-bold">$${costFormatted} MXN</span>
                                    </div>
                                </div>
                            `;
                        },
                        item: function(data, escape) {
                            const experience = experiencesDataMap[data.value];
                            if (!experience) return `<div>${escape(data.text)}</div>`;
                            
                            const costFormatted = formatMoney(experience.cost || 0);
                            return `
                                <div class="tomselect-item-enhanced">
                                    <span class="item-name">${escape(experience.name)}</span>
                                    <small class="text-success ms-2">$${costFormatted}</small>
                                </div>
                            `;
                        },
                        no_results: function(data, escape) {
                            return `
                                <div class="no-results">
                                    <i class="ti ti-search-off"></i>
                                    <p class="mb-0">No se encontraron experiencias</p>
                                    <small class="text-muted">Intenta con otros términos de búsqueda</small>
                                </div>
                            `;
                        }
                    },
                    onChange: function(values) {
                        // Validate that all selected experiences exist in the data map
                        const validatedValues = values.filter(id => {
                            const exists = experiencesDataMap.hasOwnProperty(id);
                            if (!exists) {
                                console.warn(`Experience ID ${id} not found in available data`);
                                // Show user-friendly notification
                                showToast('warning', `Experiencia no encontrada (ID: ${id}). Se ha removido de la selección.`);
                            }
                            return exists;
                        });
                        
                        // If some values were invalid, update the selection
                        if (validatedValues.length !== values.length) {
                            this.setValue(validatedValues, true); // true = silent update
                            return;
                        }
                        
                        updateSuggestedCostTable();
                    }
                });
            }

            // Initialize provider experiences dropdown if it exists
            const providerExperiencesSelect = document.getElementById('provider-experiences');
            if (providerExperiencesSelect && !providerExperiencesSelect.tomselect) {
                new TomSelect(providerExperiencesSelect, {
                    plugins: ['remove_button'],
                    placeholder: 'Buscar por experiencia, proveedor o precio...',
                    allowEmptyOption: false,
                    searchField: ['text', 'name', 'provider'],
                    sortField: [
                        {field: 'provider', direction: 'asc'},
                        {field: 'name', direction: 'asc'},
                        {field: 'price', direction: 'asc'}
                    ],
                    render: {
                        option: function(data, escape) {
                            const providerExperience = providerExperiencesDataMap[data.value];
                            if (!providerExperience) return `<div>${escape(data.text)}</div>`;
                            
                            const priceFormatted = formatMoney(providerExperience.price || 0);
                            const providerName = providerExperience.provider?.name || 'Sin proveedor';
                            
                            return `
                                <div class="tomselect-option-enhanced">
                                    <div class="option-main">
                                        <strong>${escape(providerExperience.name)}</strong>
                                    </div>
                                    <div class="option-meta">
                                        <span class="badge bg-warning me-2">Proveedor</span>
                                        <span class="text-muted me-2">${escape(providerName)}</span>
                                        <span class="text-success fw-bold">$${priceFormatted} MXN</span>
                                    </div>
                                    ${providerExperience.availability ? 
                                        '<small class="text-primary"><i class="ti ti-calendar-check"></i> Con disponibilidad</small>' : 
                                        '<small class="text-muted"><i class="ti ti-calendar"></i> Disponible siempre</small>'
                                    }
                                </div>
                            `;
                        },
                        item: function(data, escape) {
                            const providerExperience = providerExperiencesDataMap[data.value];
                            if (!providerExperience) return `<div>${escape(data.text)}</div>`;
                            
                            const priceFormatted = formatMoney(providerExperience.price || 0);
                            const providerName = providerExperience.provider?.name || 'Sin proveedor';
                            
                            return `
                                <div class="tomselect-item-enhanced">
                                    <span class="item-name">${escape(providerExperience.name)}</span>
                                    <small class="text-muted ms-1">(${escape(providerName)})</small>
                                    <small class="text-success ms-2">$${priceFormatted}</small>
                                </div>
                            `;
                        },
                        no_results: function(data, escape) {
                            return `
                                <div class="no-results">
                                    <i class="ti ti-search-off"></i>
                                    <p class="mb-0">No se encontraron experiencias de proveedores</p>
                                    <small class="text-muted">Intenta buscar por nombre, proveedor o precio</small>
                                </div>
                            `;
                        }
                    },
                    onChange: function(values) {
                        updateSuggestedCostTable();
                    }
                });
            }
        }

        function loadAvailableItems(currentId = null) {
            // Load regular experiences (not provider experiences)
            return $.ajax({
                url: '<%= dtApiEndpoint %>',
                type: 'GET',
                success: function(response) {
                    if (response.data && Array.isArray(response.data)) {
                        // Reset data map
                        experiencesDataMap = {};

                        // Get Tom Select instance
                        const selectElement = document.getElementById('experiences');
                        const tomSelectInstance = selectElement ? selectElement.tomselect : null;

                        if (tomSelectInstance) {
                            // Clear existing options
                            tomSelectInstance.clearOptions();

                            // Add experiences as options (exclude current experience if editing and Provider type)
                            response.data.forEach(function(experience) {
                                if (experience.active && experience.id !== currentId && experience.type === 'Experience') {
                                    // Store complete data for cost calculation and availability
                                    experiencesDataMap[experience.id] = {
                                        id: experience.id,
                                        name: experience.name,
                                        cost: experience.cost || 0,
                                        type: experience.type,
                                        availability: experience.availability
                                    };

                                    // Format display text
                                    const costFormatted = formatMoney(experience.cost || 0);
                                    tomSelectInstance.addOption({
                                        value: experience.id,
                                        text: `${experience.name} ($${costFormatted} MXN)`
                                    });
                                }
                            });

                            // Refresh the dropdown
                            tomSelectInstance.refreshOptions(false);

                            // Initialize cost calculator after loading items
                            initializeSuggestedCostCalculator();
                        }
                    }
                },
                error: function(xhr) {
                    console.warn('No se pudieron cargar las experiencias');
                }
            });
        }

        function loadAvailableProviderExperiences(currentId = null) {
            // Load provider experiencias
            return $.ajax({
                url: '/api/provider-experiencias/all',
                type: 'GET',
                success: function(response) {
                    if (response.data && Array.isArray(response.data)) {
                        // Reset provider experiences data map
                        providerExperiencesDataMap = {};
                        
                        // Get Tom Select instance for provider experiences
                        const selectElement = document.getElementById('provider-experiences');
                        const tomSelectInstance = selectElement ? selectElement.tomselect : null;

                        if (tomSelectInstance) {
                            // Clear existing options
                            tomSelectInstance.clearOptions();

                            // Add provider experiencias as options
                            response.data.forEach(function(experiencia) {
                                if (experiencia.active) {
                                    // Store complete data for cost calculation and availability
                                    providerExperiencesDataMap[experiencia.id] = {
                                        id: experiencia.id,
                                        name: experiencia.name,
                                        price: experiencia.price || 0,
                                        provider: experiencia.provider,
                                        availability: experiencia.availability
                                    };

                                    // Format display text as "Experience Name - Provider Name"
                                    const priceFormatted = formatMoney(experiencia.price || 0);
                                    const providerName = experiencia.provider ? experiencia.provider.name : 'Sin proveedor';
                                    tomSelectInstance.addOption({
                                        value: experiencia.id,
                                        text: `${experiencia.name} - ${providerName} ($${priceFormatted} MXN)`
                                    });
                                }
                            });

                            // Refresh the dropdown
                            tomSelectInstance.refreshOptions(false);
                        }
                    }
                },
                error: function(xhr) {
                    console.warn('No se pudieron cargar las experiencias de proveedores');
                }
            });
        }

        function loadAvailableTours() {
            return $.ajax({
                url: '/api/tours',
                type: 'GET',
                data: { length: 1000 }, // Get all for selection
                success: function(response) {
                    // Fix: The API returns tours directly in response.data, not response.data.tours
                    if (response.data && Array.isArray(response.data)) {
                        // Reset tours data map
                        toursDataMap = {};

                        // Get Tom Select instance
                        const selectElement = document.getElementById('tours');
                        const tomSelectInstance = selectElement ? selectElement.tomselect : null;

                        if (tomSelectInstance) {
                            // Clear existing options
                            tomSelectInstance.clearOptions();

                            // Add new options with price information
                            response.data.forEach(function(item) {
                                if (item.active) {
                                    // Store complete data for cost calculation
                                    toursDataMap[item.id] = {
                                        id: item.id,
                                        name: `${item.destinationPOI?.name || 'Tour'} (${item.time || 0}min)`,
                                        price: item.price || 0
                                    };

                                    // Add option to Tom Select with price in display text
                                    const priceFormatted = formatMoney(item.price || 0);
                                    tomSelectInstance.addOption({
                                        value: item.id,
                                        text: `${item.destinationPOI?.name || 'Tour'} (${item.time || 0}min) - $${priceFormatted} MXN`
                                    });
                                }
                            });

                            // Refresh the dropdown
                            tomSelectInstance.refreshOptions(false);
                        } else {
                            console.error('loadAvailableTours: Tom Select instance not found for #tours element');
                        }
                    } else {
                        console.error('loadAvailableTours: Invalid response data structure:', response);
                    }
                },
                error: function(xhr) {
                    console.error('loadAvailableTours: API error:', xhr.status, xhr.responseText);
                    console.error('loadAvailableTours: Full xhr object:', xhr);
                    // Don't fail the whole operation if tours can't be loaded
                }
            }).always(function() {
                // Always resolve successfully to not break the promise chain
                return $.Deferred().resolve();
            });
        }

        function loadAvailableVehicleTypes() {
            return $.ajax({
                url: '/api/vehicle-types/active',
                type: 'GET',
                success: function(response) {
                    const select = document.getElementById('vehicleType');
                    if (select && response.data) {
                        // Clear existing options except the default one
                        select.innerHTML = '<option value="">Sin tipo de vehículo específico</option>';
                        
                        // Add vehicle type options
                        response.data.forEach(function(vehicleType) {
                            const option = document.createElement('option');
                            option.value = vehicleType.value;
                            option.textContent = vehicleType.label;
                            select.appendChild(option);
                        });
                    }
                },
                error: function(xhr) {
                    console.warn('No se pudieron cargar los tipos de vehículos:', xhr.status, xhr.responseText);
                }
            });
        }

        function openExperienceModal(isEdit = false) {
            // Clear any previous modal alerts
            const alertsContainer = document.getElementById('experienceModalAlerts');
            if (alertsContainer) {
                alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
            }

            $('#experienceModal').modal('show');
            $('#experienceForm')[0].reset();
            $('#experienceId').val('');
            $('#type').val('Experience');
            $('#duration').val(''); // Clear duration field
            $('#min_people').val(''); // Clear min_people field
            $('#time_journey').val(''); // Clear time_journey field
            $('#modalTitle').text(isEdit ? 'Editar Experiencia' : 'Crear Nueva Experiencia');
            $('#saveButtonText').text(isEdit ? 'Guardar Cambios' : 'Crear Experiencia');

            // Clear Tom Select values for experiences
            const experiencesSelectElement = document.getElementById('experiences');
            const experiencesTomSelectInstance = experiencesSelectElement ? experiencesSelectElement.tomselect : null;
            if (experiencesTomSelectInstance) {
                experiencesTomSelectInstance.clear();
            }

            // Clear Tom Select values for provider experiences
            const providerExperiencesSelectElement = document.getElementById('provider-experiences');
            const providerExperiencesTomSelectInstance = providerExperiencesSelectElement ? providerExperiencesSelectElement.tomselect : null;
            if (providerExperiencesTomSelectInstance) {
                providerExperiencesTomSelectInstance.clear();
            }

            // Clear Tom Select values for tours
            const toursSelectElement = document.getElementById('tours');
            const toursTomSelectInstance = toursSelectElement ? toursSelectElement.tomselect : null;
            if (toursTomSelectInstance) {
                toursTomSelectInstance.clear();
            }

            // Hide suggested cost table
            $('#suggestedCostContainer').hide();

            // Initialize availability calendar (clear all days)
            initializeDaySelection();

            // Load experiences, tours, and vehicle types
            $.when(loadAvailableItems(), loadAvailableProviderExperiences(), loadAvailableTours(), loadAvailableVehicleTypes()).done(function() {
                // All loaded successfully
            });
        }

        function loadExperienceData(experienceId) {
            openExperienceModal(true);

            // Show loader to prevent user interaction during data loading
            showModalLoader('experienceModal');

            $.ajax({
                url: `${apiEndpoint}/${experienceId}`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const experience = response.data;
                        
                        
                        $('#experienceId').val(experience.id);
                        $('#name').val(experience.name);
                        $('#description').val(experience.description);
                        $('#duration').val(experience.duration || '');
                        $('#min_people').val(experience.min_people || '');
                        $('#time_journey').val(experience.time_journey || '');
                        $('#cost').val(experience.cost);

                        // Load all items and set selected values
                        Promise.all([
                            loadAvailableItems(experience.id),
                            loadAvailableProviderExperiences(experience.id),
                            loadAvailableTours(),
                            loadAvailableVehicleTypes()
                        ]).then(function() {
                            // Set experiences values
                            if (experience.experiences && experience.experiences.length > 0) {
                                const experiencesSelectElement = document.getElementById('experiences');
                                const experiencesTomSelectInstance = experiencesSelectElement ? experiencesSelectElement.tomselect : null;
                                if (experiencesTomSelectInstance) {
                                    experiencesTomSelectInstance.setValue(experience.experiences);
                                }
                            }

                            // Set provider experiences values
                            if (experience.providerExperienceDetails && experience.providerExperienceDetails.length > 0) {
                                const providerExperienceIds = experience.providerExperienceDetails.map(provExp => provExp.id);
                                const providerExperiencesSelectElement = document.getElementById('provider-experiences');
                                const providerExperiencesTomSelectInstance = providerExperiencesSelectElement ? providerExperiencesSelectElement.tomselect : null;
                                
                                if (providerExperiencesTomSelectInstance) {
                                    providerExperiencesTomSelectInstance.setValue(providerExperienceIds);
                                }
                            }

                            // Set tours values
                            if (experience.tours && experience.tours.length > 0) {
                                const toursSelectElement = document.getElementById('tours');
                                const toursTomSelectInstance = toursSelectElement ? toursSelectElement.tomselect : null;
                                if (toursTomSelectInstance) {
                                    toursTomSelectInstance.setValue(experience.tours);
                                }
                            }

                            // Set vehicleType value if it exists
                            if (experience.vehicleTypeId) {
                                const vehicleTypeSelect = document.getElementById('vehicleType');
                                if (vehicleTypeSelect) {
                                    vehicleTypeSelect.value = experience.vehicleTypeId;
                                }
                            }

                            // Set availability (array of day schedules)
                            initializeDaySelection();
                            if (experience.availability && Array.isArray(experience.availability) && experience.availability.length > 0) {
                                // Load day schedules
                                experience.availability.forEach(schedule => {
                                    const dayBtn = $(`#experienceAvailableDaysContainer .day-btn[data-day="${schedule.day}"]`);
                                    const dayName = dayBtn.data('day-name');

                                    // Add day schedule with times
                                    addDaySchedule(schedule.day, dayName, schedule.startTime, schedule.endTime);

                                    // Activate day button
                                    dayBtn.removeClass('btn-outline-primary').addClass('active btn-primary');
                                });

                                updateNoDaysMessage();
                            }

                            // Update suggested cost table after setting values
                            updateSuggestedCostTable();

                            // Hide loader after all data is loaded and populated
                            hideModalLoader('experienceModal');
                        }).catch(function(error) {
                            console.warn('Error loading data for modal:', error);
                            // Hide loader even if loading items fails
                            hideModalLoader('experienceModal');
                        });
                    } else {
                        hideModalLoader('experienceModal');
                        showErrorAlert('Formato de respuesta inválido');
                    }
                },
                error: function(xhr) {
                    hideModalLoader('experienceModal');
                    showModalError(xhr.responseJSON?.error || 'Error al cargar la experiencia');
                }
            });
        }

        function saveExperience() {
            const form = $('#experienceForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }
            const experienceId = $('#experienceId').val();
            const isEdit = !!experienceId;

            // Get values from Tom Select for experiences
            const experiencesSelectElement = document.getElementById('experiences');
            const experiencesTomSelectInstance = experiencesSelectElement ? experiencesSelectElement.tomselect : null;
            const selectedExperiences = experiencesTomSelectInstance ? experiencesTomSelectInstance.getValue() : [];

            // Get values from Tom Select for provider experiences
            const providerExperiencesSelectElement = document.getElementById('provider-experiences');
            const providerExperiencesTomSelectInstance = providerExperiencesSelectElement ? providerExperiencesSelectElement.tomselect : null;
            const selectedProviderExperiences = providerExperiencesTomSelectInstance ? providerExperiencesTomSelectInstance.getValue() : [];

            // Get values from Tom Select for tours
            const toursSelectElement = document.getElementById('tours');
            const toursTomSelectInstance = toursSelectElement ? toursSelectElement.tomselect : null;
            const selectedTours = toursTomSelectInstance ? toursTomSelectInstance.getValue() : [];

            // Validation
            const totalItems = selectedExperiences.length + selectedProviderExperiences.length + selectedTours.length;
            
            // Validate that all selected experiences exist in the data map
            const invalidExperiences = selectedExperiences.filter(id => !experiencesDataMap.hasOwnProperty(id));
            if (invalidExperiences.length > 0) {
                showErrorAlert(`Las siguientes experiencias no están disponibles: ${invalidExperiences.join(', ')}. Por favor, actualiza la selección.`);
                return;
            }
            
            if (selectedExperiences.length > 20) {
                showErrorAlert('Máximo 20 experiencias permitidas');
                return;
            }
            if (selectedProviderExperiences.length > 20) {
                showErrorAlert('Máximo 20 experiencias de proveedores permitidas');
                return;
            }
            if (selectedTours.length > 20) {
                showErrorAlert('Máximo 20 tours permitidos');
                return;
            }
            if (totalItems > 40) {
                showErrorAlert('Máximo 40 elementos totales permitidos (experiencias + experiencias de proveedores + tours combinados)');
                return;
            }

            const experienceData = {
                name: $('#name').val(),
                description: $('#description').val(),
                type: $('#type').val(),
                cost: parseFloat($('#cost').val()),
                experiences: selectedExperiences,
                providerExperiences: selectedProviderExperiences,
                tours: selectedTours
            };

            // DEBUG: Log the data being sent

            // Only include duration if it has a value
            const durationValue = $('#duration').val();
            if (durationValue) {
                experienceData.duration = parseFloat(durationValue);
            }

            // Only include min_people if it has a value
            const minPeopleValue = $('#min_people').val();
            if (minPeopleValue) {
                experienceData.min_people = parseInt(minPeopleValue, 10);
            }

            // Only include time_journey if it has a value
            const timeJourneyValue = $('#time_journey').val();
            if (timeJourneyValue) {
                experienceData.time_journey = parseFloat(timeJourneyValue);
            }

            // Only include vehicleType if it has a value
            const vehicleTypeValue = $('#vehicleType').val();
            if (vehicleTypeValue) {
                experienceData.vehicleType = vehicleTypeValue;
            }

            // Add optional availability fields (NEW FORMAT: array of day schedules)
            if (Object.keys(daySchedules).length > 0) {
                const availability = [];
                const timeRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;

                // Collect and validate each day schedule
                for (const dayCode in daySchedules) {
                    const scheduleRow = $(daySchedules[dayCode].element);
                    const startTime = scheduleRow.find('.day-start-time').val();
                    const endTime = scheduleRow.find('.day-end-time').val();
                    const dayName = daySchedules[dayCode].dayName;

                    // Validate both times are provided
                    if (!startTime || !endTime) {
                        showModalError(`Debe especificar hora de inicio y fin para ${dayName}`);
                        return;
                    }

                    // Validate time format
                    if (!timeRegex.test(startTime)) {
                        showModalError(`Formato de hora de inicio inválido para ${dayName}. Use HH:MM (00:00 a 23:59)`);
                        return;
                    }
                    if (!timeRegex.test(endTime)) {
                        showModalError(`Formato de hora de fin inválido para ${dayName}. Use HH:MM (00:00 a 23:59)`);
                        return;
                    }

                    // Validate endTime > startTime
                    if (startTime >= endTime) {
                        showModalError(`La hora de fin debe ser posterior a la hora de inicio para ${dayName}`);
                        return;
                    }

                    // Add to availability array
                    availability.push({
                        day: parseInt(dayCode),
                        startTime: startTime,
                        endTime: endTime
                    });
                }

                // Add availability array to data (sorted by day code happens on backend)
                experienceData.availability = availability;
            }

            const url = isEdit ? `${apiEndpoint}/${experienceId}` : apiEndpoint;
            const method = isEdit ? 'PUT' : 'POST';
            $('#saveExperienceBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Guardando...');

            $.ajax({
                url, type: method,
                contentType: 'application/json',
                data: JSON.stringify(experienceData),
                success: function(response) {
                    if (response.success) {
                        $('#experienceModal').modal('hide');
                        dataTable.ajax.reload();
                        showSuccessAlert(isEdit ? 'Experiencia actualizada exitosamente' : 'Experiencia creada exitosamente');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.error || 'Error al guardar la experiencia';
                    showModalError(errorMessage);
                },
                complete: function() {
                    $('#saveExperienceBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>' + (isEdit ? 'Guardar Cambios' : 'Crear Experiencia'));
                }
            });
        }

        function toggleExperienceStatus(experienceId, currentStatus, experienceName) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'activar' : 'desactivar';
            const actionTitle = newStatus ? 'Activar' : 'Desactivar';
            const btnClass = newStatus ? 'btn-success' : 'btn-warning';

            // If deactivating, check for dependencies first
            if (!newStatus) {
                $.ajax({
                    url: `${apiEndpoint}/${experienceId}/dependencies`,
                    type: 'GET',
                    success: function(depResponse) {
                        if (depResponse.success && !depResponse.canModify) {
                            // Has dependencies, show error modal
                            showDependenciesModal(experienceName, depResponse.dependencies, 'desactivar');
                        } else {
                            // No dependencies, show confirmation modal
                            showToggleConfirmationModal(experienceId, newStatus, action, actionTitle, btnClass, experienceName);
                        }
                    },
                    error: function(xhr) {
                        showErrorAlert('Error al verificar dependencias');
                    }
                });
            } else {
                // Activating, no validation needed
                showToggleConfirmationModal(experienceId, newStatus, action, actionTitle, btnClass, experienceName);
            }
        }

        function showToggleConfirmationModal(experienceId, newStatus, action, actionTitle, btnClass, experienceName) {
            const modalHtml = `
                <div class="modal fade" id="confirmToggleExperienceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${actionTitle} Experiencia</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas ${action} la experiencia <strong>"${experienceName}"</strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn ${btnClass}" id="confirmToggleExperienceBtn">${actionTitle}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#confirmToggleExperienceModal').remove();
            $('body').append(modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('confirmToggleExperienceModal'));
            modal.show();

            $('#confirmToggleExperienceBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${experienceId}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ active: newStatus }),
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(null, false);
                            showSuccessAlert(`Experiencia ${newStatus ? 'activada' : 'desactivada'} exitosamente`);
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al cambiar el estado de la experiencia';
                        showErrorAlert(error);
                    }
                });
            });
        }

        function deleteExperience(experienceId, experienceName) {
            // Check for dependencies first
            $.ajax({
                url: `${apiEndpoint}/${experienceId}/dependencies`,
                type: 'GET',
                success: function(depResponse) {
                    if (depResponse.success && !depResponse.canModify) {
                        // Has dependencies, show error modal
                        showDependenciesModal(experienceName, depResponse.dependencies, 'eliminar');
                    } else {
                        // No dependencies, show confirmation modal
                        showDeleteConfirmationModal(experienceId, experienceName);
                    }
                },
                error: function(xhr) {
                    showErrorAlert('Error al verificar dependencias');
                }
            });
        }

        function showDeleteConfirmationModal(experienceId, experienceName) {
            const modalHtml = `
                <div class="modal fade" id="confirmDeleteExperienceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title text-white">Eliminar Experiencia</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas eliminar la experiencia <strong>"${experienceName}"</strong>?</p>
                                <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteExperienceBtn">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#confirmDeleteExperienceModal').remove();
            $('body').append(modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteExperienceModal'));
            modal.show();

            $('#confirmDeleteExperienceBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${experienceId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(null, false);
                            showSuccessAlert('Experiencia eliminada exitosamente');
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al eliminar la experiencia';
                        showErrorAlert(error);
                    }
                });
            });
        }

        function showDependenciesModal(itemName, dependencies, actionText) {
            const dependenciesList = dependencies.map(dep =>
                `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${dep.name}
                    <span class="badge bg-primary">${dep.type === 'Experience' ? 'Experiencia' : 'Proveedor'}</span>
                </li>`
            ).join('');

            const modalHtml = `
                <div class="modal fade" id="dependenciesModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">
                                    <i class="ti ti-alert-triangle me-2"></i>No se puede ${actionText}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning" role="alert">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    No se puede ${actionText} <strong>"${itemName}"</strong>
                                </div>
                                <p>Esta experiencia/proveedor está incluida en <strong>${dependencies.length}</strong> experiencia(s):</p>
                                <ul class="list-group mb-3">
                                    ${dependenciesList}
                                </ul>
                                <p class="text-muted mb-0">
                                    <i class="ti ti-info-circle me-1"></i>
                                    Para continuar, primero actualiza estas experiencias y remueve la dependencia.
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="ti ti-x me-1"></i>Entendido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#dependenciesModal').remove();
            $('body').append(modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('dependenciesModal'));
            modal.show();
        }

        function showModalError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('experienceModalAlerts');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 8000);
            }
        }

        function showSuccessAlert(message) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('experiences-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);
                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 5000);
            }
        }

        function showErrorAlert(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('experiences-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);
            }
        }

        // ========== REAL-TIME VALIDATION SYSTEM ==========

        /**
         * Real-time validation configuration
         */
        const validationConfig = {
            name: {
                required: true,
                minLength: 3,
                maxLength: 200,
                pattern: /^[a-zA-Z0-9\sáéíóúñÁÉÍÓÚÑ\-.,()]+$/,
                patternMessage: 'Solo se permiten letras, números, espacios y signos de puntuación básicos'
            },
            description: {
                required: true,
                minLength: 10,
                maxLength: 1000
            },
            cost: {
                required: true,
                min: 0,
                max: 999999
            },
            duration: {
                required: false,
                min: 0,
                max: 168 // Max 1 week in hours
            },
            min_people: {
                required: false,
                min: 1,
                max: 1000
            },
            time_journey: {
                required: false,
                min: 0,
                max: 48 // Max 2 days travel time
            }
        };

        /**
         * Validate individual field with real-time feedback
         */
        function validateField(fieldId, showSuccess = false) {
            const field = document.getElementById(fieldId);
            const config = validationConfig[fieldId];
            const errorElement = document.getElementById(`${fieldId}-error`);
            
            if (!field || !config) return true;

            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            // Required field validation
            if (config.required && !value) {
                isValid = false;
                errorMessage = 'Este campo es obligatorio';
            }
            // Length validations
            else if (value && config.minLength && value.length < config.minLength) {
                isValid = false;
                errorMessage = `Debe tener al menos ${config.minLength} caracteres`;
            }
            else if (value && config.maxLength && value.length > config.maxLength) {
                isValid = false;
                errorMessage = `No puede exceder ${config.maxLength} caracteres`;
            }
            // Pattern validation
            else if (value && config.pattern && !config.pattern.test(value)) {
                isValid = false;
                errorMessage = config.patternMessage || 'Formato inválido';
            }
            // Numeric validations
            else if (value && config.min !== undefined && parseFloat(value) < config.min) {
                isValid = false;
                errorMessage = `El valor mínimo es ${config.min}`;
            }
            else if (value && config.max !== undefined && parseFloat(value) > config.max) {
                isValid = false;
                errorMessage = `El valor máximo es ${config.max}`;
            }

            // Apply validation state
            if (isValid) {
                field.classList.remove('is-invalid');
                if (showSuccess && value) {
                    field.classList.add('is-valid');
                }
                if (errorElement) {
                    errorElement.textContent = '';
                }
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                }
            }

            return isValid;
        }

        /**
         * Validate entire form
         */
        function validateForm() {
            const fieldIds = Object.keys(validationConfig);
            let allValid = true;

            fieldIds.forEach(fieldId => {
                const isValid = validateField(fieldId, true);
                if (!isValid) allValid = false;
            });

            return allValid;
        }

        /**
         * Clear all validation states
         */
        function clearValidation() {
            Object.keys(validationConfig).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                
                if (field) {
                    field.classList.remove('is-valid', 'is-invalid');
                }
                if (errorElement) {
                    errorElement.textContent = '';
                }
            });
        }

        /**
         * Initialize real-time validation
         */
        function initializeRealTimeValidation() {
            Object.keys(validationConfig).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field) return;

                // Validate on input (for immediate feedback)
                field.addEventListener('input', function() {
                    // Debounce validation for better performance
                    clearTimeout(this.validationTimeout);
                    this.validationTimeout = setTimeout(() => {
                        validateField(fieldId);
                    }, 300);
                });

                // Validate on blur (when user leaves field)
                field.addEventListener('blur', function() {
                    validateField(fieldId, true);
                });

                // Clear validation state on focus (fresh start)
                field.addEventListener('focus', function() {
                    if (this.classList.contains('is-valid')) {
                        this.classList.remove('is-valid');
                    }
                });
            });

            // Override form submission to validate first
            const saveButton = document.getElementById('saveExperienceBtn');
            if (saveButton) {
                saveButton.addEventListener('click', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        showErrorAlert('Por favor, corrija los errores en el formulario antes de continuar');
                    }
                });
            }

            console.log('Real-time validation initialized');
        }

        // Initialize validation when modal opens
        $(document).on('shown.bs.modal', '#experienceModal', function() {
            clearValidation();
            // Small delay to ensure form is fully rendered
            setTimeout(initializeRealTimeValidation, 100);
        });

        // ========== END REAL-TIME VALIDATION SYSTEM ==========
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
        initWhenReady();
    }
})();
</script>
