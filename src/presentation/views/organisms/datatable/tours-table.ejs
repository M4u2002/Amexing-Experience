<%
/**
 * Tours DataTable Organism
 * DataTable component for tours management
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'tours-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/tours';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
%>

<div class="card border-0 shadow-sm">
  <div class="card-header text-white" style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); border: none;">
    <div class="row align-items-center">
      <div class="col">
        <h5 class="card-title mb-0 text-white">
          <i class="ti ti-map me-2"></i>Gestión de Tours
        </h5>
        <small class="text-white" style="opacity: 0.9;">Administra tours</small>
      </div>
      <div class="col-auto">
        <% if (canCreate) { %>
        <button type="button" class="btn btn-light btn-sm" id="createTourBtn">
          <i class="ti ti-plus me-1"></i>Nuevo Tour
        </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card-body border-bottom bg-light">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="filterRate-tours" class="form-label fw-semibold">
          <i class="ti ti-percentage me-1"></i>Filtrar por Tarifa
        </label>
        <select class="form-select" id="filterRate-tours">
          <option value="">Todas las tarifas</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
        <thead class="table-light">
          <tr>
            <th>Tarifa</th>
            <th>Destino</th>
            <th>Tiempo (Hrs min)</th>
            <th>Tipo de Vehículo</th>
            <th>Pasajeros</th>
            <th>Precio</th>
            <th>Precio Efectivo</th>
            <% if (dtUserRole !== 'department_manager') { %><th>Estado</th><% } %>
            <% if (dtShowActions) { %>
            <th class="text-center">Acciones</th>
            <% } %>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Tour Modal -->
<div class="modal fade" id="tourModal" tabindex="-1" aria-labelledby="tourModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title text-white" id="tourModalLabel">
          <i class="ti ti-map-plus me-2"></i><span id="modalTitle">Crear Nuevo Tour</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Alert container for modal-specific errors -->
        <div id="tourModalAlerts"></div>

        <form id="tourForm">
          <input type="hidden" id="tourId">

          <!-- Sección: Información del Tour -->
          <div class="mb-4">
            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
              <i class="ti ti-info-circle me-1"></i>
              Información del Tour
            </h6>

            <%- include('../../atoms/common/tom-select', {
                id: 'destinationPOI',
                name: 'destinationPOI',
                multiple: false,
                placeholder: 'Seleccionar destino',
                label: 'Destino',
                required: true,
                helpText: 'Punto de interés de destino para el tour',
                options: [],
                selected: []
            }) %>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="timeHours" class="form-label">Duración <span class="text-danger">*</span></label>
                <div class="row">
                  <div class="col-6">
                    <div class="input-group">
                      <input type="number" class="form-control" id="timeHours" name="timeHours" min="0" max="23" placeholder="0">
                      <span class="input-group-text">hrs</span>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="input-group">
                      <input type="number" class="form-control" id="timeMinutes" name="timeMinutes" min="0" max="59" placeholder="0">
                      <span class="input-group-text">min</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="vehicleType" class="form-label">Tipo de Vehículo <span class="text-danger">*</span></label>
                <select class="form-select" id="vehicleType" name="vehicleType" required>
                  <option value="">Seleccionar tipo de vehículo...</option>
                  <!-- Las opciones se cargarán dinámicamente -->
                </select>
              </div>
            </div>

            <!-- Sección: Rango de Pasajeros (Opcional) -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="minPassengers" class="form-label">Mínimo de Pasajeros <span class="text-muted">(Opcional)</span></label>
                <input type="number" class="form-control" id="minPassengers" name="minPassengers" min="1" placeholder="Ej: 2">
                <div class="form-text">Número mínimo de pasajeros requerido</div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="maxPassengers" class="form-label">Máximo de Pasajeros <span class="text-muted">(Opcional)</span></label>
                <input type="number" class="form-control" id="maxPassengers" name="maxPassengers" min="1" placeholder="Ej: 8">
                <div class="form-text">Número máximo de pasajeros permitido</div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="price" class="form-label">Precio <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="price" name="price" required min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="rate" class="form-label">Tarifa <span class="text-danger">*</span></label>
                <select class="form-select" id="rate" name="rate" required>
                  <option value="">Seleccionar tarifa...</option>
                  <!-- Las opciones se cargarán dinámicamente -->
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-12 mb-3">
                <label for="notes" class="form-label">Notas <span class="text-muted">(Opcional)</span></label>
                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Información adicional sobre el tour, instrucciones especiales, etc."></textarea>
                <div class="form-text">Información adicional o notas sobre el tour</div>
              </div>
            </div>
          </div>

          <!-- Sección: Disponibilidad (Opcional) -->
          <div class="mb-4">
            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
              <i class="ti ti-calendar-time me-1"></i>
              Disponibilidad <span class="text-muted fw-normal">(Opcional)</span>
            </h6>

            <div class="mb-3">
              <label class="form-label">Selecciona Días y Configura Horarios</label>
              <div class="d-flex gap-2 flex-wrap mb-3" id="availableDaysContainer">
                <button type="button" class="btn btn-outline-primary day-btn" data-day="1" data-day-name="Lunes">
                  <i class="ti ti-calendar"></i> Lu
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="2" data-day-name="Martes">
                  <i class="ti ti-calendar"></i> Ma
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="3" data-day-name="Miércoles">
                  <i class="ti ti-calendar"></i> Mi
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="4" data-day-name="Jueves">
                  <i class="ti ti-calendar"></i> Ju
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="5" data-day-name="Viernes">
                  <i class="ti ti-calendar"></i> Vi
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="6" data-day-name="Sábado">
                  <i class="ti ti-calendar"></i> Sa
                </button>
                <button type="button" class="btn btn-outline-primary day-btn" data-day="0" data-day-name="Domingo">
                  <i class="ti ti-calendar"></i> Do
                </button>
              </div>
              <div class="form-text">Selecciona días para configurar horarios individuales</div>
            </div>

            <!-- Contenedor de horarios por día -->
            <div id="daySchedulesContainer" class="mb-3">
              <div id="noDaysSelected" class="text-center text-muted py-4 border rounded bg-light">
                <i class="ti ti-calendar-off fs-3 d-block mb-2"></i>
                <p class="mb-0">Selecciona días para configurar sus horarios</p>
                <small class="text-muted">Cada día puede tener horarios diferentes</small>
              </div>
            </div>

            <div class="alert alert-info" role="alert">
              <i class="ti ti-info-circle me-2"></i>
              <small>Si no se especifica disponibilidad, el tour estará disponible todos los días sin restricción de horario</small>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="ti ti-x me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="saveTourBtn">
          <i class="ti ti-check me-1"></i><span id="saveButtonText">Crear Tour</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Template para fila de horario por día -->
<template id="dayScheduleRowTemplate">
  <div class="day-schedule-row mb-3 p-3 border rounded bg-light" data-day="">
    <div class="row align-items-center">
      <div class="col-md-3">
        <strong class="day-name text-primary">
          <i class="ti ti-calendar me-1"></i>
          <span></span>
        </strong>
      </div>
      <div class="col-md-4">
        <label class="form-label small mb-1">Hora de Inicio</label>
        <input type="text" class="form-control form-control-sm day-start-time time-input" placeholder="HH:MM" maxlength="5">
        <div class="invalid-feedback"></div>
      </div>
      <div class="col-md-4">
        <label class="form-label small mb-1">Hora de Fin</label>
        <input type="text" class="form-control form-control-sm day-end-time time-input" placeholder="HH:MM" maxlength="5">
        <div class="invalid-feedback"></div>
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-sm btn-outline-danger remove-day-btn" title="Eliminar día">
          <i class="ti ti-x"></i>
        </button>
      </div>
    </div>
  </div>
</template>

<script>
  (function() {
    // Wait for DOM and all dependencies to be ready
    function initWhenReady() {
      // Check if jQuery and DataTables are loaded
      if (typeof jQuery === 'undefined') {
        console.warn('jQuery not loaded yet, waiting...');
        setTimeout(initWhenReady, 100);
        return;
      }

      if (!jQuery.fn.dataTable) {
        console.warn('DataTables not loaded yet, waiting...');
        setTimeout(initWhenReady, 100);
        return;
      }

      // All dependencies loaded, initialize
      initToursTable();
    }

    function initToursTable() {
      const API = '<%= dtApiEndpoint %>';
      const userRole = '<%= dtUserRole %>';
      let table;
      let selectedDays = []; // Track selected days

      // Get JWT token from localStorage or cookies
      function getAccessToken() {
        // First try localStorage (used by other parts of the app)
        const tokenFromStorage = localStorage.getItem('accessToken');
        if (tokenFromStorage) {
          return tokenFromStorage;
        }
        
        // Fallback to cookies (httpOnly cookies won't work, but try anyway)
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'accessToken') {
            return value;
          }
        }
        return null;
      }

      // Setup global AJAX configuration to include JWT token
      $.ajaxSetup({
        beforeSend: function(xhr) {
          const token = getAccessToken();
          if (token) {
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
          }
        }
      });

      // Helper functions for badge color contrast
      function getLuminance(hex) {
        // WCAG 2.0 luminance calculation
        const rgb = parseInt(hex.slice(1), 16);
        const r = (rgb >> 16) & 0xff;
        const g = (rgb >> 8) & 0xff;
        const b = (rgb >> 0) & 0xff;

        const [rsRGB, gsRGB, bsRGB] = [r/255, g/255, b/255].map(val => {
          return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
        });

        return 0.2126 * rsRGB + 0.7152 * gsRGB + 0.0722 * bsRGB;
      }

      function getContrastTextColor(backgroundColor) {
        const luminance = getLuminance(backgroundColor);
        return luminance > 0.5 ? '#1F2937' : '#FFFFFF';
      }

      table = $('#<%= dtTableId %>').DataTable({
        processing: true,
        serverSide: true,
        deferRender: true,
        ajax: {
          url: API,
          type: 'GET',
          data: function(d) {
            // Add rate filter parameter
            d.rateId = $('#filterRate-tours').val();
            return d;
          },
          dataSrc: function(json) {
            if (!json.success) {
              showErrorAlert('Error al cargar los datos de tours: ' + (json.error || 'Error desconocido'));
              return [];
            }

            // Update total count display
            $('#total-tours-count').text(json.recordsTotal || 0);

            return json.data || [];
          },
          error: function(xhr, error, thrown) {
            console.error('Error loading tours:', error);
            showErrorAlert('Error al cargar los tours');
          }
        },
        columns: [
          // 0. Tarifa (moved to first position with badge styling)
          {
            data: 'rate.name',
            render: function(data, type, row) {
              if (!data) return '-';

              // Remove "Tarifa" word from the beginning if present
              let displayName = data.replace(/^Tarifa\s*/i, '');

              const color = row.rate?.color || '#6366F1';
              const textColor = getContrastTextColor(color);

              return `<span class="badge px-3 py-2" style="background-color: ${color}; color: ${textColor}; font-size: 0.875rem;">${displayName}</span>`;
            }
          },
          // 1. Destino
          {
            data: 'destinationPOI',
            render: function(data, type, row) {
              if (!data) return '-';
              return `<div><strong>${data.name || 'Sin destino'}</strong></div>`;
            }
          },
          // 2. Tiempo
          {
            data: 'time',
            render: function(data, type, row) {
              if (!data) return '-';
              const hours = Math.floor(data / 60);
              const minutes = data % 60;
              if (hours > 0 && minutes > 0) {
                return `${hours}h ${minutes}min`;
              } else if (hours > 0) {
                return `${hours}h`;
              } else {
                return `${minutes}min`;
              }
            }
          },
          // 3. Tipo de Vehículo
          {
            data: 'vehicleType',
            render: function(data, type, row) {
              if (!data) return '-';
              return data.name || 'Sin tipo';
            }
          },
          // 4. Pasajeros
          {
            data: null,
            render: function(data, type, row) {
              const minPassengers = row.minPassengers;
              const maxPassengers = row.maxPassengers;

              if (!minPassengers && !maxPassengers) {
                return '<span class="text-muted">Sin límite</span>';
              }

              if (minPassengers && maxPassengers) {
                return `${minPassengers} - ${maxPassengers} pax`;
              }

              if (minPassengers) {
                return `Mín: ${minPassengers} pax`;
              }

              if (maxPassengers) {
                return `Máx: ${maxPassengers} pax`;
              }

              return '-';
            }
          },
          // 5. Precio (with surcharge - "Tarjeta/Digital")
          {
            data: 'price',
            render: function(data, type, row) {
              const basePrice = data || 0;
              const surchargePercentage = window.APP_SETTINGS?.paymentSurchargePercentage || 21.09;
              const surcharge = (basePrice * surchargePercentage) / 100;
              const totalPrice = basePrice + surcharge;

              // For sorting and filtering, use total price
              if (type === 'sort' || type === 'filter') {
                return totalPrice;
              }

              const formatMXN = (amount) => new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
              }).format(amount);

              return `
                <div class="text-center">
                  <div class="fw-bold text-success" style="font-size: 1rem;">
                    ${formatMXN(totalPrice)}
                  </div>
                  <div class="text-muted" style="font-size: 0.75rem;">
                    <small>Tarjeta/Digital</small>
                  </div>
                </div>
              `;
            }
          },
          // 6. Precio Efectivo (base price - "Efectivo")
          {
            data: 'price',
            render: function(data, type, row) {
              const basePrice = data || 0;

              // For sorting and filtering, use base price
              if (type === 'sort' || type === 'filter') {
                return basePrice;
              }

              const formatMXN = (amount) => new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
              }).format(amount);

              return `
                <div class="text-center">
                  <div class="fw-bold text-primary" style="font-size: 1rem;">
                    ${formatMXN(basePrice)}
                  </div>
                  <div class="text-muted" style="font-size: 0.75rem;">
                    <small>Efectivo</small>
                  </div>
                </div>
              `;
            }
          },
          // 7. Estado
          ...(userRole !== 'department_manager' ? [{
            data: 'active',
            defaultContent: false,
            render: function(data, type, row) {
              if (data) {
                return '<span class="badge bg-success"><i class="ti ti-check me-1"></i>Activo</span>';
              } else {
                return '<span class="badge bg-danger"><i class="ti ti-x me-1"></i>Inactivo</span>';
              }
            }
          }] : []),
          <% if (dtShowActions) { %> {
            data: null,
            orderable: false,
            render: function(data, type, row) {
              let actions = '<div class="btn-group btn-group-sm" role="group">';

              <% if (canEdit) { %>
              /* Edit button */
              actions += `<button type="button"
                                class="btn btn-primary edit-btn"
                                data-id="${row.id || row.objectId}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Editar">
                                <i class="ti ti-edit"></i>
                            </button>`;
              <% } %>

              <% if (canEdit) { %>
              /* Toggle status button */
              const statusIcon = row.active ? 'ti-eye-off' : 'ti-eye-check';
              const statusTitle = row.active ? 'Desactivar' : 'Activar';
              const statusClass = row.active ? 'btn-warning' : 'btn-success';

              actions += `<button type="button"
                                class="btn ${statusClass} toggle-btn"
                                data-id="${row.id || row.objectId}"
                                data-active="${row.active}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="${statusTitle}">
                                <i class="ti ${statusIcon}"></i>
                            </button>`;
              <% } %>

              <% if (canDelete) { %>
              /* Delete button */
              actions += `<button type="button"
                                class="btn btn-danger delete-btn"
                                data-id="${row.id || row.objectId}"
                                data-tour-name="${row.destinationPOI?.name || 'Tour'}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Eliminar">
                                <i class="ti ti-trash"></i>
                            </button>`;
              <% } %>

              actions += '</div>';
              return actions;
            }
          }
          <% } %>
        ],
        pageLength: 25,
        lengthMenu: [
          [10, 25, 50, 100],
          [10, 25, 50, 100]
        ],
        order: [
          [0, 'asc'], // 1. Tarifa
          [1, 'asc']  // 2. Destino
        ],
        pagingType: 'full_numbers',
        language: {
          processing: "Procesando...",
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ registros",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 a 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros totales)",
          loadingRecords: "Cargando...",
          zeroRecords: "No se encontraron registros coincidentes",
          emptyTable: "No hay datos disponibles en la tabla",
          paginate: {
            first: "Primero",
            previous: "Anterior",
            next: "Siguiente",
            last: "Último"
          }
        },
        drawCallback: function(settings) {
          // Reinitialize tooltips after table redraw
          const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
      });

      // Day selection handling
      function initializeDaySelection() {
        $('.day-btn').removeClass('active btn-primary').addClass('btn-outline-primary');

        // Clear day schedules
        $('#daySchedulesContainer .day-schedule-row').remove();
        daySchedules = {};
        updateNoDaysMessage();

        // Legacy support
        selectedDays = [];
      }

      // Object to store day schedules
      let daySchedules = {};

      // Handle day button clicks
      $(document).on('click', '.day-btn', function() {
        const dayCode = parseInt($(this).data('day'));
        const dayName = $(this).data('day-name');
        const isSelected = $(this).hasClass('active');

        if (isSelected) {
          // Deselect: Remove day schedule
          removeDaySchedule(dayCode);
          $(this).removeClass('active btn-primary').addClass('btn-outline-primary');
        } else {
          // Select: Add day schedule
          addDaySchedule(dayCode, dayName);
          $(this).removeClass('btn-outline-primary').addClass('active btn-primary');
        }

        updateNoDaysMessage();
      });

      // Add day schedule row
      function addDaySchedule(dayCode, dayName, startTime = '', endTime = '') {
        // Check if already exists
        if (daySchedules[dayCode]) return;

        // Clone template
        const template = document.getElementById('dayScheduleRowTemplate');
        const clone = template.content.cloneNode(true);
        const row = clone.querySelector('.day-schedule-row');

        // Set day code and name
        row.setAttribute('data-day', dayCode);
        row.querySelector('.day-name span').textContent = dayName;

        // Set initial values if provided
        if (startTime) row.querySelector('.day-start-time').value = startTime;
        if (endTime) row.querySelector('.day-end-time').value = endTime;

        // Add to container (sorted by day code)
        insertDayScheduleSorted(row, dayCode);

        // Store in daySchedules object
        daySchedules[dayCode] = {
          dayName: dayName,
          element: row
        };

        // Attach time validation to inputs
        attachTimeInputValidation(row.querySelector('.day-start-time'));
        attachTimeInputValidation(row.querySelector('.day-end-time'));
      }

      // Insert day schedule row in chronological order (Mon-Sun)
      function insertDayScheduleSorted(row, dayCode) {
        const container = $('#daySchedulesContainer');
        const existingRows = container.find('.day-schedule-row');

        // Convert day code for sorting (Sunday = 7 for sorting purposes)
        const sortValue = dayCode === 0 ? 7 : dayCode;

        let inserted = false;
        existingRows.each(function() {
          const existingDayCode = parseInt($(this).attr('data-day'));
          const existingSortValue = existingDayCode === 0 ? 7 : existingDayCode;

          if (sortValue < existingSortValue) {
            $(this).before(row);
            inserted = true;
            return false; // Break loop
          }
        });

        if (!inserted) {
          container.append(row);
        }
      }

      // Remove day schedule row
      function removeDaySchedule(dayCode) {
        if (!daySchedules[dayCode]) return;

        // Remove from DOM
        $(daySchedules[dayCode].element).remove();

        // Remove from daySchedules object
        delete daySchedules[dayCode];
      }

      // Handle remove day button clicks
      $(document).on('click', '.remove-day-btn', function() {
        const row = $(this).closest('.day-schedule-row');
        const dayCode = parseInt(row.attr('data-day'));

        // Deselect day button
        $(`.day-btn[data-day="${dayCode}"]`).removeClass('active btn-primary').addClass('btn-outline-primary');

        // Remove schedule
        removeDaySchedule(dayCode);
        updateNoDaysMessage();
      });

      // Update "no days selected" message visibility
      function updateNoDaysMessage() {
        const hasDays = Object.keys(daySchedules).length > 0;
        $('#noDaysSelected').toggle(!hasDays);
      }

      // Time input validation and formatting
      function attachTimeInputValidation(input) {
        const $input = $(input);

        $input.on('input', function() {
          let value = $(this).val().replace(/[^0-9]/g, ''); // Remove non-digits

          // Auto-format: add ":" after 2 digits
          if (value.length >= 2) {
            value = value.substring(0, 2) + ':' + value.substring(2, 4);
          }

          $(this).val(value);
        });

        $input.on('blur', function() {
          const value = $(this).val();
          if (!value) return;

          // Validate format HH:MM (00:00 to 23:59)
          const timeRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;
          if (!timeRegex.test(value)) {
            $(this).addClass('is-invalid');
            showModalError('Formato de hora inválido. Use HH:MM (00:00 a 23:59)');
          } else {
            $(this).removeClass('is-invalid');
          }
        });
      }

      // Attach time validation to time inputs
      $(document).on('focus', '.time-input', function() {
        if (!$(this).data('validation-attached')) {
          attachTimeInputValidation(this);
          $(this).data('validation-attached', true);
        }
      });

      // Load dropdown options when modal opens
      function loadDropdownOptions() {
        // Load Active POIs (filtered by Tours service type)
        $.ajax({
          url: '/api/pois/active?serviceType=Tours',
          type: 'GET',
          success: function(data) {
            if (data.success && data.data) {
              const selectElement = document.getElementById('destinationPOI');

              // Destroy existing Tom Select instance if it exists
              if (selectElement && selectElement.tomselect) {
                selectElement.tomselect.destroy();
              }

              // Clear the select element
              const select = $('#destinationPOI');
              select.empty();

              // Initialize Tom Select first (on empty select)
              if (typeof TomSelect !== 'undefined') {
                const tomSelectInstance = new TomSelect('#destinationPOI', {
                  plugins: [],
                  maxOptions: 1000,
                  placeholder: 'Seleccionar destino',
                  maxItems: 1,
                  highlight: true,
                  searchField: ['text'],
                  valueField: 'value',
                  labelField: 'text',
                  sortField: 'text',
                  closeAfterSelect: true,
                  persist: false
                });

                // Store instance reference
                selectElement.tomselect = tomSelectInstance;

                // Load options using Tom Select API (prevents auto-selection)
                tomSelectInstance.clearOptions();
                data.data.forEach(poi => {
                  tomSelectInstance.addOption({ value: poi.value, text: poi.label });
                });
                tomSelectInstance.refreshOptions(false);
                tomSelectInstance.clear(); // Clear selection to start empty
              }
            }
          },
          error: function(xhr, status, error) {
            console.error('Error loading POIs for Tours:', error);
          }
        });

        // Load Active Vehicle Types
        $.ajax({
          url: '/api/vehicle-types/active',
          type: 'GET',
          success: function(data) {
            if (data.success && data.data) {
              const select = $('#vehicleType');
              select.empty().append('<option value="">Seleccionar tipo de vehículo...</option>');
              data.data.forEach(vt => {
                select.append(`<option value="${vt.value}">${vt.label}</option>`);
              });
            }
          },
          error: function(xhr, status, error) {
            console.error('Error loading vehicle types:', error);
          }
        });

        // Load Active Rates
        $.ajax({
          url: '/api/rates/active',
          type: 'GET',
          success: function(data) {
            if (data.success && data.data) {
              const select = $('#rate');
              select.empty().append('<option value="">Seleccionar tarifa...</option>');
              data.data.forEach(rate => {
                select.append(`<option value="${rate.value}">${rate.label}</option>`);
              });
            }
          },
          error: function(xhr, status, error) {
            console.error('Error loading rates:', error);
          }
        });
      }

      $('#<%= dtTableId %>').on('click', '.edit-btn', function() {
        const id = $(this).data('id');
        loadDropdownOptions(); // Load dropdown options first

        $.ajax({
          url: `${API}/${id}`,
          type: 'GET',
          success: function(data) {
            if (data.success) {
              const t = data.data.tour;
              $('#tourId').val(t.id || t.objectId);

              // Set POI destination (wait for Tom Select to initialize)
              setTimeout(() => {
                const destinationValue = t.destinationPOI?.objectId || t.destinationPOI?.id || '';
                const selectElement = document.getElementById('destinationPOI');

                if (selectElement && selectElement.tomselect) {
                  // Use Tom Select API to set value
                  selectElement.tomselect.setValue(destinationValue, true);
                } else {
                  // Fallback to jQuery if Tom Select not initialized
                  $('#destinationPOI').val(destinationValue);
                }
              }, 500);

              // Set time (convert from minutes to hours and minutes)
              const totalMinutes = t.time || 0;
              const hours = Math.floor(totalMinutes / 60);
              const minutes = totalMinutes % 60;
              $('#timeHours').val(hours);
              $('#timeMinutes').val(minutes);

              // Set vehicle type
              setTimeout(() => {
                $('#vehicleType').val(t.vehicleType?.objectId || t.vehicleType?.id || '');
              }, 500);

              $('#price').val(t.price || '');

              // Set passenger range
              $('#minPassengers').val(t.minPassengers || '');
              $('#maxPassengers').val(t.maxPassengers || '');

              // Set notes
              $('#notes').val(t.notes || '');

              // Set rate
              setTimeout(() => {
                $('#rate').val(t.rate?.objectId || t.rate?.id || '');
              }, 500);

              // Set availability (NEW FORMAT: array of day schedules)
              initializeDaySelection();
              if (t.availability && Array.isArray(t.availability) && t.availability.length > 0) {
                // Load day schedules from new format
                t.availability.forEach(schedule => {
                  const dayBtn = $(`.day-btn[data-day="${schedule.day}"]`);
                  const dayName = dayBtn.data('day-name');

                  // Add day schedule with times
                  addDaySchedule(schedule.day, dayName, schedule.startTime, schedule.endTime);

                  // Activate day button
                  dayBtn.removeClass('btn-outline-primary').addClass('active btn-primary');
                });

                updateNoDaysMessage();
              } else if (t.availableDays && Array.isArray(t.availableDays) && t.availableDays.length > 0) {
                // LEGACY FORMAT: Migrate to new format (all days share same times)
                const sharedStartTime = t.startTime || '';
                const sharedEndTime = t.endTime || '';

                t.availableDays.forEach(dayCode => {
                  const dayBtn = $(`.day-btn[data-day="${dayCode}"]`);
                  const dayName = dayBtn.data('day-name');

                  // Add day schedule with shared times
                  addDaySchedule(dayCode, dayName, sharedStartTime, sharedEndTime);

                  // Activate day button
                  dayBtn.removeClass('btn-outline-primary').addClass('active btn-primary');
                });

                updateNoDaysMessage();
              }

              $('#modalTitle').text('Editar Tour');
              $('#saveButtonText').text('Actualizar Tour');

              // Clear any previous modal alerts
              const alertsContainer = document.getElementById('tourModalAlerts');
              if (alertsContainer) {
                alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
              }

              $('#tourModal').modal('show');
            }
          },
          error: function(xhr) {
            showModalError(xhr.responseJSON?.error || 'Error al cargar el tour');
          }
        });
      });

      $('#createTourBtn').click(() => {
        // Clear any previous modal alerts
        const alertsContainer = document.getElementById('tourModalAlerts');
        if (alertsContainer) {
          alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
        }

        loadDropdownOptions(); // Load dropdown options
        $('#tourForm')[0].reset();
        $('#tourId').val('');
        initializeDaySelection(); // Reset day selection (clears daySchedules too)
        $('#modalTitle').text('Crear Nuevo Tour');
        $('#saveButtonText').text('Crear Tour');
        $('#tourModal').modal('show');
      });

      $('#saveTourBtn').click(function() {
        const id = $('#tourId').val();

        // Calculate total time in minutes
        const hours = parseInt($('#timeHours').val()) || 0;
        const minutes = parseInt($('#timeMinutes').val()) || 0;
        const totalMinutes = (hours * 60) + minutes;

        const data = {
          destinationPOI: $('#destinationPOI').val(),
          time: totalMinutes,
          vehicleType: $('#vehicleType').val(),
          price: parseFloat($('#price').val()) || 0,
          rate: $('#rate').val()
        };

        // Add optional passenger range fields
        const minPassengers = $('#minPassengers').val();
        const maxPassengers = $('#maxPassengers').val();
        
        if (minPassengers && minPassengers.trim() !== '') {
          data.minPassengers = parseInt(minPassengers);
        }
        
        if (maxPassengers && maxPassengers.trim() !== '') {
          data.maxPassengers = parseInt(maxPassengers);
        }

        // Add optional notes field
        const notes = $('#notes').val();
        if (notes && notes.trim() !== '') {
          data.notes = notes.trim();
        }

        // Add optional availability fields (NEW FORMAT: array of day schedules)
        if (Object.keys(daySchedules).length > 0) {
          const availability = [];
          const timeRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/;

          // Collect and validate each day schedule
          for (const dayCode in daySchedules) {
            const scheduleRow = $(daySchedules[dayCode].element);
            const startTime = scheduleRow.find('.day-start-time').val();
            const endTime = scheduleRow.find('.day-end-time').val();
            const dayName = daySchedules[dayCode].dayName;

            // Validate both times are provided
            if (!startTime || !endTime) {
              showModalError(`Debe especificar hora de inicio y fin para ${dayName}`);
              return;
            }

            // Validate time format
            if (!timeRegex.test(startTime)) {
              showModalError(`Formato de hora de inicio inválido para ${dayName}. Use HH:MM (00:00 a 23:59)`);
              return;
            }
            if (!timeRegex.test(endTime)) {
              showModalError(`Formato de hora de fin inválido para ${dayName}. Use HH:MM (00:00 a 23:59)`);
              return;
            }

            // Validate endTime > startTime
            if (startTime >= endTime) {
              showModalError(`La hora de fin debe ser posterior a la hora de inicio para ${dayName}`);
              return;
            }

            // Add to availability array
            availability.push({
              day: parseInt(dayCode),
              startTime: startTime,
              endTime: endTime
            });
          }

          // Add availability array to data (sorted by day code happens on backend)
          data.availability = availability;
        }

        // Validate required fields
        if (!data.destinationPOI || !data.time || !data.vehicleType || !data.price || !data.rate) {
          showModalError('Por favor completa todos los campos requeridos');
          return;
        }

        if (data.time <= 0) {
          showModalError('La duración debe ser mayor a 0 minutos');
          return;
        }

        $.ajax({
          url: id ? `${API}/${id}` : API,
          type: id ? 'PUT' : 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function(result) {
            if (result.success) {
              showSuccessAlert(`Tour ${id?'actualizado':'creado'} exitosamente`);
              $('#tourModal').modal('hide');
              table.ajax.reload(null, false);
            } else {
              showModalError(result.error || 'Error al guardar el tour');
            }
          },
          error: function(xhr) {
            showModalError(xhr.responseJSON?.error || 'Error al guardar el tour');
          }
        });
      });

      $('#<%= dtTableId %>').on('click', '.toggle-btn', function() {
        const id = $(this).data('id');
        const active = $(this).data('active');
        toggleTourStatus(id, active);
      });

      $('#<%= dtTableId %>').on('click', '.delete-btn', function() {
        const id = $(this).data('id');
        const name = $(this).data('tour-name');
        deleteTour(id, name);
      });

      function toggleTourStatus(tourId, currentStatus) {
        const newStatus = !currentStatus;
        const action = newStatus ? 'activar' : 'desactivar';
        const actionTitle = newStatus ? 'Activar' : 'Desactivar';
        const btnClass = newStatus ? 'btn-success' : 'btn-warning';

        const modalHtml = `
            <div class="modal fade" id="confirmToggleTourModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${actionTitle} Tour</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>¿Estás seguro de que deseas ${action} este tour?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn ${btnClass}" id="confirmToggleTourBtn">${actionTitle}</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        $('#confirmToggleTourModal').remove();
        $('body').append(modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('confirmToggleTourModal'));
        modal.show();

        // Handle confirmation
        $('#confirmToggleTourBtn').on('click', function() {
          $.ajax({
            url: `${API}/${tourId}/toggle-status`,
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({
              active: newStatus
            }),
            success: function(result) {
              if (result.success) {
                modal.hide();
                table.ajax.reload(null, false);
                showSuccessAlert(`Tour ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
              } else {
                modal.hide();
                showErrorAlert(result.error || 'Error al cambiar el estado del tour');
              }
            },
            error: function(xhr) {
              modal.hide();
              const errorMsg = xhr.responseJSON?.error || 'Error al cambiar el estado del tour';
              showErrorAlert(errorMsg);
            }
          });
        });
      }

      function deleteTour(tourId, tourName) {
        const modalHtml = `
            <div class="modal fade" id="confirmDeleteTourModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Eliminar Tour</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>¿Estás seguro de que deseas eliminar el tour <strong>"${tourName}"</strong>?</p>
                            <p class="text-muted mb-0">Esta acción se puede revertir.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteTourBtn">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        $('#confirmDeleteTourModal').remove();

        // Add modal to body
        $('body').append(modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteTourModal'));
        modal.show();

        // Handle confirmation
        $('#confirmDeleteTourBtn').on('click', function() {
          $.ajax({
            url: `${API}/${tourId}`,
            type: 'DELETE',
            success: function(result) {
              if (result.success) {
                modal.hide();
                table.ajax.reload(null, false);
                showSuccessAlert(`Tour "${tourName}" eliminado exitosamente`);
              } else {
                modal.hide();
                showErrorAlert(result.error || 'Error al eliminar el tour');
              }
            },
            error: function(xhr) {
              modal.hide();
              const error = xhr.responseJSON?.error || 'Error al eliminar el tour';
              showErrorAlert(error);
            }
          });
        });
      }

      function showModalError(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="ti ti-alert-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        const container = document.getElementById('tourModalAlerts');
        if (container) {
          container.querySelectorAll('.alert').forEach(el => el.remove());
          container.insertAdjacentHTML('afterbegin', alertHtml);

          setTimeout(() => {
            container.querySelectorAll('.alert').forEach(el => {
              el.classList.remove('show');
              setTimeout(() => el.remove(), 150);
            });
          }, 8000);
        }
      }

      // Load rates for filter dropdown
      function loadRatesFilter() {
        $.ajax({
          url: '/api/rates/active',
          type: 'GET',
          success: function(response) {
            if (response.success && response.data) {
              const select = $('#filterRate-tours');
              select.find('option:not(:first)').remove();
              response.data.forEach(function(rate) {
                const option = $('<option></option>')
                  .attr('value', rate.value)
                  .text(rate.label)
                  .attr('data-color', rate.color || '#6366F1');
                select.append(option);
              });
            }
          },
          error: function(xhr, status, error) {
            console.error('Error loading rates for filter:', error);
          }
        });
      }

      // Reload DataTable when filter changes
      $('#filterRate-tours').on('change', function() {
        table.ajax.reload();
      });

      // Load rates on page load
      loadRatesFilter();

      function showSuccessAlert(message) {
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="ti ti-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        document.querySelectorAll('.alert').forEach(el => el.remove());
        const cardBody = document.querySelector('#<%= dtTableId %>').closest('.card-body');
        cardBody.insertAdjacentHTML('afterbegin', alertHtml);
        setTimeout(() => {
          document.querySelectorAll('.alert').forEach(el => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 150);
          });
        }, 5000);
      }

      function showErrorAlert(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="ti ti-alert-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        document.querySelectorAll('.alert').forEach(el => el.remove());
        const cardBody = document.querySelector('#<%= dtTableId %>').closest('.card-body');
        cardBody.insertAdjacentHTML('afterbegin', alertHtml);
      }
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
      // DOM already loaded
      initWhenReady();
    }
  })();
</script>