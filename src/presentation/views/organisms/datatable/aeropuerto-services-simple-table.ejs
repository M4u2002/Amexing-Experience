<%
/**
 * Simple Aeropuerto Services DataTable Organism
 * Simplified DataTable component for aeropuerto transportation services from Services table
 * Shows only: Ruta, Tipo de Vehículo, Notas, Estado y Acciones
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'aeropuerto-services-simple-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/services-new?filterAeropuerto=true';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
%>

<style>
/* Hide default DataTables sorting icons for the price column */
.dt-control::before,
.dt-control::after {
    display: none !important;
}

/* Custom styling for price column */
.price-expand-container {
    text-align: left;
}

/* Hide any default sorting indicators on the price column */
table.dataTable thead .sorting::before,
table.dataTable thead .sorting::after,
table.dataTable thead .sorting_asc::before,
table.dataTable thead .sorting_asc::after,
table.dataTable thead .sorting_desc::before,
table.dataTable thead .sorting_desc::after {
    display: none !important;
}

/* Ensure only our button shows */
td.dt-control {
    position: relative;
}

/* Remove DataTables default row hover effect */
table.dataTable tbody tr:hover,
table.dataTable tbody tr.hover {
    background-color: transparent !important;
}

/* Add hover effect specifically to expand button */
.expand-btn:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
    border-radius: 4px !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

.expand-btn:hover i,
.expand-btn:hover small {
    color: #0d6efd !important;
}

/* Smooth transition for expand button */
.expand-btn {
    transition: all 0.2s ease;
}

/* Custom styling for nav pills with borders */
.nav-pills .nav-link {
    border: 1px solid #dee2e6;
    color: #6c757d;
    background-color: transparent;
    margin-right: 0.25rem;
    transition: all 0.2s ease;
}

.nav-pills .nav-link:hover {
    border-color: #10b981;
    color: #10b981;
    background-color: rgba(16, 185, 129, 0.1);
}

.nav-pills .nav-link.active {
    border-color: #10b981;
    background-color: #10b981;
    color: white;
}
</style>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    Traslados
                </h5>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" id="createServiceBtn">
                        <i class="ti ti-plus me-1"></i>Nuevo Traslado
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body" id="services-content">
        <!-- Filter Controls -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Leading Pills (Segmented Control) -->
            <ul class="nav nav-pills" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="aeropuerto-tab" data-bs-toggle="pill" data-bs-target="#aeropuerto" type="button" role="tab" aria-controls="aeropuerto" aria-selected="true">
                        Aeropuerto
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="punto-a-punto-tab" data-bs-toggle="pill" data-bs-target="#punto-a-punto" type="button" role="tab" aria-controls="punto-a-punto" aria-selected="false">
                        Punto a Punto
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="local-tab" data-bs-toggle="pill" data-bs-target="#local" type="button" role="tab" aria-controls="local" aria-selected="false">
                        Local
                    </button>
                </li>
            </ul>

            <!-- Trailing Dropdowns -->
            <div class="d-flex gap-2 align-items-center">
                <!-- Currency Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="currencyFilter" class="form-label mb-0 text-muted">Precio:</label>
                    <select class="form-select" id="currencyFilter" style="min-width: 100px;">
                        <option value="MXN" selected>MXN</option>
                        <option value="USD">USD</option>
                    </select>
                </div>

                <!-- Payment Type Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="paymentTypeFilter" class="form-label mb-0 text-muted">Pago:</label>
                    <select class="form-select" id="paymentTypeFilter" style="min-width: 140px;">
                        <option value="efectivo" selected>Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%;">Ruta</th>
                        <th style="width: 15%;">Tipo de Vehículo</th>
                        <th style="width: 20%;">
                            <select class="form-select" id="headerRateFilter" style="min-width: 180px; width: 100%;">
                                <option value="">Seleccionar categoría...</option>
                            </select>
                        </th>
                        <th style="width: 20%;">Notas</th>
                        <th style="width: 10%;">Estado</th>
                        <% if (dtShowActions) { %>
                            <th class="text-center" style="width: 10%;">Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Service Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="serviceModalLabel">
                    <i class="ti ti-briefcase me-2"></i><span id="modalTitle">Crear Nuevo Traslado</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Alert container for modal-specific errors -->
                <div id="serviceModalAlerts"></div>

                <form id="serviceForm">
                    <input type="hidden" id="serviceId">

                    <!-- Sección: Información de Ruta -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-route me-1"></i>
                            Información de Ruta
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <%- include('../../atoms/common/tom-select', {
                                    id: 'originPOI',
                                    name: 'originPOI',
                                    multiple: false,
                                    placeholder: 'Seleccionar origen',
                                    label: 'Origen',
                                    required: true,
                                    helpText: 'Aeropuerto de origen (requerido)',
                                    options: [],
                                    selected: []
                                }) %>
                            </div>

                            <div class="col-md-6 mb-3">
                                <%- include('../../atoms/common/tom-select', {
                                    id: 'destinationPOI',
                                    name: 'destinationPOI',
                                    multiple: false,
                                    placeholder: 'Seleccionar destino',
                                    label: 'Destino',
                                    required: true,
                                    helpText: 'Punto final del traslado',
                                    options: [],
                                    selected: []
                                }) %>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Información del Vehículo -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-car me-1"></i>
                            Información del Vehículo
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vehicleType" class="form-label">Tipo de Vehículo <span class="text-danger">*</span></label>
                                <select class="form-select" id="vehicleType" name="vehicleType" required>
                                    <option value="">Seleccionar tipo de vehículo</option>
                                </select>
                                <div class="form-text">Tipo de vehículo asignado para esta ruta</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="rate" class="form-label">Tarifa <span class="text-danger">*</span></label>
                                <select class="form-select" id="rate" name="rate" required>
                                    <option value="">Seleccionar tarifa</option>
                                </select>
                                <div class="form-text">Tarifa aplicable para esta ruta</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Notas Adicionales -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-notes me-1"></i>
                            Notas Adicionales
                        </h6>

                        <div class="mb-3">
                            <label for="note" class="form-label">Nota</label>
                            <textarea class="form-control" id="note" name="note" rows="3" maxlength="500" placeholder="Notas adicionales sobre el traslado..."></textarea>
                            <div class="form-text">Máximo 500 caracteres (opcional)</div>
                        </div>
                    </div>

                    <!-- Alert informativo -->
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                        <div>
                            <strong>Traslado Simplificado:</strong>
                            <p class="mb-0 mt-1">Define una ruta específica con origen, destino y tipo de vehículo. Los precios se manejan por separado en el sistema de tarifas.</p>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveServiceBtn">
                    <i class="ti ti-check me-1"></i><span id="saveButtonText">Crear Traslado</span>
                </button>
            </div>

            <%- include('../../atoms/common/modal-loader', { text: 'Cargando datos del traslado...' }) %>
        </div>
    </div>
</div>

<script>
/* Cache buster and debug marker - timestamp: <%= Date.now() %> */
console.log('=== SERVICES DATATABLE SCRIPT LOADED ===');
console.log('Timestamp:', new Date().toISOString());
console.log('Cache buster active to force browser refresh');
console.log('==========================================');

(function() {
    // Wait for DOM and all dependencies to be ready
    function initWhenReady() {
        // Check if jQuery and DataTables are loaded
        if (typeof jQuery === 'undefined') {
            console.warn('jQuery not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        if (!jQuery.fn.dataTable) {
            console.warn('DataTables not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        initServicesTable();
    }

    function initServicesTable() {
        const tableId = '<%= dtTableId %>';
        const apiEndpoint = '<%= dtApiEndpoint %>';
        const showActions = <%= dtShowActions || false %>;
        const jsCanEdit = <%= canEdit || false %>;
        const jsCanDelete = <%= canDelete || false %>;
        const userRole = '<%= dtUserRole %>';

        // Get JWT token from cookies
        function getAccessToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'accessToken') {
                    return value;
                }
            }
            return null;
        }

        // Setup global AJAX configuration to include JWT token
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAccessToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            }
        });

        // Load dropdown data
        let poisData = [];
        let vehicleTypesData = [];
        let ratesData = [];

        // DataTable Configuration
        const dataTable = $(`#${tableId}`).DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: apiEndpoint,
                type: 'GET',
                dataSrc: function(json) {
                    return json.data || [];
                },
                error: function(xhr, error, thrown) {
                    console.error('Error in getServices - Full Details:', {
                        xhr: xhr,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        responseJSON: xhr.responseJSON,
                        error: error,
                        thrown: thrown,
                        url: apiEndpoint
                    });
                    showErrorAlert('Error al cargar los traslados: ' + (xhr.responseJSON?.error || error || 'Unknown error'));
                }
            },
            columns: [
                // 1. Ruta (Origen → Destino)
                {
                    data: null,
                    render: function(data, type, row) {
                        const origin = row.originPOI?.name || '-';
                        const destination = row.destinationPOI?.name || '-';

                        // Para búsqueda y ordenamiento, retornar texto plano
                        if (type === 'filter' || type === 'sort') {
                            return `${origin} ${destination}`;
                        }

                        // Para display, retornar HTML visual
                        return `
                            <div class="d-flex flex-column align-items-start gap-1" style="min-width: 200px;">
                                <span class="fw-medium text-success" style="font-size: 0.875rem;">
                                    <i class="ti ti-plane me-1"></i>${origin}
                                </span>
                                <div class="text-center w-100">
                                    <i class="ti ti-arrow-down text-primary" style="font-size: 1.25rem;"></i>
                                </div>
                                <span class="fw-medium text-info" style="font-size: 0.875rem;">
                                    <i class="ti ti-map-pin me-1"></i>${destination}
                                </span>
                            </div>
                        `;
                    }
                },
                // 2. Tipo de Vehículo
                {
                    data: 'vehicleType.name',
                    render: function(data) {
                        return `<span class="badge bg-dark">${data || '-'}</span>`;
                    }
                },
                // 3. Precio con botón expandir
                {
                    className: 'dt-control text-center',
                    data: 'rate.id',
                    orderable: false,
                    render: function(data, type, row) {
                        // For search functionality, return the rate ID
                        if (type === 'filter' || type === 'sort') {
                            return row.rate ? row.rate.id : '';
                        }

                        // For display, show price and expand button below
                        // Use a unique ID based on service ID to update later
                        // Try multiple ways to get the service ID from the row
                        let serviceId = row.id || row.objectId;
                        
                        // If still undefined, try other possible paths
                        if (!serviceId || serviceId === 'undefined') {
                            // Check if row is nested inside DT_RowData
                            serviceId = row.DT_RowId || 
                                       (row.DT_RowData && row.DT_RowData.id) ||
                                       (row._id) ||
                                       (row.originPOI && row.originPOI.id) || // Fallback to POI ID
                                       'unknown';
                        }
                        
                        const priceId = `price-${serviceId}`;
                        const timestamp = Date.now(); // Cache buster for debugging
                        
                        // Enhanced debug logging - now conditional
                        if (!serviceId || serviceId === 'undefined' || serviceId === 'unknown') {
                            console.error(`=== DataTable Row Debug - SERVICE ID ERROR @ ${timestamp} ===`);
                            console.error('Full row object:', row);
                            console.error('Available keys:', Object.keys(row));
                            console.error('row.id:', row.id);
                            console.error('row.objectId:', row.objectId);
                            console.error('row.DT_RowId:', row.DT_RowId);
                            console.error('row.DT_RowData:', row.DT_RowData);
                            console.error('row._id:', row._id);
                            console.error('Final computed serviceId:', serviceId);
                            console.error('===================================================');
                        } else {
                            // Always log successful ID extraction for now to debug what's working
                            console.log(`✅ Service ID extracted successfully @ ${timestamp}:`, serviceId);
                        }
                        
                        // Set up the price display container
                        const priceContainer = `
                            <div class="price-expand-container">
                                <div class="fw-bold text-primary fs-5 mb-1" id="${priceId}">
                                    <small class="text-muted">Cargando...</small>
                                </div>
                                <button class="btn btn-sm expand-btn d-flex align-items-center gap-1" style="border: none; background: transparent; padding: 2px 6px;">
                                    <i class="ti ti-chevron-down text-muted"></i>
                                    <small class="text-muted">Ver todas</small>
                                </button>
                            </div>
                        `;

                        // Fetch pricing data asynchronously - only if we have a valid ID
                        if (serviceId && serviceId !== 'undefined' && serviceId !== 'unknown') {
                            setTimeout(() => fetchServicePrice(serviceId, priceId), 0);
                        } else {
                            // Set error state immediately for invalid IDs
                            setTimeout(() => {
                                const element = $(`#${priceId}`);
                                if (element.length) {
                                    element.html('<span class="text-danger small">ID Error</span>');
                                }
                            }, 100);
                        }
                        
                        return priceContainer;
                    }
                },
                // 4. Notas
                {
                    data: 'note',
                    render: function(data) {
                        if (!data) return '<span class="text-muted">-</span>';
                        // Truncar si es muy largo
                        const truncated = data.length > 50 ? data.substring(0, 50) + '...' : data;
                        return `<div class="small" title="${data}">${truncated}</div>`;
                    }
                },
                // 5. Estado
                {
                    data: 'active',
                    render: function(data) {
                        return data
                            ? '<span class="badge bg-success">Activo</span>'
                            : '<span class="badge bg-secondary">Inactivo</span>';
                    }
                },
                // 6. Acciones
                ...(showActions ? [{
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: function(data) {
                        let actions = '<div class="btn-group btn-group-sm" role="group">';

                        if (jsCanEdit) {
                            // Edit button
                            actions += `<button type="button"
                                            class="btn btn-primary edit-service-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Editar Traslado">
                                            <i class="ti ti-edit"></i>
                                        </button>`;

                            // Toggle status button
                            const statusIcon = data.active ? 'ti-archive' : 'ti-archive-off';
                            const statusTitle = data.active ? 'Desactivar Traslado' : 'Activar Traslado';
                            const statusClass = data.active ? 'btn-warning' : 'btn-success';

                            actions += `<button type="button"
                                            class="btn ${statusClass} toggle-status-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-current-status="${data.active}"
                                            data-origin="${data.originPOI?.name}"
                                            data-destination="${data.destinationPOI?.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="${statusTitle}">
                                            <i class="ti ${statusIcon}"></i>
                                        </button>`;
                        }

                        if (jsCanDelete) {
                            // Delete button
                            actions += `<button type="button"
                                            class="btn btn-danger delete-service-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-origin="${data.originPOI?.name}"
                                            data-destination="${data.destinationPOI?.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Eliminar Traslado">
                                            <i class="ti ti-trash"></i>
                                        </button>`;
                        }

                        actions += '</div>';
                        return actions;
                    }
                }] : [])
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando traslados...'
            },
            order: [
                [0, 'asc'],  // Ruta
                [1, 'asc']   // Tipo de Vehículo
            ],
            pageLength: 10,
            searchDelay: 300,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            drawCallback: function() {
                // Reinitialize tooltips after table redraw
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // Populate rate dropdowns in each row
                populateRateDropdowns();
            }
        });

        // Load POIs and VehicleTypes for dropdowns
        loadDropdownData();

        // Add expand/collapse functionality for rows
        $(`#${tableId} tbody`).on('click', 'td.dt-control', function () {
            const tr = $(this).closest('tr');
            const row = dataTable.row(tr);
            const button = $(this).find('button');
            const icon = button.find('i');
            const text = button.find('small');

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                icon.removeClass('ti-chevron-up').addClass('ti-chevron-down');
                text.text('Ver todas');
            } else {
                // Open this row
                row.child(formatExpandedRow(row.data())).show();
                tr.addClass('shown');
                icon.removeClass('ti-chevron-down').addClass('ti-chevron-up');
                text.text('Ocultar');
            }
        });

        // Function to format the expanded row content with real pricing data
        function formatExpandedRow(data) {
            const serviceId = data.id || data.objectId;
            const rowElement = $(`#${tableId}`).find(`tr[data-service-id="${serviceId}"]`);
            let pricingData = rowElement.data('pricingData') || [];

            // If we don't have pricing data yet, show loading state and fetch it
            if (!pricingData || pricingData.length === 0) {
                // Show loading state initially
                setTimeout(() => {
                    fetchServicePricingForExpandedRow(serviceId);
                }, 100);

                return `
                    <div class="p-3 bg-light" id="expanded-${serviceId}">
                        <h6 class="mb-3">Precios por Categoría:</h6>
                        <div class="text-center p-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Cargando precios...</span>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Cargando precios...</p>
                        </div>
                    </div>
                `;
            }

            // Generate cards for each rate with real pricing
            let rateCards = '';
            const cardColors = ['primary', 'info', 'warning', 'success', 'dark', 'secondary'];

            pricingData.forEach((priceData, index) => {
                const colorClass = cardColors[index % cardColors.length];
                const rateName = priceData.rate?.name || 'Sin categoría';
                const price = priceData.formattedPrice || '$0.00';

                rateCards += `
                    <div class="col-md-3 mb-2">
                        <div class="card border-${colorClass}">
                            <div class="card-body p-2">
                                <small class="text-muted">${rateName}</small>
                                <h5 class="text-${colorClass} mb-0">${price}</h5>
                            </div>
                        </div>
                    </div>
                `;
            });

            // If no pricing data available
            if (pricingData.length === 0) {
                rateCards = `
                    <div class="col-12">
                        <div class="alert alert-warning text-center mb-0">
                            <i class="ti ti-exclamation-triangle me-2"></i>
                            No hay precios configurados para este servicio
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-3 bg-light" id="expanded-${serviceId}">
                    <h6 class="mb-3">Precios por Categoría:</h6>
                    <div class="row">
                        ${rateCards}
                    </div>
                </div>
            `;
        }

        // Event Handlers
        $('#createServiceBtn').on('click', function() {
            openServiceModal();
        });

        // Edit service
        $(`#${tableId}`).on('click', '.edit-service-btn', function() {
            const serviceId = $(this).data('id');
            loadServiceData(serviceId);
        });

        // Toggle status
        $(`#${tableId}`).on('click', '.toggle-status-btn', function() {
            const serviceId = $(this).data('id');
            const currentStatus = $(this).data('current-status');
            const origin = $(this).data('origin');
            const destination = $(this).data('destination');
            toggleServiceStatus(serviceId, currentStatus, origin, destination);
        });

        // Delete service
        $(`#${tableId}`).on('click', '.delete-service-btn', function() {
            const serviceId = $(this).data('id');
            const origin = $(this).data('origin');
            const destination = $(this).data('destination');
            deleteService(serviceId, origin, destination);
        });

        // Save service
        $('#saveServiceBtn').on('click', function() {
            saveService();
        });

        // Header rate filter
        $('#headerRateFilter').on('change', function() {
            const selectedRateId = $(this).val();
            
            if (selectedRateId) {
                // Filter table to show only services with the selected rate
                dataTable.column(2).search(selectedRateId).draw();
            } else {
                // Clear filter to show all services
                dataTable.column(2).search('').draw();
            }
        });

        // Filter pills (segmented control)
        $('.nav-pills .nav-link').on('click', function() {
            const filterValue = $(this).attr('id');
            
            switch(filterValue) {
                case 'aeropuerto-tab':
                    // Filter for airport services
                    dataTable.column(0).search('Aeropuerto').draw();
                    break;
                case 'punto-a-punto-tab':
                    // Filter for point-to-point services
                    dataTable.column(0).search('Punto a Punto').draw();
                    break;
                case 'local-tab':
                    // Filter for local services
                    dataTable.column(0).search('Local').draw();
                    break;
            }
        });

        // Currency filter (for future functionality)
        $('#currencyFilter').on('change', function() {
            const selectedCurrency = $(this).val();
            console.log('Currency changed to:', selectedCurrency);
            // Future: Update pricing display based on currency
            // This could trigger API calls to get converted prices
        });

        // Payment type filter (for future functionality)
        $('#paymentTypeFilter').on('change', function() {
            const selectedPaymentType = $(this).val();
            console.log('Payment type changed to:', selectedPaymentType);
            // Future: Filter services by available payment methods
            // or update pricing based on payment type surcharges
        });

        // Functions

        function populateRateDropdowns() {
            if (ratesData.length === 0) return;

            // Find all rate dropdowns in the current table
            $('.rate-dropdown').each(function() {
                const dropdown = $(this);
                const serviceId = dropdown.data('service-id');
                const currentRateId = dropdown.data('current-rate');

                // Clear existing options except the first one
                dropdown.find('option:not(:first)').remove();

                // Add rate options
                ratesData.forEach(rate => {
                    const isSelected = currentRateId === rate.value ? 'selected' : '';
                    const option = `<option value="${rate.value}" ${isSelected}>${rate.label} (${rate.formattedPercentage || rate.percentage + '%'})</option>`;
                    dropdown.append(option);
                });

                // Add change event handler for saving rate selection
                dropdown.off('change.rateChange').on('change.rateChange', function() {
                    const selectedRateId = $(this).val();
                    if (selectedRateId && serviceId) {
                        saveServiceRate(serviceId, selectedRateId);
                    }
                });
            });
        }

        // Function to fetch real service pricing data from the API
        function fetchServicePrice(serviceId, priceElementId) {
            const baseUrl = apiEndpoint.split('?')[0];
            const priceElement = $(`#${priceElementId}`);
            
            // Enhanced debug logging with cache buster
            const debugTimestamp = Date.now();
            console.log(`=== fetchServicePrice Debug @ ${debugTimestamp} ===`);
            console.log('Called with serviceId:', serviceId, '(type:', typeof serviceId, ')');
            console.log('Called with priceElementId:', priceElementId);
            console.log('Base URL:', baseUrl);
            console.log('Price element found:', priceElement.length > 0);
            console.log('Full API endpoint will be:', `${baseUrl}/${serviceId}/prices`);
            console.log('===============================');
            
            if (!serviceId || serviceId === 'undefined' || serviceId === undefined || serviceId === 'unknown') {
                console.error('=== SERVICE ID ERROR ===');
                console.error('Invalid service ID detected:', serviceId);
                console.error('Type of serviceId:', typeof serviceId);
                console.error('serviceId === undefined:', serviceId === undefined);
                console.error('serviceId === "undefined":', serviceId === "undefined");
                console.error('serviceId === "unknown":', serviceId === "unknown");
                console.error('========================');
                priceElement.html('<span class="text-danger small">ID Error</span>');
                return;
            }
            
            if (!priceElement.length) {
                console.warn(`Price element ${priceElementId} not found`);
                return;
            }

            $.ajax({
                url: `${baseUrl}/${serviceId}/prices`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data && response.data.length > 0) {
                        // Get the first rate's pricing (or could be default rate)
                        const firstRatePrice = response.data[0];
                        priceElement.html(firstRatePrice.formattedPrice || '$0.00');
                        
                        // Store pricing data for expandable row
                        priceElement.closest('tr').data('pricingData', response.data);
                    } else {
                        // No pricing data available
                        priceElement.html('<span class="text-muted">Sin precio</span>');
                    }
                },
                error: function(xhr) {
                    console.error('Error fetching service prices:', xhr);
                    priceElement.html('<span class="text-danger small">Error</span>');
                }
            });
        }

        // Function to fetch pricing data specifically for expanded row display
        function fetchServicePricingForExpandedRow(serviceId) {
            const baseUrl = apiEndpoint.split('?')[0];
            const expandedElement = $(`#expanded-${serviceId}`);
            
            if (!expandedElement.length) {
                console.warn(`Expanded element for service ${serviceId} not found`);
                return;
            }

            $.ajax({
                url: `${baseUrl}/${serviceId}/prices`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data && response.data.length > 0) {
                        // Generate cards for each rate with real pricing
                        let rateCards = '';
                        const cardColors = ['primary', 'info', 'warning', 'success', 'dark', 'secondary'];

                        response.data.forEach((priceData, index) => {
                            const colorClass = cardColors[index % cardColors.length];
                            const rateName = priceData.rate?.name || 'Sin categoría';
                            const price = priceData.formattedPrice || '$0.00';

                            rateCards += `
                                <div class="col-md-3 mb-2">
                                    <div class="card border-${colorClass}">
                                        <div class="card-body p-2">
                                            <small class="text-muted">${rateName}</small>
                                            <h5 class="text-${colorClass} mb-0">${price}</h5>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        // Update the expanded row content
                        expandedElement.html(`
                            <h6 class="mb-3">Precios por Categoría:</h6>
                            <div class="row">
                                ${rateCards}
                            </div>
                        `);
                    } else {
                        // No pricing data available
                        expandedElement.html(`
                            <h6 class="mb-3">Precios por Categoría:</h6>
                            <div class="alert alert-warning text-center mb-0">
                                <i class="ti ti-exclamation-triangle me-2"></i>
                                No hay precios configurados para este servicio
                            </div>
                        `);
                    }
                },
                error: function(xhr) {
                    console.error('Error fetching expanded row prices:', xhr);
                    expandedElement.html(`
                        <h6 class="mb-3">Precios por Categoría:</h6>
                        <div class="alert alert-danger text-center mb-0">
                            <i class="ti ti-exclamation-circle me-2"></i>
                            Error al cargar los precios
                        </div>
                    `);
                }
            });
        }

        function saveServiceRate(serviceId, rateId) {
            const baseUrl = apiEndpoint.split('?')[0];

            $.ajax({
                url: `${baseUrl}/${serviceId}/rate`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({ rateId: rateId }),
                success: function(response) {
                    if (response.success) {
                        showSuccessAlert('Tarifa asignada exitosamente');
                    } else {
                        showErrorAlert(response.error || 'Error al asignar tarifa');
                        // Reload the table to reset the dropdown
                        dataTable.ajax.reload(null, false);
                    }
                },
                error: function(xhr) {
                    console.error('Error saving rate:', xhr);
                    const error = xhr.responseJSON?.error || 'Error al asignar tarifa';
                    showErrorAlert(error);
                    // Reload the table to reset the dropdown
                    dataTable.ajax.reload(null, false);
                }
            });
        }

        // Helper function to wait for Tom Select to be initialized
        function waitForTomSelect(elementId, maxAttempts = 50) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    const element = document.getElementById(elementId);
                    if (element && element.tomselect) {
                        clearInterval(checkInterval);
                        resolve(element.tomselect);
                    } else {
                        attempts++;
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error(`Tom Select not initialized on #${elementId}`));
                        }
                    }
                }, 100);
            });
        }

        function loadDropdownData() {
            // Load POIs (all types for flexibility)
            $.ajax({
                url: '/api/pois/active',
                type: 'GET',
                success: async function(response) {
                    if (response.success && response.data) {
                        poisData = response.data;

                        try {
                            // Wait for Tom Select instances to be initialized
                            const originTS = await waitForTomSelect('originPOI');
                            const destTS = await waitForTomSelect('destinationPOI');

                            // Clear existing options
                            originTS.clearOptions();
                            destTS.clearOptions();

                            // Add options to both Tom Select instances
                            response.data.forEach(poi => {
                                const option = { value: poi.value, text: poi.label };
                                originTS.addOption(option);
                                destTS.addOption(option);
                            });

                            // Refresh to apply changes
                            originTS.refreshOptions(false);
                            destTS.refreshOptions(false);
                        } catch (error) {
                            console.error('Error initializing Tom Select:', error);
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Error loading POIs:', xhr);
                }
            });

            // Load VehicleTypes
            $.ajax({
                url: '/api/vehicle-types/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        vehicleTypesData = response.data;
                        const options = response.data.map(vt =>
                            `<option value="${vt.value}">${vt.label}</option>`
                        ).join('');
                        $('#vehicleType').append(options);
                    }
                },
                error: function(xhr) {
                    console.error('Error loading vehicle types:', xhr);
                }
            });

            // Load Rates
            $.ajax({
                url: '/api/rates/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        ratesData = response.data;
                        const modalOptions = response.data.map(rate =>
                            `<option value="${rate.value}">${rate.label} (${rate.formattedPercentage || rate.percentage + '%'})</option>`
                        ).join('');
                        
                        const headerOptions = response.data.map(rate =>
                            `<option value="${rate.value}">${rate.label}</option>`
                        ).join('');
                        
                        // Populate modal form dropdown (with percentage)
                        $('#rate').append(modalOptions);

                        // Populate header filter dropdown (without percentage)
                        $('#headerRateFilter').append(headerOptions);

                        // Set default selection to the first rate option
                        if (response.data && response.data.length > 0) {
                            const firstRate = response.data[0];
                            $('#headerRateFilter').val(firstRate.value);
                            // Trigger the filter to show only services with the first rate
                            $('#headerRateFilter').trigger('change');
                        }

                        // Also populate table dropdowns if they exist
                        populateRateDropdowns();
                    }
                },
                error: function(xhr) {
                    console.error('Error loading rates:', xhr);
                }
            });
        }

        async function openServiceModal(isEdit = false) {
            // Clear any previous modal alerts
            const alertsContainer = document.getElementById('serviceModalAlerts');
            if (alertsContainer) {
                alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
            }

            $('#serviceModal').modal('show');
            $('#serviceForm')[0].reset();
            $('#serviceId').val('');
            $('#modalTitle').text(isEdit ? 'Editar Traslado' : 'Crear Nuevo Traslado');
            $('#saveButtonText').text(isEdit ? 'Guardar Cambios' : 'Crear Traslado');

            try {
                // Wait for and clear Tom Select instances
                const originTS = await waitForTomSelect('originPOI');
                const destTS = await waitForTomSelect('destinationPOI');

                originTS.clear();
                destTS.clear();
            } catch (error) {
                console.error('Error clearing Tom Select:', error);
            }
        }

        async function loadServiceData(serviceId) {
            // Open modal first in edit mode (this will reset the form)
            await openServiceModal(true);

            // Show loader to prevent user interaction during data loading
            showModalLoader('serviceModal');

            $.ajax({
                url: `${apiEndpoint.split('?')[0]}/${serviceId}`,
                type: 'GET',
                success: async function(response) {
                    if (response.success && response.data) {
                        const service = response.data;

                        try {
                            // Wait for Tom Select instances
                            const originTS = await waitForTomSelect('originPOI');
                            const destTS = await waitForTomSelect('destinationPOI');

                            // Populate the form with the data
                            $('#serviceId').val(service.id);

                            // Set Tom Select values
                            if (service.originPOI?.id) {
                                originTS.setValue(service.originPOI.id);
                            }
                            if (service.destinationPOI?.id) {
                                destTS.setValue(service.destinationPOI.id);
                            }

                            $('#vehicleType').val(service.vehicleType?.id);
                            $('#rate').val(service.rate?.id);
                            $('#note').val(service.note || '');

                            // Hide loader after all data is loaded and populated
                            hideModalLoader('serviceModal');
                        } catch (error) {
                            console.error('Error setting Tom Select values:', error);
                            hideModalLoader('serviceModal');
                        }
                    } else {
                        hideModalLoader('serviceModal');
                        showErrorAlert('Formato de respuesta inválido');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    hideModalLoader('serviceModal');
                    const errorMessage = xhr.responseJSON?.error || 'Error al cargar el traslado';
                    showModalError(errorMessage);
                }
            });
        }

        async function saveService() {
            const form = $('#serviceForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const serviceId = $('#serviceId').val();
            const isEdit = !!serviceId;

            try {
                // Wait for Tom Select instances
                const originTS = await waitForTomSelect('originPOI');
                const destTS = await waitForTomSelect('destinationPOI');

                // Get values from Tom Select
                const originPOI = originTS.getValue();
                const destinationPOI = destTS.getValue();

                // Validate origin !== destination (only if both exist)
                if (originPOI && destinationPOI && originPOI === destinationPOI) {
                    showErrorAlert('El origen y el destino deben ser diferentes');
                    return;
                }

                const serviceData = {
                    originPOI: originPOI || null,
                    destinationPOI: destinationPOI,
                    vehicleType: $('#vehicleType').val(),
                    rate: $('#rate').val(),
                    note: $('#note').val().trim()
                };

                const url = isEdit ? `${apiEndpoint.split('?')[0]}/${serviceId}` : apiEndpoint.split('?')[0];
                const method = isEdit ? 'PUT' : 'POST';

                $.ajax({
                    url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(serviceData),
                    success: function(response) {
                        if (response.success) {
                            $('#serviceModal').modal('hide');
                            dataTable.ajax.reload();
                            showSuccessAlert(isEdit ? 'Traslado actualizado exitosamente' : 'Traslado creado exitosamente');
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Error al guardar el traslado';

                        if (xhr.responseJSON?.error) {
                            const error = xhr.responseJSON.error;
                            if (error.includes('already exists') || error.includes('ya existe')) {
                                errorMessage = 'Ya existe un traslado con esta ruta y tipo de vehículo.';
                            } else if (error.includes('required')) {
                                errorMessage = 'Todos los campos requeridos deben ser completados.';
                            } else if (error.includes('different') || error.includes('diferentes')) {
                                errorMessage = 'El origen y destino deben ser diferentes.';
                            } else {
                                errorMessage = error;
                            }
                        }

                        showModalError(errorMessage);
                    }
                });
            } catch (error) {
                console.error('Error getting Tom Select values:', error);
                showModalError('Error al obtener los valores del formulario');
            }
        }

        function toggleServiceStatus(serviceId, currentStatus, origin, destination) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'activar' : 'desactivar';
            const actionTitle = newStatus ? 'Activar' : 'Desactivar';
            const btnClass = newStatus ? 'btn-success' : 'btn-warning';

            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmToggleServiceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${actionTitle} Traslado</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas ${action} el traslado <strong>"${origin} → ${destination}"</strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn ${btnClass}" id="confirmToggleServiceBtn">${actionTitle}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmToggleServiceModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmToggleServiceModal'));
            modal.show();

            // Handle confirmation
            $('#confirmToggleServiceBtn').on('click', function() {
                const baseUrl = apiEndpoint.split('?')[0];

                $.ajax({
                    url: `${baseUrl}/${serviceId}/toggle-status`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({ active: newStatus }),
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(function() {}, false);
                            showAlert('success', `Traslado ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
                        } else {
                            modal.hide();
                            showAlert('danger', response.error || 'Error desconocido');
                        }
                    },
                    error: function(xhr) {
                        console.error('Toggle error:', xhr);
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al cambiar el estado del traslado';
                        showAlert('danger', error);
                    }
                });
            });
        }

        function deleteService(serviceId, origin, destination) {
            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmDeleteServiceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title text-white">Eliminar Traslado</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas eliminar el traslado <strong>"${origin} → ${destination}"</strong>?</p>
                                <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteServiceBtn">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmDeleteServiceModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteServiceModal'));
            modal.show();

            // Handle confirmation
            $('#confirmDeleteServiceBtn').on('click', function() {
                const baseUrl = apiEndpoint.split('?')[0];

                $.ajax({
                    url: `${baseUrl}/${serviceId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(null, false);
                            showAlert('success', 'Traslado eliminado exitosamente');
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al eliminar el traslado';
                        showAlert('danger', error);
                    }
                });
            });
        }

        /**
         * Show error alert message inside the modal
         * @param {string} message - Error message to display
         */
        function showModalError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('serviceModalAlerts');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 8000);
            }
        }

        /**
         * Show success alert message
         * @param {string} message - Success message to display
         */
        function showSuccessAlert(message) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('services-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 5000);
            }
        }

        /**
         * Show error alert message
         * @param {string} message - Error message to display
         */
        function showErrorAlert(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('services-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);
            }
        }

        // Legacy function for backward compatibility
        function showAlert(type, message) {
            if (type === 'success') {
                showSuccessAlert(message);
            } else {
                showErrorAlert(message);
            }
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
        initWhenReady();
    }
})();
</script>