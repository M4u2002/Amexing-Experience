<%
/**
 * Users DataTable Organism - Simplified Version
 * Advanced DataTable component for user management with role-based features
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role for permission-based features
 * @param {boolean} showActions - Whether to show action buttons
 */

// Default values
const dtTableId = typeof tableId !== 'undefined' ? tableId : 'users-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/users';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'guest';

// Permission checks
const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
%>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-gradient-primary text-white">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0">
                    <i class="ti ti-users me-2"></i>
                    Gestión de Usuarios
                </h5>
                <small class="opacity-75">Administra usuarios del sistema con funciones avanzadas</small>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="ti ti-plus me-1"></i>
                        Nuevo Usuario
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- DataTable Container -->
        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover data-table" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Registro</th>
                        <% if (dtShowActions && (canEdit || canDelete)) { %>
                            <th>Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DataTable Configuration Script -->
<script>
// Function to load API data first, then initialize DataTable
async function loadUsersAndInitializeTable(retryCount = 0) {
    const MAX_RETRIES = 5;
    const BASE_DELAY = 200; // ms

    // Check if jQuery and DataTables are loaded
    if (typeof jQuery === 'undefined' || typeof $ === 'undefined' || typeof $.fn.DataTable === 'undefined') {
        if (retryCount >= MAX_RETRIES) {
            console.error('❌ DataTables failed to load after', MAX_RETRIES, 'attempts');
            return;
        }

        // Exponential backoff: 200ms, 400ms, 800ms, 1600ms, 3200ms
        const delay = BASE_DELAY * Math.pow(2, retryCount);
        setTimeout(() => loadUsersAndInitializeTable(retryCount + 1), delay);
        return;
    }

    const apiEndpoint = '<%= dtApiEndpoint %>';

    try {
        // Load users data from API
        const response = await fetch(apiEndpoint, {
            method: 'GET',
            credentials: 'include', // Send cookies
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'API error');
        }

        const users = data.data?.users || [];

        // Initialize DataTable with the loaded data
        initializeDataTableWithData(users);

        // Dispatch custom event for page to listen
        document.dispatchEvent(new CustomEvent('usersTableLoaded', {
            detail: { count: users.length, users }
        }));

    } catch (error) {
        console.error('Error loading users:', error.message);
        // Initialize empty table on error
        initializeDataTableWithData([]);
    }
}

// Function to initialize DataTable with pre-loaded data
function initializeDataTableWithData(usersData) {
    const tableId = '<%= dtTableId %>';
    const canEdit = <%= canEdit %>;
    const canDelete = <%= canDelete %>;

    // DataTable configuration
    const tableConfig = {
        data: usersData,
        columns: [
            { title: 'Nombre', data: 'firstName', className: 'fw-bold' },
            { title: 'Apellido', data: 'lastName' },
            { title: 'Email', data: 'email', className: 'text-muted' },
            {
                title: 'Rol',
                data: 'role',
                className: 'text-center',
                render: function(data, type, row) {
                    if (type === 'display') {
                        const roleNames = {
                            'superadmin': { name: 'Super Admin', class: 'danger' },
                            'admin': { name: 'Admin', class: 'primary' },
                            'client': { name: 'Cliente', class: 'info' },
                            'department_manager': { name: 'Jefe Depto.', class: 'success' },
                            'employee': { name: 'Empleado', class: 'secondary' },
                            'driver': { name: 'Conductor', class: 'warning' },
                            'guest': { name: 'Invitado', class: 'light' }
                        };
                        const role = roleNames[data] || { name: data, class: 'secondary' };
                        return `<span class="badge bg-${role.class}">${role.name}</span>`;
                    }
                    return data;
                }
            },
            {
                title: 'Estado',
                data: 'active',
                className: 'text-center',
                render: function(data, type, row) {
                    if (type === 'display') {
                        const isActive = data === true || data === 'true';
                        const statusClass = isActive ? 'success' : 'danger';
                        const statusText = isActive ? 'Activo' : 'Inactivo';
                        return `<span class="badge bg-${statusClass}">${statusText}</span>`;
                    }
                    return data;
                }
            },
            {
                title: 'Registro',
                data: 'createdAt',
                className: 'text-center',
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        const date = new Date(data);
                        return date.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    return data;
                }
            }
        ],
        language: {
            url: '/assets/libs/datatables/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        processing: false,
        serverSide: false,
        searching: true,
        ordering: true,
        responsive: true
    };

    // Add actions column if permissions allow
    <% if (dtShowActions && (canEdit || canDelete)) { %>
    if (canEdit || canDelete) {
        tableConfig.columns.push({
            title: 'Acciones',
            data: null,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row) {
                if (type === 'display') {
                    let actions = '';
                    if (canEdit) {
                        actions += `<button type="button" class="btn btn-sm btn-primary me-1"
                                    onclick="editUser('${row.id}')" title="Editar">
                                    <i class="ti ti-edit"></i>
                                </button>`;
                    }
                    if (canDelete && row.role !== 'superadmin') {
                        actions += `<button type="button" class="btn btn-sm btn-danger"
                                    onclick="deleteUser('${row.id}')" title="Eliminar">
                                    <i class="ti ti-trash"></i>
                                </button>`;
                    }
                    return actions;
                }
                return '';
            }
        });
    }
    <% } %>

    // Initialize DataTable
    try {
        // Destroy existing instance if exists
        if ($.fn.DataTable.isDataTable('#' + tableId)) {
            $('#' + tableId).DataTable().destroy();
        }

        const usersTable = $('#' + tableId).DataTable(tableConfig);

        // Store reference globally
        window.usersTable = usersTable;

    } catch (error) {
        console.error('Failed to initialize DataTable:', error);
    }
}

// User action functions (placeholders)
function editUser(userId) {
    // TODO: Implement edit functionality
}

function deleteUser(userId) {
    // TODO: Implement delete functionality
}

// Start loading when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadUsersAndInitializeTable);
} else {
    loadUsersAndInitializeTable();
}
</script>