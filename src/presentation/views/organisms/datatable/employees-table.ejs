<%
/**
 * Employees DataTable Organism
 * Advanced DataTable component for employee management within a client organization
 * Supports both 'client' (Agent) and 'employee' roles
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * Component Dependencies:
 * - Requires: jQuery, Bootstrap 5, DataTables library
 * - Uses: Bootstrap buttons, badges, modals (molecules)
 * - Integrates: Alert system, loading states (atoms)
 *
 * @param {string} tableId - Unique table identifier (default: 'employees-table')
 * @param {string} clientId - Client ID for nested endpoint
 * @param {string} apiEndpoint - API endpoint for data loading (default: '/api/clients/:clientId/employees')
 * @param {string} userRole - Current user role for permission-based features (default: 'admin')
 * @param {boolean} showActions - Whether to show action buttons (default: true)
 *
 * Features:
 * - Real-time data loading from API
 * - Role-based action buttons (toggle status, delete)
 * - Server-side rendering with client-side DataTable enhancement
 * - Accessibility compliant (ARIA labels, keyboard navigation)
 * - Responsive design with mobile-friendly layout
 * - CSP-compliant event handling (no inline handlers)
 * - Role filter: Agent (client) vs Employee (employee)
 */

// Component Configuration
const dtTableId = typeof tableId !== 'undefined' ? tableId : 'employees-table';
const dtClientId = typeof clientId !== 'undefined' ? clientId : '';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : `/api/clients/${dtClientId}/employees`;
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

// Role-Based Permission Checks
const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);

// Role translations
const roleLabels = {
  client: 'Agent',
  employee: 'Empleado'
};
%>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #5a6a85 0%, #7a8a9f 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    <i class="ti ti-users me-2"></i>
                    Empleados de la Agencia
                </h5>
                <small class="text-white" style="opacity: 0.9;">Gestiona agentes y empleados de la empresa</small>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
                        <i class="ti ti-plus me-1"></i>
                        Nuevo Empleado
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- DataTable Container -->
        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover data-table" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Nombre Completo</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Registro</th>
                        <% if (dtShowActions && (canEdit || canDelete)) { %>
                            <th>Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via JavaScript -->
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>Nombre Completo</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Registro</th>
                        <% if (dtShowActions && (canEdit || canDelete)) { %>
                            <th>Acciones</th>
                        <% } %>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- DataTable Configuration and Initialization Script -->
<script>
/**
 * Employees DataTable JavaScript Module
 *
 * Structure:
 * 1. Data Loading & Initialization
 * 2. DataTable Configuration
 * 3. Alert/Notification System
 * 4. Employee Action Functions (Toggle Status, Delete)
 * 5. Event Delegation Setup
 * 6. Module Initialization
 */

// ============================================================================
// 1. DATA LOADING & INITIALIZATION
// ============================================================================

/**
 * Initialize table with server-side processing
 * No need to pre-load data, DataTable will fetch it via AJAX
 * @returns {void}
 */
function loadEmployeesAndInitializeTable() {
    try {
        // Initialize DataTable - it will handle data loading via AJAX
        initializeEmployeesDataTable();
    } catch (error) {
        console.error('Error initializing employees table:', error);
        showErrorAlert('Error al inicializar la tabla de empleados: ' + error.message);
    }
}

// ============================================================================
// 2. DATATABLE CONFIGURATION
// ============================================================================

/**
 * Initialize DataTables with server-side processing
 */
function initializeEmployeesDataTable() {
    // Destroy existing table if it exists
    if (window.employeesTable) {
        window.employeesTable.destroy();
    }

    // Initialize DataTable with server-side processing
    window.employeesTable = $('#<%= dtTableId %>').DataTable({
        processing: false,
        serverSide: true,
        searchDelay: 500,
        ajax: function(data, callback, settings) {
            // Show loading overlay
            const $table = $('#<%= dtTableId %>');
            const $wrapper = $table.closest('.dataTables_wrapper');

            // Add loading state
            $wrapper.addClass('datatable-loading');
            $table.css('opacity', '0.5');

            // Disable pagination buttons during load
            $wrapper.find('.paginate_button').addClass('disabled').css('pointer-events', 'none');

            // Map DataTables parameters to API parameters
            const params = new URLSearchParams({
                page: Math.floor(data.start / data.length) + 1,
                limit: data.length,
                sortField: data.columns[data.order[0].column].data || 'lastName',
                sortDirection: data.order[0].dir
            });

            // Add search parameter if provided
            if (data.search.value) {
                params.append('search', data.search.value);
            }

            fetch(`<%= dtApiEndpoint %>?${params.toString()}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(json => {
                if (!json.success) {
                    throw new Error(json.error || 'Failed to load employees');
                }

                // Return data in the format DataTables expects
                const totalCount = json.data?.pagination?.totalCount || 0;
                callback({
                    draw: data.draw,
                    recordsTotal: totalCount,
                    recordsFiltered: totalCount,
                    data: json.data?.users || []
                });
            })
            .catch(error => {
                console.error('DataTable AJAX error:', error);
                showErrorAlert('Error al cargar los datos de empleados: ' + error.message);

                // Return empty result on error
                callback({
                    draw: data.draw,
                    recordsTotal: 0,
                    recordsFiltered: 0,
                    data: []
                });
            })
            .finally(() => {
                // Remove loading state
                $wrapper.removeClass('datatable-loading');
                $table.css('opacity', '1');

                // Re-enable pagination buttons
                $wrapper.find('.paginate_button').removeClass('disabled').css('pointer-events', '');
            });
        },
        columns: [
            {
                data: null,
                render: function(data, type, row) {
                    const firstName = row.firstName || '';
                    const lastName = row.lastName || '';
                    const fullName = `${firstName} ${lastName}`.trim() || '-';
                    return `<strong class="text-dark">${fullName}</strong>`;
                }
            },
            {
                data: 'email',
                render: function(data, type, row) {
                    return `<a href="mailto:${data}" class="text-decoration-none">${data}</a>`;
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    const roleLabels = {
                        client: 'Agent',
                        employee: 'Empleado'
                    };
                    const role = row.role || row.roleId?.name || 'employee';
                    const roleName = typeof role === 'string' ? role : role.name || 'employee';
                    const roleLabel = roleLabels[roleName] || roleName;
                    const badgeClass = roleName === 'client' ? 'bg-info' : 'bg-secondary';
                    return `<span class="badge ${badgeClass}">${roleLabel}</span>`;
                }
            },
            {
                data: 'active',
                render: function(data, type, row) {
                    if (data) {
                        return '<span class="badge bg-success"><i class="ti ti-check me-1"></i>Activo</span>';
                    } else {
                        return '<span class="badge bg-danger"><i class="ti ti-x me-1"></i>Inactivo</span>';
                    }
                }
            },
            {
                data: 'createdAt',
                render: function(data, type, row) {
                    if (!data) return '-';
                    const date = new Date(data);
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            },
            <% if (dtShowActions && (canEdit || canDelete)) { %>
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    let actions = '<div class="btn-group btn-group-sm" role="group">';

                    <% if (canEdit) { %>
                    /* Toggle status button */
                    const statusIcon = row.active ? 'ti-user-off' : 'ti-user-check';
                    const statusTitle = row.active ? 'Desactivar' : 'Activar';
                    const statusClass = row.active ? 'btn-warning' : 'btn-success';

                    actions += `<button type="button"
                                class="btn ${statusClass} btn-toggle-employee-status"
                                data-employee-id="${row.id}"
                                data-current-status="${row.active}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="${statusTitle}">
                                <i class="ti ${statusIcon}"></i>
                            </button>`;
                    <% } %>

                    <% if (canDelete) { %>
                    /* Delete button */
                    const employeeName = `${row.firstName || ''} ${row.lastName || ''}`.trim() || 'este empleado';
                    actions += `<button type="button"
                                class="btn btn-danger btn-delete-employee"
                                data-employee-id="${row.id}"
                                data-employee-name="${employeeName}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Eliminar">
                                <i class="ti ti-trash"></i>
                            </button>`;
                    <% } %>

                    actions += '</div>';
                    return actions;
                }
            }
            <% } %>
        ],
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        responsive: true,
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        order: [[0, 'asc']], // Order by name
        pagingType: 'full_numbers',
        language: {
            processing: "Procesando...",
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 a 0 de 0 registros",
            infoFiltered: "(filtrado de _MAX_ registros totales)",
            loadingRecords: "Cargando...",
            zeroRecords: "No se encontraron empleados coincidentes",
            emptyTable: "No hay empleados registrados",
            paginate: {
                first: "Primero",
                previous: "Anterior",
                next: "Siguiente",
                last: "Último"
            }
        },
        drawCallback: function(settings) {
            // Customize pagination
            const $pagination = $('.dataTables_paginate');
            $pagination.find('.paginate_button').each(function() {
                const $btn = $(this);
                const text = $btn.text().trim();

                if (text === '…' || text === '...') {
                    $btn.addClass('ellipsis');
                    $btn.prop('title', 'Más páginas disponibles');
                }
            });

            // Reinitialize tooltips after table redraw
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    });
}

// ============================================================================
// 3. ALERT/NOTIFICATION SYSTEM
// ============================================================================

/**
 * Show success alert message
 * @param {string} message - Success message to display
 */
function showSuccessAlert(message) {
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="ti ti-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // Remove existing alerts
    document.querySelectorAll('.alert').forEach(el => el.remove());

    // Insert new alert
    const cardBody = document.querySelector('#<%= dtTableId %>').closest('.card-body');
    cardBody.insertAdjacentHTML('afterbegin', alertHtml);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(el => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 150);
        });
    }, 5000);
}

/**
 * Show error alert message
 * @param {string} message - Error message to display
 */
function showErrorAlert(message) {
    const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="ti ti-alert-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // Remove existing alerts
    document.querySelectorAll('.alert').forEach(el => el.remove());

    // Insert new alert
    const cardBody = document.querySelector('#<%= dtTableId %>').closest('.card-body');
    cardBody.insertAdjacentHTML('afterbegin', alertHtml);
}

// ============================================================================
// 4. EMPLOYEE ACTION FUNCTIONS
// ============================================================================

/**
 * Toggle employee active status
 * @param {string} employeeId - Employee ID
 * @param {boolean} currentStatus - Current active status
 */
function toggleEmployeeStatus(employeeId, currentStatus) {
    const newStatus = !currentStatus;
    const action = newStatus ? 'activar' : 'desactivar';
    const actionTitle = newStatus ? 'Activar' : 'Desactivar';
    const btnClass = newStatus ? 'btn-success' : 'btn-warning';

    // Create confirmation modal
    const modalHtml = `
        <div class="modal fade" id="confirmToggleEmployeeModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${actionTitle} Empleado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas ${action} este empleado?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn ${btnClass}" id="confirmToggleEmployeeBtn">${actionTitle}</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('confirmToggleEmployeeModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('confirmToggleEmployeeModal'));
    modal.show();

    // Handle confirmation
    document.getElementById('confirmToggleEmployeeBtn').addEventListener('click', async function() {
        modal.hide();
        await executeToggleEmployeeStatus(employeeId, newStatus);
    });
}

/**
 * Execute toggle status API call
 */
async function executeToggleEmployeeStatus(employeeId, newStatus) {
    try {
        const response = await fetch(`<%= dtApiEndpoint %>/${employeeId}/toggle-status`, {
            method: 'PATCH',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ active: newStatus })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Error al cambiar el estado del empleado');
        }

        showSuccessAlert(`Empleado ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
        // Reload table data
        window.employeesTable.ajax.reload(null, false);

    } catch (error) {
        console.error('Error toggling employee status:', error);
        showErrorAlert(error.message || 'Error al cambiar el estado del empleado. Por favor, intenta nuevamente.');
    }
}

/**
 * Delete (soft delete) employee
 * @param {string} employeeId - Employee ID
 * @param {string} employeeName - Employee name for confirmation
 */
function deleteEmployee(employeeId, employeeName) {
    // Create confirmation modal
    const modalHtml = `
        <div class="modal fade" id="confirmDeleteEmployeeModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Eliminar Empleado</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar el empleado <strong>"${employeeName}"</strong>?</p>
                        <p class="text-muted mb-0">Esta acción se puede revertir.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteEmployeeBtn">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('confirmDeleteEmployeeModal');
    if (existingModal) existingModal.remove();

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteEmployeeModal'));
    modal.show();

    // Handle confirmation
    document.getElementById('confirmDeleteEmployeeBtn').addEventListener('click', async function() {
        modal.hide();
        await executeDeleteEmployee(employeeId, employeeName);
    });
}

/**
 * Execute delete employee API call
 */
async function executeDeleteEmployee(employeeId, employeeName) {
    try {
        const response = await fetch(`<%= dtApiEndpoint %>/${employeeId}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            }
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Error al eliminar el empleado');
        }

        showSuccessAlert(`Empleado "${employeeName}" eliminado exitosamente`);
        // Reload table data
        window.employeesTable.ajax.reload(null, false);

    } catch (error) {
        console.error('Error deleting employee:', error);
        showErrorAlert(error.message || 'Error al eliminar el empleado. Por favor, intenta nuevamente.');
    }
}

// ============================================================================
// 5. EVENT DELEGATION SETUP
// ============================================================================

/**
 * Setup event delegation for dynamically created buttons
 */
function setupEventDelegation() {
    // Event delegation on table body
    const tableBody = document.querySelector('#<%= dtTableId %> tbody');

    if (!tableBody) return;

    tableBody.addEventListener('click', function(e) {
        const target = e.target.closest('button');

        if (!target) return;

        // Toggle status button
        if (target.classList.contains('btn-toggle-employee-status')) {
            const employeeId = target.getAttribute('data-employee-id');
            const currentStatus = target.getAttribute('data-current-status') === 'true';
            toggleEmployeeStatus(employeeId, currentStatus);
            return;
        }

        // Delete button
        if (target.classList.contains('btn-delete-employee')) {
            const employeeId = target.getAttribute('data-employee-id');
            const employeeName = target.getAttribute('data-employee-name');
            deleteEmployee(employeeId, employeeName);
            return;
        }
    });
}

// ============================================================================
// 6. MODULE INITIALIZATION
// ============================================================================

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    loadEmployeesAndInitializeTable();
    setupEventDelegation();
});

</script>

<!-- Custom Styles -->
<style>
.data-table {
    font-size: 0.875rem;
}

.data-table thead th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6;
    padding: 0.75rem;
}

.data-table tfoot th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    background-color: #f8f9fa !important;
    border-top: 2px solid #dee2e6;
    padding: 0.75rem;
    color: #5a6a85;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.badge {
    padding: 0.375rem 0.75rem;
    font-weight: 500;
}


/* Role filter buttons */
.btn-check:checked + .btn-outline-primary {
    background-color: #5a6a85;
    border-color: #5a6a85;
}
</style>
