<%
/**
 * Vehicles DataTable Organism
 * DataTable component for vehicle fleet management
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'vehicles-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/vehicles';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole); // Admin and superadmin can delete
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
%>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    <i class="ti ti-car me-2"></i>Flota de Vehículos
                </h5>
                <small class="text-white" style="opacity: 0.9;">Gestión completa del inventario de vehículos</small>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" id="createVehicleBtn">
                        <i class="ti ti-plus me-1"></i>Nuevo Vehículo
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card-body border-bottom bg-light">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="filterRate" class="form-label fw-semibold">
                    <i class="ti ti-percentage me-1"></i>Filtrar por Tarifa
                </label>
                <select class="form-select" id="filterRate">
                    <option value="">Todas las tarifas</option>
                    <!-- Options loaded dynamically -->
                </select>
            </div>
        </div>
    </div>

    <div class="card-body" id="vehicles-content">
        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Vehículo</th>
                        <th>Tipo</th>
                        <th>Placa</th>
                        <th>Tarifa</th>
                        <th>Capacidad</th>
                        <th>Mantenimiento</th>
                        <th>Seguro</th>
                        <th>Última Act.</th>
                        <th>Estado</th>
                        <% if (dtShowActions) { %>
                            <th class="text-center">Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Include Vehicle Images Modal -->
<%- include('../modal/vehicle-images-modal.ejs') %>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="vehicleModalLabel">
                    <i class="ti ti-car-plus me-2"></i><span id="modalTitle">Crear Nuevo Vehículo</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Alert container for modal-specific errors -->
                <div id="vehicleModalAlerts"></div>

                <form id="vehicleForm">
                    <input type="hidden" id="vehicleId">

                    <!-- Sección: Información del Vehículo -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-car me-1"></i>
                            Información del Vehículo
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="brand" class="form-label">Marca <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="brand" name="brand" required maxlength="100" placeholder="Ej: Mercedes-Benz">
                                <div class="form-text">Marca del vehículo</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="model" class="form-label">Modelo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="model" name="model" required maxlength="100" placeholder="Ej: Clase E">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="year" class="form-label">Año <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="year" name="year" required min="1990" max="2099" placeholder="Ej: 2024">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="licensePlate" class="form-label">Placa <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="licensePlate" name="licensePlate" required maxlength="20" placeholder="Ej: ABC-123-XYZ" style="text-transform: uppercase;">
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Especificaciones -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-settings me-1"></i>
                            Especificaciones
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vehicleType" class="form-label">Tipo de Vehículo <span class="text-danger">*</span></label>
                                <select class="form-select" id="vehicleType" name="vehicleType" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <!-- Options loaded dynamically from API -->
                                </select>
                                <div class="form-text">Tipo de vehículo del catálogo</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rate" class="form-label">Tarifa</label>
                                <select class="form-select" id="rate" name="rate">
                                    <option value="">Sin tarifa asignada</option>
                                    <!-- Options loaded dynamically from API -->
                                </select>
                                <div class="form-text">Tarifa de referencia (opcional)</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="capacity" class="form-label">Capacidad <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="capacity" name="capacity" required min="1" max="50" placeholder="Ej: 4">
                                <div class="form-text">Número de pasajeros</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="color" class="form-label">Color <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="color" name="color" required maxlength="50" placeholder="Ej: Negro">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maintenanceStatus" class="form-label">Estado de Mantenimiento <span class="text-danger">*</span></label>
                                <select class="form-select" id="maintenanceStatus" name="maintenanceStatus" required>
                                    <option value="">Seleccionar estado...</option>
                                    <option value="operational">Operacional</option>
                                    <option value="maintenance">En Mantenimiento</option>
                                    <option value="repair">En Reparación</option>
                                    <option value="out_of_service">Fuera de Servicio</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="insuranceExpiry" class="form-label">Vencimiento de Seguro</label>
                                <input type="date" class="form-control" id="insuranceExpiry" name="insuranceExpiry">
                                <div class="form-text">En caso de no modificar la fecha se tomará el día actual</div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert informativo -->
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                        <div>
                            <strong>Registro de vehículo:</strong>
                            <p class="mb-0 mt-1">Una vez registrado, el vehículo estará disponible para asignación en el sistema de reservaciones.</p>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveVehicleBtn">
                    <i class="ti ti-check me-1"></i><span id="saveButtonText">Crear Vehículo</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    function initWhenReady() {
        if (typeof jQuery === 'undefined') {
            setTimeout(initWhenReady, 100);
            return;
        }
        if (!jQuery.fn.dataTable) {
            setTimeout(initWhenReady, 100);
            return;
        }
        initVehiclesTable();
    }

    function initVehiclesTable() {
        const tableId = '<%= dtTableId %>';
        const apiEndpoint = '<%= dtApiEndpoint %>';
        const showActions = <%= dtShowActions %>;
        const canEdit = <%= canEdit %>;
        const canDelete = <%= canDelete %>;

        const dataTable = $(`#${tableId}`).DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: apiEndpoint,
                type: 'GET',
                data: function(d) {
                    // Add rate filter parameter
                    d.rateId = $('#filterRate').val();
                    return d;
                },
                dataSrc: function(json) {
                    return json.data || [];
                },
                error: function(xhr, error, thrown) {
                    console.error('Error loading vehicles:', error);
                }
            },
            columns: [
                {
                    data: null,
                    render: function(data) {
                        return `<div>
                                    <div class="fw-semibold">${data.brand} ${data.model}</div>
                                    <small class="text-muted">${data.year}</small>
                                </div>`;
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        const typeName = data.vehicleTypeId?.name || '-';
                        return `<span class="badge bg-info">${typeName}</span>`;
                    }
                },
                {
                    data: 'licensePlate',
                    render: function(data) {
                        return `<code class="badge bg-dark">${data || '-'}</code>`;
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        if (!data.rateId) {
                            return '<span class="badge bg-secondary">Sin tarifa</span>';
                        }
                        const rateColor = data.rateId.color || '#6366F1';
                        const rateName = data.rateId.name || '-';
                        return `<span class="badge" style="background-color: ${rateColor}; color: white;">${rateName}</span>`;
                    }
                },
                {
                    data: 'capacity',
                    className: 'text-center',
                    render: function(data) {
                        return `<span class="badge bg-secondary">${data} pax</span>`;
                    }
                },
                {
                    data: 'maintenanceStatus',
                    render: function(data) {
                        const statuses = {
                            operational: '<span class="badge bg-success">Operacional</span>',
                            maintenance: '<span class="badge bg-warning text-dark">Mantenimiento</span>',
                            repair: '<span class="badge bg-danger">Reparación</span>',
                            out_of_service: '<span class="badge bg-secondary">Fuera de Servicio</span>'
                        };
                        return statuses[data] || '-';
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        // Sin fecha de seguro asignada (vehículo nuevo o sin configurar)
                        if (!data.insuranceExpiry) {
                            return '<span class="badge bg-warning text-dark"><i class="ti ti-alert-triangle me-1"></i>Sin Seguro</span>';
                        }

                        // Calcular días hasta vencimiento
                        const expiry = new Date(data.insuranceExpiry);
                        const now = new Date();
                        // Normalize both dates to midnight for fair comparison
                        expiry.setHours(0, 0, 0, 0);
                        now.setHours(0, 0, 0, 0);
                        const daysUntil = Math.round((expiry - now) / (1000 * 60 * 60 * 24));

                        // Seguro vencido (necesita renovación urgente)
                        if (daysUntil < 0) {
                            return `<span class="badge bg-danger"><i class="ti ti-x me-1"></i>Seguro Vencido</span>`;
                        }
                        // Por vencer pronto (alerta)
                        else if (daysUntil <= 30) {
                            return `<span class="badge bg-warning text-dark"><i class="ti ti-clock me-1"></i>${daysUntil}d</span>`;
                        }
                        // Vigente
                        else {
                            return '<span class="badge bg-success"><i class="ti ti-check me-1"></i>Vigente</span>';
                        }
                    }
                },
                {
                    data: 'updatedAt',
                    render: function(data) {
                        const date = new Date(data);
                        return `<small>${date.toLocaleDateString('es-MX')}</small>`;
                    }
                },
                {
                    data: 'active',
                    render: function(data) {
                        return data
                            ? '<span class="badge bg-success">Activo</span>'
                            : '<span class="badge bg-secondary">Inactivo</span>';
                    }
                },
                ...(showActions ? [{
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: function(data) {
                        let actions = '<div class="btn-group btn-group-sm" role="group">';
                        if (canEdit) {
                            // Edit button
                            actions += `<button type="button"
                                            class="btn btn-primary edit-vehicle-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Editar Vehículo">
                                            <i class="ti ti-edit"></i>
                                        </button>`;

                            // Manage images button
                            actions += `<button type="button"
                                            class="btn btn-info manage-images-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-brand="${data.brand}"
                                            data-model="${data.model}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Gestionar Imágenes">
                                            <i class="ti ti-photo"></i>
                                        </button>`;

                            // Toggle status button - usar iconos más descriptivos
                            const statusIcon = data.active ? 'ti-archive' : 'ti-archive-off';
                            const statusTitle = data.active ? 'Desactivar Vehículo' : 'Activar Vehículo';
                            const statusClass = data.active ? 'btn-warning' : 'btn-success';

                            actions += `<button type="button"
                                            class="btn ${statusClass} toggle-vehicle-status-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-current-status="${data.active}"
                                            data-name="${data.brand} ${data.model}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="${statusTitle}">
                                            <i class="ti ${statusIcon}"></i>
                                        </button>`;
                        }
                        if (canDelete) {
                            // Delete button
                            actions += `<button type="button"
                                            class="btn btn-danger delete-vehicle-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-name="${data.brand} ${data.model}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Eliminar Vehículo">
                                            <i class="ti ti-trash"></i>
                                        </button>`;
                        }
                        actions += '</div>';
                        return actions;
                    }
                }] : [])
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando vehículos...'
            },
            order: [[7, 'desc']], // Changed from 6 to 7 (updatedAt column index)
            pageLength: 10,
            searchDelay: 300,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            drawCallback: function() {
                // Reinitialize tooltips after table redraw
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        $('#createVehicleBtn').on('click', function() { openVehicleModal(); });
        $(`#${tableId}`).on('click', '.edit-vehicle-btn', function() { loadVehicleData($(this).data('id')); });
        $(`#${tableId}`).on('click', '.manage-images-btn', function() {
            const vehicleId = $(this).data('id');
            const brand = $(this).data('brand');
            const model = $(this).data('model');
            window.openVehicleImagesModal(vehicleId, brand, model);
        });
        $(`#${tableId}`).on('click', '.toggle-vehicle-status-btn', function() {
            toggleVehicleStatus($(this).data('id'), $(this).data('current-status'), $(this).data('name'));
        });
        $(`#${tableId}`).on('click', '.delete-vehicle-btn', function() { deleteVehicle($(this).data('id'), $(this).data('name')); });
        $('#saveVehicleBtn').on('click', function() { saveVehicle(); });
        $('#vehicleType').on('change', function() {
            const defaultCapacity = $(this).find('option:selected').data('capacity');
            if (defaultCapacity && !$('#capacity').val()) $('#capacity').val(defaultCapacity);
        });

        // Load rates for filter dropdown
        function loadRatesFilter() {
            $.ajax({
                url: '/api/rates/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const select = $('#filterRate');
                        select.find('option:not(:first)').remove();
                        response.data.forEach(function(rate) {
                            const option = $('<option></option>')
                                .attr('value', rate.value)
                                .text(rate.label)
                                .attr('data-color', rate.color || '#6366F1');
                            select.append(option);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading rates for filter:', error);
                }
            });
        }

        // Reload DataTable when filter changes
        $('#filterRate').on('change', function() {
            dataTable.ajax.reload();
        });

        // Load rates on page load
        loadRatesFilter();

        function loadVehicleTypes() {
            return $.ajax({
                url: '/api/vehicle-types/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const select = $('#vehicleType');
                        select.find('option:not(:first)').remove();
                        response.data.forEach(function(type) {
                            select.append(`<option value="${type.value}" data-capacity="${type.capacity}">${type.label}</option>`);
                        });
                    }
                },
                error: function(xhr) { showErrorAlert('Error al cargar los tipos de vehículos'); }
            });
        }

        function loadRates() {
            return $.ajax({
                url: '/api/rates/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const select = $('#rate');
                        select.find('option:not(:first)').remove();
                        response.data.forEach(function(rate) {
                            select.append(`<option value="${rate.value}">${rate.label}</option>`);
                        });
                    }
                },
                error: function(xhr) { showErrorAlert('Error al cargar las tarifas'); }
            });
        }

        function openVehicleModal(isEdit = false) {
            // Clear any previous modal alerts
            const alertsContainer = document.getElementById('vehicleModalAlerts');
            if (alertsContainer) {
                alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
            }

            $('#vehicleModal').modal('show');
            $('#vehicleForm')[0].reset();
            $('#vehicleId').val('');
            $('#modalTitle').text(isEdit ? 'Editar Vehículo' : 'Crear Nuevo Vehículo');
            $('#saveButtonText').text(isEdit ? 'Guardar Cambios' : 'Crear Vehículo');
            loadVehicleTypes();
            loadRates();

            // Set current date as default for insurance expiry only in create mode
            if (!isEdit) {
                const today = new Date().toISOString().split('T')[0];
                $('#insuranceExpiry').val(today);
            }
        }

        function loadVehicleData(vehicleId) {
            // CRITICAL: Open modal first (this resets form)
            openVehicleModal(true);

            // Then load data via AJAX
            $.ajax({
                url: `${apiEndpoint}/${vehicleId}`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const vehicle = response.data;
                        // Now populate the form after it's been reset
                        $('#vehicleId').val(vehicle.id);
                        $('#brand').val(vehicle.brand);
                        $('#model').val(vehicle.model);
                        $('#year').val(vehicle.year);
                        $('#licensePlate').val(vehicle.licensePlate);
                        $('#capacity').val(vehicle.capacity);
                        $('#color').val(vehicle.color);
                        $('#maintenanceStatus').val(vehicle.maintenanceStatus);
                        $('#insuranceExpiry').val(vehicle.insuranceExpiry || '');
                        // Load vehicle types and rates, then set the selected ones
                        $.when(loadVehicleTypes(), loadRates()).done(function() {
                            $('#vehicleType').val(vehicle.vehicleTypeId);
                            $('#rate').val(vehicle.rateId || '');
                        });
                    } else {
                        showErrorAlert('Formato de respuesta inválido');
                    }
                },
                error: function(xhr) {
                    showModalError(xhr.responseJSON?.error || 'Error al cargar el vehículo');
                }
            });
        }

        function saveVehicle() {
            const form = $('#vehicleForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }
            const vehicleId = $('#vehicleId').val();
            const isEdit = !!vehicleId;
            const rateValue = $('#rate').val();
            const vehicleData = {
                brand: $('#brand').val(),
                model: $('#model').val(),
                year: parseInt($('#year').val()),
                licensePlate: $('#licensePlate').val().toUpperCase(),
                vehicleTypeId: $('#vehicleType').val(),
                rateId: rateValue || null,
                capacity: parseInt($('#capacity').val()),
                color: $('#color').val(),
                maintenanceStatus: $('#maintenanceStatus').val(),
                insuranceExpiry: $('#insuranceExpiry').val() || null
            };
            const url = isEdit ? `${apiEndpoint}/${vehicleId}` : apiEndpoint;
            const method = isEdit ? 'PUT' : 'POST';
            $('#saveVehicleBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Guardando...');
            $.ajax({
                url, type: method,
                contentType: 'application/json',
                data: JSON.stringify(vehicleData),
                success: function(response) {
                    if (response.success) {
                        $('#vehicleModal').modal('hide');
                        dataTable.ajax.reload();
                        showSuccessAlert(isEdit ? 'Vehículo actualizado exitosamente' : 'Vehículo creado exitosamente');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.error || 'Error al guardar el vehículo';
                    showModalError(errorMessage);
                },
                complete: function() {
                    $('#saveVehicleBtn').prop('disabled', false).html('<i class="ti ti-check me-1"></i>' + (isEdit ? 'Guardar Cambios' : 'Crear Vehículo'));
                }
            });
        }

        function toggleVehicleStatus(vehicleId, currentStatus, vehicleName) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'activar' : 'desactivar';
            const actionTitle = newStatus ? 'Activar' : 'Desactivar';
            const btnClass = newStatus ? 'btn-success' : 'btn-warning';

            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmToggleVehicleModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${actionTitle} Vehículo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas ${action} el vehículo <strong>"${vehicleName}"</strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn ${btnClass}" id="confirmToggleVehicleBtn">${actionTitle}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmToggleVehicleModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmToggleVehicleModal'));
            modal.show();

            // Handle confirmation
            $('#confirmToggleVehicleBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${vehicleId}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ active: newStatus }),
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(null, false);
                            showAlert('success', `Vehículo ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al cambiar el estado del vehículo';
                        showAlert('danger', error);
                    }
                });
            });
        }

        function deleteVehicle(vehicleId, vehicleName) {
            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmDeleteVehicleModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title text-white">Eliminar Vehículo</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que deseas eliminar el vehículo <strong>"${vehicleName}"</strong>?</p>
                                <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteVehicleBtn">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmDeleteVehicleModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteVehicleModal'));
            modal.show();

            // Handle confirmation
            $('#confirmDeleteVehicleBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${vehicleId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            dataTable.ajax.reload(null, false);
                            showAlert('success', 'Vehículo eliminado exitosamente');
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al eliminar el vehículo';
                        showAlert('danger', error);
                    }
                });
            });
        }

        /**
         * Show error alert inside modal
         * @param {string} message - Error message to display
         */
        function showModalError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('vehicleModalAlerts');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 8000);
            }
        }

        /**
         * Show success alert message
         * @param {string} message - Success message to display
         */
        function showSuccessAlert(message) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Remove existing alerts from this specific section
            const container = document.getElementById('vehicles-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());

                // Insert new alert at the beginning of the content
                container.insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 5000);
            }
        }

        /**
         * Show error alert message
         * @param {string} message - Error message to display
         */
        function showErrorAlert(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // Remove existing alerts from this specific section
            const container = document.getElementById('vehicles-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());

                // Insert new alert at the beginning of the content
                container.insertAdjacentHTML('afterbegin', alertHtml);
            }
        }

        // Legacy function for backward compatibility
        function showAlert(type, message) {
            if (type === 'success') {
                showSuccessAlert(message);
            } else {
                showErrorAlert(message);
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
        initWhenReady();
    }
})();
</script>
