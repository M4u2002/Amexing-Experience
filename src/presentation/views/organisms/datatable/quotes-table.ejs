<%
/**
 * Quote DataTable Organism
 * DataTable component for quotes management
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'quotes-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/quotes';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';

const canEdit = ['superadmin', 'admin', 'department_manager'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin', 'department_manager'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin', 'department_manager'].includes(dtUserRole);
const canViewSummary = dtUserRole === 'department_manager';

// Dynamic base path based on user role
const baseDashboardPath = dtUserRole === 'department_manager' 
    ? '/dashboard/department_manager' 
    : dtUserRole === 'admin' 
        ? '/dashboard/admin' 
        : '/dashboard/superadmin';
%>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    <i class="ti ti-file-invoice me-2"></i>Cotizaciones
                </h5>
                <small class="text-white" style="opacity: 0.9;">Gestión de cotizaciones del sistema</small>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <a href="<%= baseDashboardPath %>/quotes/new" class="btn btn-light btn-sm">
                        <i class="ti ti-plus me-1"></i>Nueva Cotización
                    </a>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body" id="quotes-content">
        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th>Folio</th>
                        <th>Cliente</th>
                        <th>Tipo de Evento</th>
                        <th class="text-center">No. Personas</th>
                        <th>Creado Por</th>
                        <th class="text-center">Estatus</th>
                        <th class="text-center">Fecha Creación</th>
                        <th class="text-center">Última Modificación</th>
                        <% if (dtShowActions) { %>
                            <th class="text-center">Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Copy Quote Modal -->
<div class="modal fade" id="copyQuoteModal" tabindex="-1" aria-labelledby="copyQuoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title text-white" id="copyQuoteModalLabel">
                    <i class="ti ti-copy me-2"></i>Duplicar Cotización
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Desea duplicar la cotización <strong id="copyQuoteFolio"></strong>?</p>
                <div class="alert alert-info d-flex align-items-start" role="alert">
                    <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                    <div>
                        <strong>Información:</strong>
                        <ul class="mb-0 mt-1 ps-3">
                            <li>Se creará una nueva cotización con un folio diferente</li>
                            <li>El tipo de evento se incrementará automáticamente (ejemplo: "Evento - Opción 2")</li>
                            <li>Se copiará todo el itinerario y servicios</li>
                            <li>El estatus será "Solicitado"</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-info" id="confirmCopyQuoteBtn">
                    <i class="ti ti-copy me-1"></i>Duplicar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Quote Modal -->
<div class="modal fade" id="deleteQuoteModal" tabindex="-1" aria-labelledby="deleteQuoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title text-white" id="deleteQuoteModalLabel">
                    <i class="ti ti-alert-triangle me-2"></i>Eliminar Cotización
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la cotización <strong id="deleteQuoteFolio"></strong>?</p>
                <div class="alert alert-warning d-flex align-items-start" role="alert">
                    <i class="ti ti-alert-triangle me-2 fs-5 mt-1"></i>
                    <div>
                        <strong>Advertencia:</strong>
                        <p class="mb-0 mt-1">Esta acción no se puede deshacer.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteQuoteBtn">
                    <i class="ti ti-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Receipt Modal -->
<div class="modal fade" id="generateReceiptModal" tabindex="-1" aria-labelledby="generateReceiptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title text-white" id="generateReceiptModalLabel">
                    <i class="ti ti-receipt me-2"></i>Generar Recibo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Desea generar el recibo para la cotización <strong id="receiptQuoteFolio"></strong>?</p>
                
                <% if (dtUserRole === 'admin') { %>
                <!-- Payment Info Selection for Admin Only -->
                <div class="mb-3">
                    <label for="paymentInfoSelect" class="form-label">
                        <strong>Método de Pago a Incluir</strong>
                    </label>
                    <select class="form-select" id="paymentInfoSelect">
                        <option value="">Sin información de pago</option>
                        <option value="loading" disabled>Cargando métodos de pago...</option>
                    </select>
                    <div class="form-text">Selecciona qué información de pago incluir en el recibo</div>
                </div>
                <% } %>
                
                <div class="alert alert-info d-flex align-items-start" role="alert">
                    <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                    <div>
                        <strong>Información:</strong>
                        <ul class="mb-0 mt-1 ps-3">
                            <li>Se generará un recibo oficial</li>
                            <li>La cotización debe estar en estado "<%= dtUserRole === 'admin' ? 'APROBADO' : 'AGENDADO' %>"</li>
                            <li>El recibo se enviará por correo electrónico</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="confirmGenerateReceiptBtn">
                    <i class="ti ti-receipt me-1"></i>Generar Recibo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Request Invoice Modal -->
<div class="modal fade" id="requestInvoiceModal" tabindex="-1" aria-labelledby="requestInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title text-white" id="requestInvoiceModalLabel">
                    <i class="ti ti-file-invoice me-2"></i>Solicitar Factura
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Desea solicitar la factura para la cotización <strong id="invoiceQuoteFolio"></strong>?</p>
                <div class="alert alert-info d-flex align-items-start" role="alert">
                    <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                    <div>
                        <strong>Información:</strong>
                        <ul class="mb-0 mt-1 ps-3">
                            <li>Se enviará una solicitud al departamento de facturación</li>
                            <li>La cotización debe estar en estado "<%= dtUserRole === 'admin' ? 'APROBADO' : 'AGENDADO' %>"</li>
                            <li>Recibirá confirmación por correo electrónico</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="confirmRequestInvoiceBtn">
                    <i class="ti ti-file-invoice me-1"></i>Solicitar Factura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Reservation Modal (same as quote summary) -->
<!-- Note: Modal HTML will be dynamically generated to match quote summary implementation -->

<script>
(function() {
    // Wait for DOM and all dependencies to be ready
    function initWhenReady() {
        // Check if jQuery and DataTables are loaded
        if (typeof jQuery === 'undefined') {
            console.warn('jQuery not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        if (!jQuery.fn.dataTable) {
            console.warn('DataTables not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        initQuotesTable();
    }

    function initQuotesTable() {
        const tableId = '<%= dtTableId %>';
        const apiEndpoint = '<%= dtApiEndpoint %>';
        const showActions = <%= dtShowActions %>;
        const canEdit = <%= canEdit %>;
        const canDelete = <%= canDelete %>;
        const basePath = '<%= baseDashboardPath %>';

        // Variables to store quote IDs for modal actions
        let copyQuoteId = null;
        let deleteQuoteId = null;
        let generateReceiptQuoteId = null;
        let requestInvoiceQuoteId = null;
        let cancelReservationQuoteId = null;

        /**
         * Calculate relative luminance of a color for contrast determination.
         * @param {string} hex - Hex color code (#RRGGBB)
         * @returns {number} Luminance value between 0 and 1
         */
        function calculateLuminance(hex) {
            const cleanHex = hex.replace('#', '');
            const r = parseInt(cleanHex.substring(0, 2), 16) / 255;
            const g = parseInt(cleanHex.substring(2, 4), 16) / 255;
            const b = parseInt(cleanHex.substring(4, 6), 16) / 255;

            const rLinear = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
            const gLinear = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
            const bLinear = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

            return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear;
        }

        /**
         * Determine optimal text color based on background luminance.
         * @param {string} backgroundColor - Hex color code
         * @returns {string} '#1F2937' for dark or '#FFFFFF' for light text
         */
        function getContrastTextColor(backgroundColor) {
            const luminance = calculateLuminance(backgroundColor);
            return luminance > 0.5 ? '#1F2937' : '#FFFFFF';
        }

        // Get JWT token from cookies
        function getAccessToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'accessToken') {
                    return value;
                }
            }
            return null;
        }

        // Setup global AJAX configuration to include JWT token
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAccessToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            }
        });

        // DataTable Configuration
        const dataTable = $(`#${tableId}`).DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: apiEndpoint,
                type: 'GET',
                dataSrc: function(json) {
                    return json.data || [];
                },
                error: function(xhr, error, thrown) {
                    console.error('Error loading Quotes:', error);
                    showErrorAlert('Error al cargar las cotizaciones');
                }
            },
            columns: [
                {
                    data: 'folio',
                    render: function(data) {
                        return `<span class="fw-semibold text-primary">${data || 'N/A'}</span>`;
                    }
                },
                {
                    data: 'client',
                    render: function(data) {
                        if (!data) return '<em class="text-muted">Sin cliente</em>';
                        const fullName = data.fullName || '-';
                        const company = data.companyName;
                        return company
                            ? `${fullName} <small class="text-muted">(${company})</small>`
                            : fullName;
                    }
                },
                {
                    data: 'eventType',
                    render: function(data) {
                        if (!data || data.trim() === '') {
                            return '<em class="text-muted">Sin especificar</em>';
                        }
                        return `<span class="text-truncate" style="max-width: 200px; display: inline-block;" title="${data}">${data}</span>`;
                    }
                },
                {
                    data: 'numberOfPeople',
                    className: 'text-center',
                    render: function(data) {
                        return `<span class="fw-semibold">${data || 1}</span>`;
                    }
                },
                {
                    data: 'createdBy',
                    render: function(data) {
                        if (!data) return '<em class="text-muted">Sin información</em>';
                        return `<span>${data.fullName || data.email || 'N/A'}</span>`;
                    }
                },
                {
                    data: 'status',
                    className: 'text-center',
                    render: function(data, type, row) {
                        const userRole = '<%= dtUserRole %>';
                        
                        // Define statuses based on user role
                        const scheduledText = userRole === 'admin' ? 'APROBADO' : 'AGENDADO';
                        const statuses = [
                            { value: 'requested', text: 'SOLICITADO', class: 'bg-primary' },
                            { value: 'hold', text: 'BLOQUEADO', class: 'bg-warning' },
                            { value: 'scheduled', text: scheduledText, class: 'bg-success' },
                            { value: 'rejected', text: 'RECHAZADO', class: 'bg-danger' }
                        ];

                        // If status is 'scheduled', show a non-editable badge instead of dropdown
                        if (data === 'scheduled') {
                            return `<span class="badge bg-success px-3 py-2" style="font-size: 0.75rem;">${scheduledText}</span>`;
                        }

                        let select = `<select class="form-select form-select-sm status-selector" data-id="${row.id}" data-folio="${row.folio}" style="font-size: 0.75rem; cursor: pointer;">`;
                        statuses.forEach(status => {
                            const selected = status.value === data ? 'selected' : '';
                            select += `<option value="${status.value}" ${selected}>${status.text}</option>`;
                        });
                        select += '</select>';
                        return select;
                    }
                },
                {
                    data: 'createdAt',
                    className: 'text-center',
                    render: function(data) {
                        if (!data) return '<em class="text-muted">N/A</em>';
                        const date = new Date(data);
                        const dateStr = date.toLocaleDateString('es-MX', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        const timeStr = date.toLocaleTimeString('es-MX', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        return `<div style="white-space: nowrap;">
                                    <div class="fw-semibold">${dateStr}</div>
                                    <small class="text-muted">${timeStr}</small>
                                </div>`;
                    }
                },
                {
                    data: 'updatedAt',
                    className: 'text-center',
                    render: function(data) {
                        if (!data) return '<em class="text-muted">N/A</em>';
                        const date = new Date(data);
                        const dateStr = date.toLocaleDateString('es-MX', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        const timeStr = date.toLocaleTimeString('es-MX', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        return `<div style="white-space: nowrap;">
                                    <div class="fw-semibold">${dateStr}</div>
                                    <small class="text-muted">${timeStr}</small>
                                </div>`;
                    }
                },
                ...(showActions ? [{
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: function(data) {
                        // If the quote is in 'scheduled' status, show special scheduled actions
                        if (data.status === 'scheduled') {
                            let actions = '<div class="btn-group btn-group-sm" role="group">';
                            
                            // Ver Resumen button for both admin and department_manager roles
                            <% if (dtUserRole === 'admin' || canViewSummary) { %>
                            actions += `<button type="button"
                                            class="btn btn-outline-primary view-summary-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-folio="${data.folio}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Ver Resumen">
                                            <i class="ti ti-file-text"></i>
                                        </button>`;
                            <% } %>
                            
                            // Generate Receipt button
                            actions += `<button type="button"
                                            class="btn btn-success generate-receipt-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-folio="${data.folio}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Generar Recibo">
                                            <i class="ti ti-receipt"></i>
                                        </button>`;

                            // Request Invoice button (only show if no pending request)
                            if (!data.hasPendingInvoiceRequest) {
                                actions += `<button type="button"
                                                class="btn btn-warning request-invoice-btn"
                                                data-id="${data.objectId || data.id}"
                                                data-folio="${data.folio}"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Solicitar Factura">
                                                <i class="ti ti-file-invoice"></i>
                                            </button>`;
                            } else {
                                // Show disabled button with different text when invoice already requested
                                actions += `<button type="button"
                                                class="btn btn-secondary"
                                                disabled
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Factura ya solicitada">
                                                <i class="ti ti-file-invoice"></i>
                                            </button>`;
                            }

                            // Cancel Reservation button
                            actions += `<button type="button"
                                            class="btn btn-danger cancel-reservation-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-folio="${data.folio}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Cancelar Reserva">
                                            <i class="ti ti-x"></i>
                                        </button>`;

                            actions += '</div>';
                            return actions;
                        }

                        // Normal actions for non-scheduled quotes
                        let actions = '<div class="btn-group btn-group-sm" role="group">';

                        if (canEdit) {
                            // Copy button (at the beginning)
                            actions += `<button type="button"
                                            class="btn btn-info copy-quote-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-folio="${data.folio}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Duplicar Cotización">
                                            <i class="ti ti-copy"></i>
                                        </button>`;

                            // Edit button (goes to detail page)
                            actions += `<a href="<%= baseDashboardPath %>/quotes/${data.objectId || data.id}"
                                            class="btn btn-primary"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Editar Cotización">
                                            <i class="ti ti-edit"></i>
                                        </a>`;
                        }

                        if (canDelete) {
                            // Delete button (opens modal)
                            actions += `<button type="button"
                                            class="btn btn-danger delete-quote-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-folio="${data.folio}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Eliminar Cotización">
                                            <i class="ti ti-trash"></i>
                                        </button>`;
                        }

                        actions += '</div>';
                        return actions;
                    }
                }] : [])
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando Cotizaciones...'
            },
            order: [[8, 'desc']], // Sort by updatedAt column by default (most recent first)
            pageLength: 10,
            searchDelay: 300,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            drawCallback: function() {
                // Reinitialize tooltips after table redraw
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        // Event Handlers

        // Status dropdown change
        $(`#${tableId}`).on('change', '.status-selector', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            const newStatus = $(this).val();
            const oldStatus = $(this).find('option:not(:selected)').first().val();

            updateQuoteStatus(quoteId, quoteFolio, newStatus, oldStatus);
        });

        // Copy Quote button click
        $(`#${tableId}`).on('click', '.copy-quote-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            openCopyModal(quoteId, quoteFolio);
        });

        // Ver Resumen button click (for both admin and department_manager)
        $(`#${tableId}`).on('click', '.view-summary-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            
            // Navigate to quote detail page with summary section
            window.location.href = `${basePath}/quotes/${quoteId}?section=summary`;
        });

        // Confirm copy button in modal
        $('#confirmCopyQuoteBtn').on('click', function() {
            if (copyQuoteId) {
                executeCopy(copyQuoteId);
            }
        });

        // Delete Quote button click
        $(`#${tableId}`).on('click', '.delete-quote-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            openDeleteModal(quoteId, quoteFolio);
        });

        // Confirm delete button in modal
        $('#confirmDeleteQuoteBtn').on('click', function() {
            if (deleteQuoteId) {
                executeDelete(deleteQuoteId);
            }
        });

        // Reserved Quote Action Event Handlers

        // Generate Receipt button click
        $(`#${tableId}`).on('click', '.generate-receipt-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            openGenerateReceiptModal(quoteId, quoteFolio);
        });

        // Request Invoice button click
        $(`#${tableId}`).on('click', '.request-invoice-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            openRequestInvoiceModal(quoteId, quoteFolio);
        });

        // Cancel Reservation button click
        $(`#${tableId}`).on('click', '.cancel-reservation-btn', function() {
            const quoteId = $(this).data('id');
            const quoteFolio = $(this).data('folio');
            openCancelReservationModal(quoteId, quoteFolio);
        });

        // Confirm Generate Receipt button in modal
        $('#confirmGenerateReceiptBtn').on('click', function() {
            if (generateReceiptQuoteId) {
                executeGenerateReceipt(generateReceiptQuoteId);
            }
        });

        // Confirm Request Invoice button in modal
        $('#confirmRequestInvoiceBtn').on('click', function() {
            if (requestInvoiceQuoteId) {
                executeRequestInvoice(requestInvoiceQuoteId);
            }
        });

        // Note: Cancel reservation confirmation is handled in the dynamically created modal
        // No need for global event handler since each modal creates its own event listener

        // Functions

        function updateQuoteStatus(quoteId, quoteFolio, newStatus, oldStatus) {
            $.ajax({
                url: `${apiEndpoint}/${quoteId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    status: newStatus,
                    reason: `Status changed from ${oldStatus} to ${newStatus}`
                }),
                success: function(response) {
                    if (response.success) {
                        showSuccessAlert(`Estatus de cotización ${quoteFolio} actualizado exitosamente`);
                        dataTable.ajax.reload(null, false); // Reload without resetting page
                    } else {
                        showErrorAlert(response.error || 'Error al actualizar el estatus');
                        dataTable.ajax.reload(null, false);
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Error al actualizar el estatus';
                    showErrorAlert(errorMsg);
                    dataTable.ajax.reload(null, false);
                }
            });
        }

        /**
         * Open copy confirmation modal
         * @param {string} quoteId - Quote ID to duplicate
         * @param {string} quoteFolio - Quote folio for display
         */
        function openCopyModal(quoteId, quoteFolio) {
            copyQuoteId = quoteId;
            $('#copyQuoteFolio').text(quoteFolio);
            const copyModal = new bootstrap.Modal(document.getElementById('copyQuoteModal'));
            copyModal.show();
        }

        /**
         * Close copy modal properly
         */
        function closeCopyModal() {
            const modalElement = document.getElementById('copyQuoteModal');
            if (modalElement) {
                const copyModal = bootstrap.Modal.getInstance(modalElement);
                if (copyModal) {
                    copyModal.hide();
                }
                // Remove modal backdrop manually if it exists
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                // Reset body style
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }
        }

        /**
         * Execute quote duplication
         * @param {string} quoteId - Quote ID to duplicate
         */
        function executeCopy(quoteId) {
            $.ajax({
                url: `${apiEndpoint}/${quoteId}/duplicate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function(response) {
                    if (response.success && response.data && response.data.quote) {
                        // Close modal properly
                        closeCopyModal();

                        const newFolio = response.data.quote.folio;
                        const newEventType = response.data.quote.eventType;

                        // Show success message with details
                        showSuccessAlert(
                            `Cotización duplicada exitosamente.<br>` +
                            `<strong>Nueva cotización:</strong> ${newFolio}<br>` +
                            `<strong>Tipo de evento:</strong> ${newEventType}`
                        );

                        // Reload table to show new quote
                        dataTable.ajax.reload(null, false);

                        // Reset stored ID
                        copyQuoteId = null;
                    } else {
                        closeCopyModal();
                        showErrorAlert(response.error || 'Error al duplicar la cotización');
                    }
                },
                error: function(xhr) {
                    // Close modal on error
                    closeCopyModal();

                    let errorMsg = 'Error al duplicar la cotización';

                    if (xhr.status === 404) {
                        errorMsg = 'Cotización no encontrada';
                    } else if (xhr.status === 403) {
                        errorMsg = 'No tiene permisos para duplicar cotizaciones';
                    } else if (xhr.status === 401) {
                        errorMsg = 'Sesión expirada. Por favor inicie sesión nuevamente';
                    } else if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }

                    showErrorAlert(errorMsg);
                }
            });
        }

        function openDeleteModal(quoteId, quoteFolio) {
            deleteQuoteId = quoteId;
            $('#deleteQuoteFolio').text(quoteFolio);
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteQuoteModal'));
            deleteModal.show();
        }

        function closeDeleteModal() {
            const modalElement = document.getElementById('deleteQuoteModal');
            if (modalElement) {
                const deleteModal = bootstrap.Modal.getInstance(modalElement);
                if (deleteModal) {
                    deleteModal.hide();
                }
                // Remove modal backdrop manually if it exists
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                // Reset body style
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }
        }

        function executeDelete(quoteId) {
            $.ajax({
                url: `${apiEndpoint}/${quoteId}`,
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({
                    reason: 'Quote deleted by user'
                }),
                success: function(response) {
                    if (response.success) {
                        // Close modal properly
                        closeDeleteModal();

                        // Show success message
                        showSuccessAlert('Cotización eliminada exitosamente');

                        // Reload table
                        dataTable.ajax.reload(null, false);

                        // Reset stored ID
                        deleteQuoteId = null;
                    } else {
                        closeDeleteModal();
                        showErrorAlert(response.error || 'Error al eliminar la cotización');
                    }
                },
                error: function(xhr) {
                    // Close modal on error
                    closeDeleteModal();

                    const errorMsg = xhr.responseJSON?.error || 'Error al eliminar la cotización';
                    showErrorAlert(errorMsg);
                }
            });
        }

        /**
         * Show success alert message
         * @param {string} message - Success message to display
         */
        function showSuccessAlert(message) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('quotes-content');
            if (container) {
                // Remove existing alerts
                container.querySelectorAll('.alert').forEach(el => el.remove());

                // Insert new alert at the beginning
                container.insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 5000);
            }
        }

        /**
         * Show error alert message
         * @param {string} message - Error message to display
         */
        function showErrorAlert(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('quotes-content');
            if (container) {
                // Remove existing alerts
                container.querySelectorAll('.alert').forEach(el => el.remove());

                // Insert new alert at the beginning
                container.insertAdjacentHTML('afterbegin', alertHtml);

                // Auto-dismiss after 8 seconds
                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 8000);
            }
        }

        // Reserved Quote Action Functions

        /**
         * Load payment info options for admin
         */
        async function loadPaymentInfoOptions() {
            const userRole = '<%= dtUserRole %>';
            if (userRole !== 'admin') return;

            const select = document.getElementById('paymentInfoSelect');
            if (!select) return;

            try {
                const response = await fetch('/api/payment-info', {
                    headers: {
                        'Authorization': `Bearer ${getAccessToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                // Clear loading option
                select.innerHTML = '<option value="">Sin información de pago</option>';
                
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(paymentInfo => {
                        const option = document.createElement('option');
                        option.value = paymentInfo.id;
                        option.textContent = paymentInfo.name;
                        
                        // Set default option as selected
                        if (paymentInfo.isDefault) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No hay métodos de pago configurados';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading payment info options:', error);
                select.innerHTML = '<option value="">Error al cargar métodos de pago</option>';
            }
        }

        /**
         * Open generate receipt confirmation modal
         * @param {string} quoteId - Quote ID to generate receipt for
         * @param {string} quoteFolio - Quote folio for display
         */
        function openGenerateReceiptModal(quoteId, quoteFolio) {
            generateReceiptQuoteId = quoteId;
            $('#receiptQuoteFolio').text(quoteFolio);
            
            // Load payment info options for admin
            loadPaymentInfoOptions();
            
            const receiptModal = new bootstrap.Modal(document.getElementById('generateReceiptModal'));
            receiptModal.show();
        }

        /**
         * Open request invoice confirmation modal
         * @param {string} quoteId - Quote ID to request invoice for
         * @param {string} quoteFolio - Quote folio for display
         */
        function openRequestInvoiceModal(quoteId, quoteFolio) {
            requestInvoiceQuoteId = quoteId;
            $('#invoiceQuoteFolio').text(quoteFolio);
            const invoiceModal = new bootstrap.Modal(document.getElementById('requestInvoiceModal'));
            invoiceModal.show();
        }

        /**
         * Open cancel reservation modal using the same implementation as quote summary
         * @param {string} quoteId - Quote ID to cancel reservation for
         * @param {string} quoteFolio - Quote folio for display
         */
        function openCancelReservationModal(quoteId, quoteFolio) {
            cancelReservationQuoteId = quoteId;
            
            // Fetch quote details first
            fetchQuoteForCancellation(quoteId, quoteFolio);
        }

        /**
         * Fetch quote details and show cancellation modal (same as quote summary)
         * @param {string} quoteId - Quote ID
         * @param {string} quoteFolio - Quote folio
         */
        async function fetchQuoteForCancellation(quoteId, quoteFolio) {
            try {
                const response = await fetch(`${apiEndpoint}/${quoteId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAccessToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error fetching quote: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success || !result.data) {
                    throw new Error('Invalid response from server');
                }

                // Use the same modal generation as quote summary
                showCancelReservationModal(result.data);
                
            } catch (error) {
                console.error('Error fetching quote:', error);
                showErrorAlert('No se pudo obtener la información de la cotización');
            }
        }

        /**
         * Show cancellation modal (identical to quote summary implementation)
         * @param {object} quote - Quote data
         */
        function showCancelReservationModal(quote) {
            // Get the earliest event date from service items to calculate hours before event
            let earliestEventDate = null;
            if (quote.serviceItems && quote.serviceItems.days && quote.serviceItems.days.length > 0) {
                quote.serviceItems.days.forEach(day => {
                    if (day.subconcepts && day.subconcepts.length > 0) {
                        day.subconcepts.forEach(subconcept => {
                            if (subconcept.startDate) {
                                const eventDate = new Date(subconcept.startDate);
                                if (!earliestEventDate || eventDate < earliestEventDate) {
                                    earliestEventDate = eventDate;
                                }
                            }
                        });
                    }
                });
            }

            // Calculate hours before event
            const now = new Date();
            const hoursBeforeEvent = earliestEventDate ? Math.max(0, Math.floor((earliestEventDate.getTime() - now.getTime()) / (1000 * 60 * 60))) : 0;
            const requiresApproval = hoursBeforeEvent < 24;

            // Format earliest event date
            const eventDateStr = earliestEventDate ? 
                earliestEventDate.toLocaleDateString('es-MX', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'No definida';

            // Create modal HTML (identical to quote summary)
            const modalHtml = `
                <div class="modal fade" id="cancelReservationModal" tabindex="-1" aria-labelledby="cancelReservationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="cancelReservationModalLabel">
                                    <i class="ti ti-x me-2"></i>Cancelar Reserva
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert ${requiresApproval ? 'alert-warning' : 'alert-info'}">
                                    <i class="ti ${requiresApproval ? 'ti-alert-triangle' : 'ti-info-circle'} me-2"></i>
                                    ${requiresApproval ? 
                                        `<strong>¡Atención!</strong> La cancelación es con menos de 24 horas de anticipación (${hoursBeforeEvent} horas restantes). Se creará una solicitud de cancelación que requerirá aprobación administrativa.` :
                                        `La cancelación es con más de 24 horas de anticipación (${hoursBeforeEvent} horas restantes). La reserva se cancelará automáticamente.`
                                    }
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Folio de Cotización</label>
                                        <div class="form-control-plaintext">${quote.folio || quote.id}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Fecha del Evento</label>
                                        <div class="form-control-plaintext">${eventDateStr}</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="cancellationReason" class="form-label fw-semibold">
                                        Motivo de la Cancelación <span class="text-danger">*</span>
                                    </label>
                                    <textarea 
                                        class="form-control" 
                                        id="cancellationReason" 
                                        rows="4" 
                                        placeholder="Por favor especifique el motivo de la cancelación..."
                                        required
                                    ></textarea>
                                </div>

                                <div class="alert alert-secondary">
                                    <h6><i class="ti ti-info-circle me-2"></i>Información del Proceso:</h6>
                                    <ul class="mb-0">
                                        ${requiresApproval ? 
                                            `<li>Se creará una solicitud de cancelación para revisión</li>
                                             <li>Un administrador revisará y aprobará/rechazará la solicitud</li>
                                             <li>Recibirá notificación del resultado</li>` :
                                            `<li>La reserva se cancelará inmediatamente</li>
                                             <li>Se enviará confirmación de cancelación</li>
                                             <li>No se requiere aprobación adicional</li>`
                                        }
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmCancellationBtn">
                                    <i class="ti ti-check me-2"></i>
                                    ${requiresApproval ? 'Crear Solicitud' : 'Cancelar Reserva'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('cancelReservationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Insert modal into DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Get modal element and show it
            const modalElement = document.getElementById('cancelReservationModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Attach confirmation button event listener
            document.getElementById('confirmCancellationBtn').addEventListener('click', () => {
                processCancellationRequest(quote, requiresApproval, hoursBeforeEvent, earliestEventDate, modal);
            });

            // Clean up modal when hidden
            modalElement.addEventListener('hidden.bs.modal', () => {
                modalElement.remove();
            });
        }

        /**
         * Execute receipt generation
         * @param {string} quoteId - Quote ID to generate receipt for
         */
        function executeGenerateReceipt(quoteId) {
            // Show loading state
            const confirmButton = $('#confirmGenerateReceiptBtn');
            const originalText = confirmButton.html();
            confirmButton.prop('disabled', true).html('<i class="ti ti-loader ti-spin me-1"></i>Generando...');

            // Get selected payment info (admin only)
            const userRole = '<%= dtUserRole %>';
            let includePaymentInfo = true; // Default for non-admin roles
            let selectedPaymentInfoId = null;
            
            if (userRole === 'admin') {
                const select = document.getElementById('paymentInfoSelect');
                if (select && select.value) {
                    selectedPaymentInfoId = select.value;
                    includePaymentInfo = true; // Include payment info if a method is selected
                } else {
                    includePaymentInfo = false; // No payment info if nothing selected
                }
            }

            // Create a form and submit it to trigger download
            const token = getAccessToken();
            const form = $('<form>', {
                'method': 'POST',
                'action': `${apiEndpoint}/${quoteId}/generate-receipt`,
                'target': '_blank'
            });

            // Add authorization header through a hidden input (for download)
            // Note: For file downloads, we'll use a different approach
            
            // Alternative approach: Use fetch API for better control
            fetch(`${apiEndpoint}/${quoteId}/generate-receipt`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    includePaymentInfo,
                    paymentInfoId: selectedPaymentInfoId 
                })
            })
            .then(response => {
                console.log('PDF generation response status:', response.status);
                console.log('PDF generation response headers:', response.headers);
                
                if (!response.ok) {
                    // Try to get the error message from the response
                    return response.json().then(errorData => {
                        console.error('Server error details:', errorData);
                        throw new Error(`${response.status}: ${errorData.error || errorData.message || 'Unknown server error'}`);
                    }).catch(jsonError => {
                        // If response isn't JSON, throw a generic error
                        console.error('Failed to parse error response:', jsonError);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                
                // Check if the response is a PDF
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    // Handle PDF download
                    return response.blob().then(blob => {
                        // Create download link
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Receipt-${quoteId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Show success message
                        closeGenerateReceiptModal();
                        showSuccessAlert('Recibo generado y descargado exitosamente');
                        dataTable.ajax.reload(null, false);
                        generateReceiptQuoteId = null;
                    });
                } else {
                    // Handle JSON response
                    return response.json().then(data => {
                        if (data.success) {
                            closeGenerateReceiptModal();
                            showSuccessAlert(data.message || 'Recibo generado exitosamente');
                            dataTable.ajax.reload(null, false);
                            generateReceiptQuoteId = null;
                        } else {
                            throw new Error(data.error || 'Error al generar el recibo');
                        }
                    });
                }
            })
            .catch(error => {
                console.error('PDF generation error:', error);
                closeGenerateReceiptModal();
                
                // Provide more detailed error information
                let errorMessage = 'Error al generar el recibo';
                if (error.message) {
                    if (error.message.includes('401')) {
                        errorMessage = 'Error de autenticación. Por favor, inicia sesión de nuevo.';
                    } else if (error.message.includes('403')) {
                        errorMessage = 'No tienes permisos para generar recibos.';
                    } else if (error.message.includes('404')) {
                        errorMessage = 'La cotización no fue encontrada.';
                    } else if (error.message.includes('500')) {
                        errorMessage = 'Error del servidor. Intenta de nuevo más tarde.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                }
                
                showErrorAlert(errorMessage);
            })
            .finally(() => {
                // Reset button state
                confirmButton.prop('disabled', false).html(originalText);
            });
        }

        /**
         * Execute invoice request
         * @param {string} quoteId - Quote ID to request invoice for
         */
        function executeRequestInvoice(quoteId) {
            $.ajax({
                url: `${apiEndpoint}/${quoteId}/request-invoice`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function(response) {
                    if (response.success) {
                        closeRequestInvoiceModal();
                        showSuccessAlert(response.message || 'Solicitud de factura enviada exitosamente');
                        dataTable.ajax.reload(null, false);
                        requestInvoiceQuoteId = null;
                    } else {
                        closeRequestInvoiceModal();
                        showErrorAlert(response.error || 'Error al solicitar la factura');
                    }
                },
                error: function(xhr) {
                    closeRequestInvoiceModal();
                    const errorMsg = xhr.responseJSON?.error || 'Error al solicitar la factura';
                    showErrorAlert(errorMsg);
                }
            });
        }

        /**
         * Process cancellation request (identical to quote summary implementation)
         * @param {object} quote - Quote data
         * @param {boolean} requiresApproval - Whether approval is required
         * @param {number} hoursBeforeEvent - Hours before event
         * @param {Date|null} eventDate - Event date
         * @param {object} modal - Modal instance
         */
        async function processCancellationRequest(quote, requiresApproval, hoursBeforeEvent, eventDate, modal) {
            const reason = document.getElementById('cancellationReason').value.trim();

            // Validate input
            if (!reason) {
                alert('Por favor ingrese un motivo para la cancelación');
                return;
            }

            // Show loading state
            const btn = document.getElementById('confirmCancellationBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
            btn.disabled = true;

            try {
                // Get access token
                const token = getAccessToken();

                // Prepare request data
                const requestData = {
                    reason: reason,
                    hoursBeforeEvent: hoursBeforeEvent,
                    eventDate: eventDate ? eventDate.toISOString() : null
                };

                // Call API to create cancellation request
                const response = await fetch('/api/cancellation-requests', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quoteFolio: quote.folio || quote.id,
                        ...requestData
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Error al procesar la cancelación');
                }

                // Close modal
                modal.hide();

                // Show success message based on cancellation type
                if (result.data.directCancellation || result.data.cancellationType === 'direct' || result.message.includes('cancelled successfully')) {
                    // Direct cancellation (24+ hours or no event date)
                    const message = result.message.includes('no event date') 
                        ? 'La reserva ha sido cancelada exitosamente.\n\n(No se encontró fecha de evento - cancelación automática)'
                        : 'La reserva ha sido cancelada exitosamente.';
                    alert(message);
                    // Refresh the table to show updated status
                    dataTable.ajax.reload(null, false);
                } else {
                    // Cancellation request created for approval (<24 hours)
                    alert(`Solicitud de cancelación creada exitosamente.\n\nID: ${result.data.requestId}\nEstado: Pendiente de aprobación\n\nRecibirá una notificación cuando sea revisada.`);
                    // Optional: Refresh to update UI
                    dataTable.ajax.reload(null, false);
                }

            } catch (error) {
                console.error('Error processing cancellation:', error);
                alert(`Error al procesar la cancelación: ${error.message}`);

                // Restore button state
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        /**
         * Close generate receipt modal properly
         */
        function closeGenerateReceiptModal() {
            const modalElement = document.getElementById('generateReceiptModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                cleanupModal();
            }
        }

        /**
         * Close request invoice modal properly
         */
        function closeRequestInvoiceModal() {
            const modalElement = document.getElementById('requestInvoiceModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                cleanupModal();
            }
        }

        /**
         * Close cancel reservation modal properly
         */
        function closeCancelReservationModal() {
            const modalElement = document.getElementById('cancelReservationModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                cleanupModal();
            }
        }

        /**
         * Clean up modal remnants
         */
        function cleanupModal() {
            // Remove modal backdrop manually if it exists
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            // Remove modal-open class from body
            document.body.classList.remove('modal-open');
            // Reset body style
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }
    }

    // Start initialization when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
        initWhenReady();
    }
})();
</script>
