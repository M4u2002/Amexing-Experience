<%
/**
 * Sidebar Menu Organism
 * Role-based navigation menu items
 *
 * @param {string} userRole - Current user role
 * @param {string} currentPath - Current page path for active states
 * @param {object} colors - Role color scheme
 * @param {function} isActiveMenuItem - Helper function to check active state
 */

const rolesHierarchy = {
  superadmin: 7,
  admin: 6,
  client: 5,
  department_manager: 4,
  employee: 3,
  driver: 2,
  guest: 1
};

const allDashboards = [
  { name: "Dashboard Super Admin", icon: "settings", path: "/dashboard/superadmin", level: 7 },
  { name: "Dashboard Admin", icon: "shield-check", path: "/dashboard/admin", level: 6 },
  { name: "Dashboard Department Manager", icon: "screen-share", path: "/dashboard/department-manager", level: 5 },
  { name: "Dashboard Employee", icon: "building", path: "/dashboard/employee", level: 4 },
  { name: "Dashboard Driver", icon: "steering-wheel", path: "/dashboard/driver", level: 3 },
  { name: "Dashboard Client", icon: "user", path: "/dashboard/client", level: 2 },
  { name: "Dashboard Guest", icon: "world", path: "/dashboard/guest", level: 1 }
];
const dashboards =allDashboards.filter( dashboard => dashboard.level <= rolesHierarchy[user.role] );

// Navigation items based on role
const navigationItems = {
    superadmin: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Super Admin', icon: 'settings', path: '/dashboard/superadmin', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        // Users System Section - User Management and Role Management
        { section: 'Users System', icon: 'ti-users', items: [
            { name: 'User Management', icon: 'users', path: '/dashboard/superadmin/users', id: 'users' },
            { name: 'Role Management', icon: 'shield', path: '/dashboard/superadmin/roles', id: 'roles' },
            { name: 'Reportes', icon: 'report', path: '/dashboard/superadmin/reports', id: 'reports' },
            { name: 'Correos', icon: 'mail', path: '/dashboard/superadmin/emails', id: 'emails' }
        ]},
        // Tarifario Section
        { section: 'Tarifario', icon: 'ti-receipt-2', items: [
            { name: 'Gestión de Vehículos', icon: 'car', path: '/dashboard/superadmin/vehicles', id: 'vehicles' },
            { name: 'Gestión de Traslados', icon: 'briefcase', path: '/dashboard/superadmin/services', id: 'services' },
            { name: 'Gestión de Experiencias', icon: 'star', path: '/dashboard/superadmin/experiences', id: 'experiences' },
            { name: 'Gestión de Tours', icon: 'map', path: '/dashboard/superadmin/tours', id: 'tours' }
        ]},
        // Equipo y Recursos Section
        { section: 'Equipo y Recursos', icon: 'ti-users', items: [
            { name: 'Gestión de Empleados', icon: 'user-check', path: '/dashboard/superadmin/employees', id: 'employees' },
            { name: 'Gestión de Destinos', icon: 'map-pin', path: '/dashboard/superadmin/pois', id: 'pois' }
        ]}
    ],
    admin: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Admin', icon: 'shield-check', path: '/dashboard/admin', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'Operaciones Principales', icon: 'ti-dashboard', items: [
            { name: 'Tablero', icon: 'dashboard', path: '/dashboard/admin', id: 'dashboard' },
            { name: 'Clientes', icon: 'users', path: '/dashboard/admin/clients', id: 'clients' },
            { name: 'Reservaciones', icon: 'clipboard-list', path: '/dashboard/admin/bookings', id: 'bookings' },
            { name: 'Cotizaciones', icon: 'file-invoice', path: '/dashboard/admin/quotes', id: 'quotes' },
            { name: 'Ajustes de Precio', icon: 'settings', path: '/dashboard/admin/price-settings', id: 'price-settings' }
        ]},
        { section: 'Tarifario', icon: 'ti-receipt-2', items: [
            { name: 'Vehículos', icon: 'car', path: '/dashboard/admin/vehicles', id: 'vehicles' },
            { name: 'Traslados', icon: 'briefcase', path: '/dashboard/admin/services', id: 'services' },
            { name: 'Experiencias', icon: 'star', path: '/dashboard/admin/experiences', id: 'experiences' },
            { name: 'Tours', icon: 'map', path: '/dashboard/admin/tours', id: 'tours' }
        ]},
        { section: 'Gestión', icon: 'ti-users', items: [
            { name: 'Facturas', icon: 'receipt', path: '/dashboard/admin/invoices', id: 'invoices', badge: { text: '0', color: 'warning' } },
            { name: 'Empleados', icon: 'user-check', path: '/dashboard/admin/employees', id: 'employees' },
            { name: 'Destinos', icon: 'map-pin', path: '/dashboard/admin/pois', id: 'pois' },
            { name: 'Métodos de Pago', icon: 'credit-card', path: '/dashboard/admin/payment-info', id: 'payment-info' }
        ]}
    ],
    client: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Client', icon: 'user', path: '/dashboard/client', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'My Business', icon: 'ti-building', items: [
            { name: 'Dashboard', icon: 'dashboard', path: '/dashboard/client', id: 'dashboard' },
            { name: 'My Events', icon: 'calendar-event', path: '/dashboard/client/events', id: 'events' },
            { name: 'Landing Pages', icon: 'world', path: '/dashboard/client/landing-pages', id: 'landing-pages' },
            { name: 'My Bookings', icon: 'car', path: '/dashboard/client/bookings', id: 'bookings' }
        ]},
        { section: 'Services & Billing', icon: 'ti-credit-card', items: [
            { name: 'Services', icon: 'list', path: '/dashboard/client/services', id: 'services' },
            { name: 'Billing & Payments', icon: 'receipt', path: '/dashboard/client/billing', id: 'billing' }
        ]}
    ],
    department_manager: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Department Manager', icon: 'screen-share', path: '/dashboard/department_manager', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'Team Management', icon: 'ti-users', items: [
            { name: 'Dashboard', icon: 'dashboard', path: '/dashboard/department_manager', id: 'dashboard' },
            { name: 'My Team', icon: 'users', path: '/dashboard/department_manager/team', id: 'team' },
            { name: 'Team Bookings', icon: 'car', path: '/dashboard/department_manager/bookings', id: 'bookings' },
            { name: 'Cotizaciones', icon: 'file-invoice', path: '/dashboard/department_manager/quotes', id: 'quotes' },
            { name: 'Facturas', icon: 'receipt', path: '/dashboard/department_manager/invoices', id: 'invoices' }
        ]},
        { section: 'Servicios', icon: 'ti-briefcase', items: [
            { name: 'Vehículos', icon: 'car', path: '/dashboard/department_manager/vehicles', id: 'vehicles' },
            { name: 'Traslados', icon: 'briefcase', path: '/dashboard/department_manager/services', id: 'services' },
            { name: 'Experiencias', icon: 'star', path: '/dashboard/department_manager/experiences', id: 'experiences' },
            { name: 'Tours', icon: 'map', path: '/dashboard/department_manager/tours', id: 'tours' }
        ]}
    ],
    employee: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Employee', icon: 'building', path: '/dashboard/employee', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'My Services', icon: 'ti-user', items: [
            { name: 'Dashboard', icon: 'dashboard', path: '/dashboard/employee', id: 'dashboard' },
            { name: 'My Bookings', icon: 'car', path: '/dashboard/employee/bookings', id: 'bookings' },
            { name: 'Available Services', icon: 'list', path: '/dashboard/employee/services', id: 'services' },
            { name: 'My Profile', icon: 'user', path: '/dashboard/employee/profile', id: 'profile' }
        ]}
    ],
    driver: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Driver', icon: 'steering-wheel', path: '/dashboard/driver', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'My Trips', icon: 'ti-car', items: [
            { name: 'Dashboard', icon: 'dashboard', path: '/dashboard/driver', id: 'dashboard' },
            { name: 'Active Trips', icon: 'route', path: '/dashboard/driver/trips', id: 'trips' },
            { name: 'My Schedule', icon: 'calendar', path: '/dashboard/driver/schedule', id: 'schedule' },
            { name: 'My Vehicle', icon: 'car', path: '/dashboard/driver/vehicle', id: 'vehicle' },
            { name: 'Trip History', icon: 'history', path: '/dashboard/driver/history', id: 'history' }
        ]}
    ],
    guest: [
        // System Management Section - Only Dashboard
        { section: 'System Management', icon: 'ti-settings', items: [
            { name: 'Dashboard Guest', icon: 'world', path: '/dashboard/guest', id: 'dashboard',
              dropdown: dashboards
            }
        ]},
        { section: 'Welcome', icon: 'ti-home', items: [
            { name: 'Home', icon: 'home', path: '/', id: 'home' }
        ]}
    ]
};

const menuSections = navigationItems[userRole] || navigationItems.guest;
%>

<ul id="sidebarnav" class="list-unstyled">
  <% menuSections.forEach(function(section, sectionIndex) { %>
  <!-- Section Header -->
  <li class="nav-small-cap">
    <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
    <span class="hide-menu"><%= section.section %></span>
  </li>

  <!-- Section Items -->
  <% section.items.forEach(function(item, itemIndex) { %>
  <% const isActive = isActiveMenuItem(item.path, currentPath); %>

  <%- include('../../../molecules/dashboard/nav-item', {
                href: item.path,
                icon: item.icon,
                text: item.name,
                active: isActive,
                badge: item.badge,
                submenu: item.submenu,
                id: item.id,
                external: item.external,
                dropdown: item.dropdown ? item.dropdown : [],
            }) %>
  <% }); %>
  <% }); %>

  <!-- User Section -->
  <%- include('./sidebar-footer', {
        userRole: userRole,
        currentPath: currentPath
    }) %>
</ul>

<style>
  /* Section Headers */
  .nav-small-cap {
    color: #6c757d;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.6875rem;
    letter-spacing: 1px;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    padding: 0 20px;
    position: relative;
  }

  .nav-small-cap:first-child {
    margin-top: 1rem;
  }

  .nav-small-cap .nav-small-cap-icon {
    color: <%=colors.primary %>;
    margin-right: 8px;
    font-size: 0.75rem;
  }

  .nav-small-cap .hide-menu {
    position: relative;
  }

  /* Sidebar Menu Animations */
  #sidebarnav .sidebar-item {
    opacity: 0;
    transform: translateX(-10px);
    animation: slideInNav 0.3s ease forwards;
  }

  <% menuSections.forEach(function(section, sectionIndex) {
      %> <% section.items.forEach(function(item, itemIndex) {
          %> #sidebarnav .sidebar-item:nth-child(<%=sectionIndex * (section.items.length + 1) + itemIndex + 2 %>) {
            animation-delay: <%=(sectionIndex * section.items.length + itemIndex) * 0.05 %>s;
          }

          <%
        }

      ); %> <%
    }

  );

  %>@keyframes slideInNav {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Role-specific accent colors */
  #sidebarnav .nav-small-cap-icon,
  #sidebarnav .sidebar-link:hover .nav-icon,
  #sidebarnav .sidebar-link.active .nav-icon {
    color: <%=colors.primary %>;
  }

  #sidebarnav .sidebar-link:hover,
  #sidebarnav .sidebar-link.active {
    background: linear-gradient(135deg, <%=colors.primary %>10, <%=colors.secondary %>10);
    color: <%=colors.primary %>;
  }

  /* Badge animations */
  .nav-badge {
    /* No animation */
  }

  /* Loading state for menu items */
  .sidebar-item.loading {
    pointer-events: none;
    opacity: 0.6;
  }

  .sidebar-item.loading::after {
    content: '';
    position: absolute;
    right: 20px;
    top: 50%;
    width: 12px;
    height: 12px;
    border: 1px solid transparent;
    border-top: 1px solid <%=colors.primary %>;
    border-radius: 50%;
    animation: nav-item-loading 1s linear infinite;
    transform: translateY(-50%);
  }

  @keyframes nav-item-loading {
    0% {
      transform: translateY(-50%) rotate(0deg);
    }

    100% {
      transform: translateY(-50%) rotate(360deg);
    }
  }

  /* Hover effects for better UX */
  .sidebar-link {
    position: relative;
    overflow: hidden;
  }

  .sidebar-link::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 3px;
    height: 100%;
    background: <%=colors.primary %>;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .sidebar-link.active::before,
  .sidebar-link:hover::before {
    transform: translateX(0);
  }

  /* Responsive adjustments */
  @media (max-width: 991.98px) {
    .nav-small-cap {
      padding: 0 15px;
      font-size: 0.625rem;
    }

    #sidebarnav .sidebar-link {
      padding: 14px 15px;
    }
  }
</style>