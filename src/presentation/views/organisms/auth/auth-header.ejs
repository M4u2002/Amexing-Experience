<%
/**
 * Auth Header Organism
 * Comprehensive authentication page header with branding, navigation, and context
 *
 * @param {string} page - Current auth page (login, register, forgot-password, etc.)
 * @param {string} title - Page title
 * @param {string} subtitle - Page subtitle/description
 * @param {object} branding - Branding configuration
 * @param {boolean} showLogo - Whether to show company logo
 * @param {boolean} showNavigation - Whether to show auth navigation
 * @param {boolean} showLanguageSelector - Whether to show language selector
 * @param {array} breadcrumbs - Breadcrumb navigation items
 * @param {object} corporate - Corporate branding override
 */

// Default parameters
const authPage = typeof page !== 'undefined' ? page : 'login';
const authTitle = typeof title !== 'undefined' ? title : '';
const authSubtitle = typeof subtitle !== 'undefined' ? subtitle : '';
const authBranding = typeof branding !== 'undefined' ? branding : {};
const authShowLogo = typeof showLogo !== 'undefined' ? showLogo : true;
const authShowNavigation = typeof showNavigation !== 'undefined' ? showNavigation : true;
const authShowLanguage = typeof showLanguageSelector !== 'undefined' ? showLanguageSelector : false;
const authBreadcrumbs = typeof breadcrumbs !== 'undefined' ? breadcrumbs : [];
const authCorporate = typeof corporate !== 'undefined' ? corporate : null;

// Page configurations
const pageConfig = {
    login: {
        title: 'Welcome Back',
        subtitle: 'Sign in to your account to continue',
        icon: 'ti-login',
        showBackButton: false
    },
    register: {
        title: 'Create Account',
        subtitle: 'Join us and start your journey today',
        icon: 'ti-user-plus',
        showBackButton: true,
        backText: 'Back to Login',
        backUrl: '/auth/login'
    },
    'forgot-password': {
        title: 'Reset Password',
        subtitle: 'Enter your email to receive reset instructions',
        icon: 'ti-key',
        showBackButton: true,
        backText: 'Back to Login',
        backUrl: '/auth/login'
    },
    'choose-password': {
        title: 'Set New Password',
        subtitle: 'Create a strong password for your account',
        icon: 'ti-shield-lock',
        showBackButton: false
    },
    'verify-email': {
        title: 'Verify Email',
        subtitle: 'Check your email for verification instructions',
        icon: 'ti-mail-check',
        showBackButton: true,
        backText: 'Back to Login',
        backUrl: '/auth/login'
    },
    'oauth-login': {
        title: 'Quick Sign In',
        subtitle: 'Choose your preferred authentication method',
        icon: 'ti-apps',
        showBackButton: false
    }
};

const config = pageConfig[authPage] || pageConfig.login;
const finalTitle = authTitle || config.title;
const finalSubtitle = authSubtitle || config.subtitle;

// Effective branding (corporate overrides default)
const effectiveBranding = authCorporate ? {
    ...authBranding,
    logo: authCorporate.logo || authBranding.logo,
    name: authCorporate.name || authBranding.name,
    colors: authCorporate.colors || authBranding.colors
} : authBranding;
%>

<header class="auth-header">
    <!-- Top Navigation Bar -->
    <div class="auth-nav-bar">
        <div class="container-fluid">
            <div class="row align-items-center">
                <!-- Logo Section -->
                <div class="col-6 col-md-4">
                    <% if (authShowLogo) { %>
                        <div class="auth-logo-section">
                            <a href="/" class="auth-logo-link d-flex align-items-center text-decoration-none">
                                <% if (effectiveBranding.logo) { %>
                                    <img src="<%= effectiveBranding.logo %>"
                                         alt="<%= effectiveBranding.name || 'Logo' %>"
                                         class="auth-logo me-2">
                                <% } else { %>
                                    <div class="auth-logo-placeholder me-2">
                                        <i class="ti ti-brand-tabler fs-1 text-primary"></i>
                                    </div>
                                <% } %>

                                <% if (effectiveBranding.name) { %>
                                    <span class="auth-brand-name fw-bold text-dark d-none d-sm-inline">
                                        <%= effectiveBranding.name %>
                                    </span>
                                <% } %>
                            </a>

                            <!-- Corporate Badge -->
                            <% if (authCorporate && authCorporate.name) { %>
                                <div class="corporate-badge mt-1">
                                    <small class="text-muted">
                                        <i class="ti ti-building me-1"></i>
                                        <%= authCorporate.name %>
                                    </small>
                                </div>
                            <% } %>
                        </div>
                    <% } %>
                </div>

                <!-- Navigation Section -->
                <div class="col-6 col-md-8">
                    <div class="auth-nav-actions d-flex align-items-center justify-content-end">
                        <!-- Language Selector -->
                        <% if (authShowLanguage) { %>
                            <div class="language-selector me-3">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                            type="button"
                                            id="languageDropdown"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                        <i class="ti ti-language me-1"></i>
                                        <span class="d-none d-sm-inline">EN</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                                        <li><a class="dropdown-item" href="?lang=es">Español</a></li>
                                        <li><a class="dropdown-item" href="?lang=fr">Français</a></li>
                                    </ul>
                                </div>
                            </div>
                        <% } %>

                        <!-- Back Button -->
                        <% if (config.showBackButton && authShowNavigation) { %>
                            <a href="<%= config.backUrl %>"
                               class="btn btn-outline-secondary btn-sm auth-back-btn">
                                <i class="ti ti-arrow-left me-1"></i>
                                <span class="d-none d-sm-inline"><%= config.backText %></span>
                                <span class="d-inline d-sm-none">Back</span>
                            </a>
                        <% } %>

                        <!-- Help Link -->
                        <div class="auth-help-link ms-3">
                            <a href="/help" class="text-muted text-decoration-none">
                                <i class="ti ti-help-circle"></i>
                                <span class="d-none d-md-inline ms-1">Help</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <% if (authBreadcrumbs && authBreadcrumbs.length > 0) { %>
        <div class="auth-breadcrumbs">
            <div class="container-fluid">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <% authBreadcrumbs.forEach((crumb, index) => { %>
                            <li class="breadcrumb-item <%= index === authBreadcrumbs.length - 1 ? 'active' : '' %>">
                                <% if (index === authBreadcrumbs.length - 1) { %>
                                    <%= crumb.text %>
                                <% } else { %>
                                    <a href="<%= crumb.url %>" class="text-decoration-none">
                                        <%= crumb.text %>
                                    </a>
                                <% } %>
                            </li>
                        <% }) %>
                    </ol>
                </nav>
            </div>
        </div>
    <% } %>

    <!-- Main Header Content -->
    <div class="auth-header-content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <!-- Page Icon -->
                    <div class="auth-page-icon text-center mb-3">
                        <div class="icon-wrapper">
                            <i class="<%= config.icon %> auth-icon"></i>
                        </div>
                    </div>

                    <!-- Page Title -->
                    <div class="auth-title-section text-center">
                        <h1 class="auth-title mb-3">
                            <%= finalTitle %>
                        </h1>

                        <% if (finalSubtitle) { %>
                            <p class="auth-subtitle text-muted mb-0">
                                <%= finalSubtitle %>
                            </p>
                        <% } %>
                    </div>

                    <!-- Progress Indicator (for multi-step flows) -->
                    <% if (authPage === 'register' || authPage === 'choose-password') { %>
                        <div class="auth-progress mt-4">
                            <div class="progress-steps d-flex justify-content-center">
                                <div class="step <%= authPage === 'register' ? 'active' : 'completed' %>">
                                    <div class="step-circle">
                                        <% if (authPage === 'choose-password') { %>
                                            <i class="ti ti-check"></i>
                                        <% } else { %>
                                            1
                                        <% } %>
                                    </div>
                                    <small class="step-label">Account Info</small>
                                </div>
                                <div class="step-connector"></div>
                                <div class="step <%= authPage === 'choose-password' ? 'active' : '' %>">
                                    <div class="step-circle">2</div>
                                    <small class="step-label">Password</small>
                                </div>
                                <div class="step-connector"></div>
                                <div class="step">
                                    <div class="step-circle">3</div>
                                    <small class="step-label">Complete</small>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</header>

<style>
    .auth-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }

    .auth-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.5;
        z-index: 1;
    }

    /* Top Navigation */
    .auth-nav-bar {
        padding: 1rem 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        position: relative;
        z-index: 2;
    }

    .auth-logo {
        height: 32px;
        width: auto;
        transition: all 0.3s ease;
    }

    .auth-logo:hover {
        transform: scale(1.05);
    }

    .auth-logo-placeholder {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .auth-brand-name {
        font-size: 1.25rem;
        color: #2c3e50;
        transition: color 0.3s ease;
    }

    .auth-logo-link:hover .auth-brand-name {
        color: #667eea;
    }

    .corporate-badge {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 12px;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }

    /* Navigation Actions */
    .auth-nav-actions .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .auth-nav-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .auth-help-link a {
        font-size: 0.875rem;
        transition: color 0.3s ease;
    }

    .auth-help-link a:hover {
        color: #667eea !important;
    }

    /* Breadcrumbs */
    .auth-breadcrumbs {
        background: rgba(255, 255, 255, 0.7);
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        position: relative;
        z-index: 2;
    }

    .breadcrumb {
        margin-bottom: 0;
        font-size: 0.875rem;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: #6c757d;
    }

    /* Header Content */
    .auth-header-content {
        padding: 3rem 0 2rem;
        position: relative;
        z-index: 2;
    }

    .auth-page-icon {
        margin-bottom: 1.5rem;
    }

    .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 50%;
        position: relative;
        overflow: hidden;
    }

    .icon-wrapper::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        animation: iconShimmer 3s infinite;
    }

    .auth-icon {
        font-size: 2rem;
        color: #667eea;
        position: relative;
        z-index: 2;
    }

    @keyframes iconShimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(360deg); }
    }

    /* Title Section */
    .auth-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 1rem;
        line-height: 1.2;
    }

    .auth-subtitle {
        font-size: 1.125rem;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Progress Steps */
    .auth-progress {
        max-width: 400px;
        margin: 0 auto;
    }

    .progress-steps {
        align-items: center;
        gap: 0;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 0 0 auto;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }

    .step.active .step-circle {
        background: #667eea;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .step.completed .step-circle {
        background: #28a745;
        color: white;
    }

    .step-label {
        font-weight: 500;
        color: #6c757d;
        text-align: center;
    }

    .step.active .step-label {
        color: #667eea;
        font-weight: 600;
    }

    .step-connector {
        flex: 1;
        height: 2px;
        background: #e9ecef;
        margin: 0 1rem;
        position: relative;
        top: -20px;
        min-width: 60px;
    }

    .step.completed + .step-connector {
        background: #28a745;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .auth-header-content {
            padding: 2rem 0 1.5rem;
        }

        .auth-title {
            font-size: 2rem;
        }

        .auth-subtitle {
            font-size: 1rem;
        }

        .icon-wrapper {
            width: 60px;
            height: 60px;
        }

        .auth-icon {
            font-size: 1.5rem;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }

        .step-connector {
            min-width: 40px;
            top: -16px;
        }
    }

    @media (max-width: 576px) {
        .auth-nav-bar {
            padding: 0.75rem 0;
        }

        .progress-steps {
            transform: scale(0.9);
        }
    }

    /* Dark Theme */
    [data-theme="dark"] .auth-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    [data-theme="dark"] .auth-nav-bar {
        background: rgba(0, 0, 0, 0.3);
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .auth-title {
        color: #fff;
    }

    [data-theme="dark"] .auth-subtitle {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Print Styles */
    @media print {
        .auth-nav-bar,
        .auth-breadcrumbs,
        .auth-progress {
            display: none;
        }

        .auth-header-content {
            padding: 1rem 0;
        }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
        .icon-wrapper::before,
        .auth-logo,
        .step-circle,
        * {
            animation: none !important;
            transition: none !important;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const authHeader = document.querySelector('.auth-header');
    const authPage = '<%= authPage %>';

    // Logo click tracking
    const logoLink = document.querySelector('.auth-logo-link');
    if (logoLink) {
        logoLink.addEventListener('click', function() {

            if (typeof gtag !== 'undefined') {
                gtag('event', 'auth_logo_click', {
                    page: authPage
                });
            }
        });
    }

    // Help link tracking
    const helpLink = document.querySelector('.auth-help-link a');
    if (helpLink) {
        helpLink.addEventListener('click', function() {
            console.log('❓ Auth help link clicked');

            if (typeof gtag !== 'undefined') {
                gtag('event', 'auth_help_click', {
                    page: authPage
                });
            }
        });
    }

    // Back button tracking
    const backButton = document.querySelector('.auth-back-btn');
    if (backButton) {
        backButton.addEventListener('click', function() {

            if (typeof gtag !== 'undefined') {
                gtag('event', 'auth_back_click', {
                    from_page: authPage,
                    to_url: this.href
                });
            }
        });
    }

    // Language selector handling
    const languageDropdown = document.getElementById('languageDropdown');
    if (languageDropdown) {
        const languageItems = document.querySelectorAll('.language-selector .dropdown-item');
        languageItems.forEach(item => {
            item.addEventListener('click', function(e) {
                const lang = this.href.split('lang=')[1];

                if (typeof gtag !== 'undefined') {
                    gtag('event', 'language_change', {
                        page: authPage,
                        language: lang
                    });
                }
            });
        });
    }

    // Progress step animation (for multi-step flows)
    const progressSteps = document.querySelectorAll('.step');
    progressSteps.forEach((step, index) => {
        if (step.classList.contains('active')) {
            // Animate to current step
            setTimeout(() => {
                step.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    step.style.transform = 'scale(1)';
                }, 200);
            }, index * 100);
        }
    });

    // Scroll to content on mobile if header is tall
    if (window.innerWidth <= 768) {
        const headerHeight = authHeader.offsetHeight;
        if (headerHeight > window.innerHeight * 0.6) {
            // Header is too tall, add smooth scroll to content
            setTimeout(() => {
                const content = document.querySelector('.auth-form-section, .auth-content');
                if (content) {
                    content.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }

        page: authPage,
        showLogo: <%= authShowLogo %>,
        showNavigation: <%= authShowNavigation %>,
        showLanguage: <%= authShowLanguage %>,
        hasCorporate: <%= !!authCorporate %>
    });
});
</script>