<%
/**
 * Password Input Atom
 * Advanced password input with strength indicator and validation
 *
 * @param {string} name - Input name attribute
 * @param {string} id - Input id attribute
 * @param {string} label - Input label text
 * @param {string} placeholder - Placeholder text
 * @param {boolean} required - Whether input is required
 * @param {string} value - Default value
 * @param {boolean} showStrength - Whether to show strength indicator
 * @param {boolean} showRequirements - Whether to show requirements list
 * @param {object} requirements - Custom requirements object
 * @param {string} autocomplete - Autocomplete value (new-password, current-password)
 * @param {string} size - Input size (sm, md, lg)
 */

// Default parameters
const passwordName = typeof name !== 'undefined' ? name : 'password';
const passwordId = typeof id !== 'undefined' ? id : passwordName || 'password_' + Math.random().toString(36).substr(2, 9);
const passwordLabel = typeof label !== 'undefined' ? label : 'Password';
const passwordPlaceholder = typeof placeholder !== 'undefined' ? placeholder : 'Enter your password';
const passwordRequired = typeof required !== 'undefined' ? required : false;
const passwordValue = typeof value !== 'undefined' ? value : '';
const passwordShowStrength = typeof showStrength !== 'undefined' ? showStrength : true;
const passwordShowRequirements = typeof showRequirements !== 'undefined' ? showRequirements : true;
const passwordAutocomplete = typeof autocomplete !== 'undefined' ? autocomplete : 'current-password';
const passwordSize = typeof size !== 'undefined' ? size : 'md';

// Default requirements
const defaultRequirements = {
    minLength: 12,
    uppercase: true,
    lowercase: true,
    numbers: true,
    special: true
};

const passwordRequirements = typeof requirements !== 'undefined' ?
    Object.assign({}, defaultRequirements, requirements) : defaultRequirements;

// Size configurations
const sizeConfig = {
    sm: { controlClass: 'form-control', groupClass: 'input-group-sm' },
    md: { controlClass: 'form-control form-control-lg', groupClass: '' },
    lg: { controlClass: 'form-control form-control-lg', groupClass: 'input-group-lg' }
};

const config = sizeConfig[passwordSize] || sizeConfig.md;
%>

<div class="password-input-wrapper mb-3">
    <!-- Label -->
    <label for="<%= passwordId %>" class="form-label text-dark fw-semibold d-flex align-items-center">
        <i class="ti ti-lock me-2 text-primary"></i>
        <%= passwordLabel %>
        <% if (passwordRequired) { %>
            <span class="text-danger ms-1">*</span>
        <% } %>
    </label>

    <!-- Password Input Group -->
    <div class="input-group <%= config.groupClass %> password-input-group">
        <!-- Lock Icon -->
        <span class="input-group-text bg-light-subtle border-end-0">
            <i class="ti ti-lock text-muted"></i>
        </span>

        <!-- Password Input -->
        <input
            type="password"
            class="<%= config.controlClass %> border-start-0 border-end-0 password-field"
            id="<%= passwordId %>"
            name="<%= passwordName %>"
            placeholder="<%= passwordPlaceholder %>"
            value="<%= passwordValue %>"
            <% if (passwordRequired) { %>required<% } %>
            <% if (passwordRequirements.minLength) { %>minlength="<%= passwordRequirements.minLength %>"<% } %>
            autocomplete="<%= passwordAutocomplete %>"
            data-password-input="true"
        >

        <!-- Password Toggle -->
        <button class="btn btn-outline-secondary password-toggle-btn"
                type="button"
                data-target="<%= passwordId %>"
                aria-label="Toggle password visibility"
                tabindex="-1">
            <i class="ti ti-eye password-toggle-icon"></i>
        </button>

        <!-- Validation Feedback -->
        <div class="invalid-feedback">
            Please enter a valid password meeting all requirements.
        </div>

        <div class="valid-feedback">
            Strong password! âœ“
        </div>
    </div>

    <!-- Password Strength Indicator -->
    <% if (passwordShowStrength) { %>
        <div class="password-strength mt-2">
            <div class="d-flex align-items-center justify-content-between mb-1">
                <small class="text-muted">Password Strength</small>
                <small class="password-strength-text text-muted">Enter a password</small>
            </div>
            <div class="progress" style="height: 4px; border-radius: 2px;">
                <div class="progress-bar password-strength-bar transition-all"
                     role="progressbar"
                     style="width: 0%"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
            </div>
        </div>
    <% } %>

    <!-- Password Requirements -->
    <% if (passwordShowRequirements) { %>
        <div class="password-requirements mt-3">
            <div class="d-flex align-items-center mb-2">
                <small class="text-muted fw-semibold">Password must contain:</small>
                <button type="button"
                        class="btn btn-link btn-sm p-0 ms-2 requirements-toggle"
                        data-bs-toggle="collapse"
                        data-bs-target="#requirements-<%= passwordId %>"
                        aria-expanded="true">
                    <i class="ti ti-chevron-up requirements-chevron"></i>
                </button>
            </div>

            <div class="collapse show" id="requirements-<%= passwordId %>">
                <ul class="list-unstyled small requirements-list">
                    <% if (passwordRequirements.minLength) { %>
                        <li class="requirement mb-1" data-requirement="length">
                            <i class="ti ti-x text-danger me-2 requirement-icon"></i>
                            <span class="requirement-text">At least <%= passwordRequirements.minLength %> characters</span>
                        </li>
                    <% } %>

                    <% if (passwordRequirements.uppercase) { %>
                        <li class="requirement mb-1" data-requirement="uppercase">
                            <i class="ti ti-x text-danger me-2 requirement-icon"></i>
                            <span class="requirement-text">One uppercase letter (A-Z)</span>
                        </li>
                    <% } %>

                    <% if (passwordRequirements.lowercase) { %>
                        <li class="requirement mb-1" data-requirement="lowercase">
                            <i class="ti ti-x text-danger me-2 requirement-icon"></i>
                            <span class="requirement-text">One lowercase letter (a-z)</span>
                        </li>
                    <% } %>

                    <% if (passwordRequirements.numbers) { %>
                        <li class="requirement mb-1" data-requirement="numbers">
                            <i class="ti ti-x text-danger me-2 requirement-icon"></i>
                            <span class="requirement-text">One number (0-9)</span>
                        </li>
                    <% } %>

                    <% if (passwordRequirements.special) { %>
                        <li class="requirement mb-1" data-requirement="special">
                            <i class="ti ti-x text-danger me-2 requirement-icon"></i>
                            <span class="requirement-text">One special character (!@#$%^&*)</span>
                        </li>
                    <% } %>
                </ul>
            </div>
        </div>
    <% } %>

    <!-- Password Tips (Optional) -->
    <div class="password-tips mt-2 d-none">
        <small class="text-muted">
            <i class="ti ti-bulb me-1"></i>
            <strong>Tip:</strong> <span class="tip-text">Use a mix of letters, numbers, and symbols</span>
        </small>
    </div>
</div>

<style>
    .password-input-wrapper {
        position: relative;
    }

    .password-input-group .form-control {
        transition: all 0.3s ease;
        border: 1px solid #e0e6ed;
        position: relative;
    }

    .password-input-group .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        z-index: 3;
    }

    .password-input-group .input-group-text {
        border: 1px solid #e0e6ed;
        background: rgba(248, 249, 250, 0.8);
        transition: all 0.3s ease;
    }

    .password-input-group:focus-within .input-group-text {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .password-input-group:focus-within .input-group-text i {
        color: #667eea !important;
    }

    /* Password Toggle Button */
    .password-toggle-btn {
        border: 1px solid #e0e6ed;
        border-left: none !important;
        background: rgba(248, 249, 250, 0.8);
        transition: all 0.3s ease;
        z-index: 2;
    }

    .password-toggle-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border-color: #e0e6ed;
    }

    .password-toggle-btn:focus {
        box-shadow: none;
        border-color: #667eea;
    }

    .password-toggle-icon {
        transition: all 0.3s ease;
    }

    /* Strength Indicator */
    .password-strength .progress {
        background-color: rgba(0,0,0,0.1);
        overflow: visible;
    }

    .password-strength-bar {
        transition: all 0.3s ease;
        border-radius: 2px;
    }

    .password-strength-bar.very-weak {
        background-color: #dc3545;
        width: 20%;
    }

    .password-strength-bar.weak {
        background-color: #fd7e14;
        width: 40%;
    }

    .password-strength-bar.fair {
        background-color: #ffc107;
        width: 60%;
    }

    .password-strength-bar.good {
        background-color: #20c997;
        width: 80%;
    }

    .password-strength-bar.strong {
        background-color: #28a745;
        width: 100%;
    }

    /* Requirements List */
    .requirements-list {
        background: rgba(248, 249, 250, 0.5);
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .requirement {
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
    }

    .requirement.met .requirement-icon {
        color: #28a745 !important;
    }

    .requirement.met .requirement-icon::before {
        content: "\ea5b"; /* ti-check icon */
    }

    .requirement.met .requirement-text {
        color: #28a745;
        text-decoration: line-through;
        opacity: 0.7;
    }

    .requirement-icon {
        width: 16px;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }

    .requirements-toggle {
        color: #6c757d;
        text-decoration: none !important;
    }

    .requirements-chevron {
        transition: transform 0.3s ease;
    }

    .requirements-toggle[aria-expanded="false"] .requirements-chevron {
        transform: rotate(180deg);
    }

    /* Password Tips */
    .password-tips {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        border-left: 3px solid #667eea;
    }

    .password-tips.show {
        display: block !important;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        0% {
            opacity: 0;
            max-height: 0;
            padding: 0 0.75rem;
        }
        100% {
            opacity: 1;
            max-height: 100px;
            padding: 0.5rem 0.75rem;
        }
    }

    /* Caps Lock Warning */
    .caps-lock-warning {
        background: rgba(255, 193, 7, 0.1);
        color: #856404;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .caps-lock-warning.show {
        display: block;
    }

    @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(-10px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    /* Loading/Checking state */
    .password-input-group.checking::after {
        content: '';
        position: absolute;
        right: 60px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .password-input-group .form-control {
            font-size: 16px; /* Prevent zoom on iOS */
        }

        .requirements-list {
            padding: 0.5rem;
        }
    }

    /* High contrast support */
    @media (prefers-contrast: high) {
        .password-input-group .form-control,
        .password-toggle-btn {
            border-width: 2px;
        }

        .requirement.met .requirement-text {
            text-decoration: none;
            font-weight: bold;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .password-strength-bar,
        .requirement,
        .password-toggle-icon {
            transition: none;
        }

        .password-tips {
            animation: none;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInputs = document.querySelectorAll('[data-password-input="true"]');

    passwordInputs.forEach(input => {
        const wrapper = input.closest('.password-input-wrapper');
        const toggleBtn = wrapper.querySelector('.password-toggle-btn');
        const toggleIcon = wrapper.querySelector('.password-toggle-icon');
        const strengthBar = wrapper.querySelector('.password-strength-bar');
        const strengthText = wrapper.querySelector('.password-strength-text');
        const requirements = wrapper.querySelectorAll('.requirement');
        const tipsElement = wrapper.querySelector('.password-tips');

        // Password visibility toggle
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                toggleIcon.className = isPassword ? 'ti ti-eye-off password-toggle-icon' : 'ti ti-eye password-toggle-icon';

                // Accessibility
                toggleBtn.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
            });
        }

        // Password strength checking
        input.addEventListener('input', function() {
            const password = this.value;
            checkPasswordStrength(password, strengthBar, strengthText, requirements, tipsElement);
        });

        // Caps lock detection
        input.addEventListener('keydown', function(e) {
            const capsLockWarning = wrapper.querySelector('.caps-lock-warning') || createCapsLockWarning(wrapper);

            if (e.getModifierState && e.getModifierState('CapsLock')) {
                capsLockWarning.classList.add('show');
            } else {
                capsLockWarning.classList.remove('show');
            }
        });

        // Focus/blur events for tips
        input.addEventListener('focus', function() {
            if (tipsElement) {
                showRandomTip(tipsElement);
            }
        });

        input.addEventListener('blur', function() {
            if (tipsElement) {
                tipsElement.classList.remove('show');
            }
        });
    });

    function checkPasswordStrength(password, strengthBar, strengthText, requirements, tipsElement) {
        if (!strengthBar || !strengthText) return;

        const checks = {
            length: password.length >= 12,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            numbers: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Update requirements
        requirements.forEach(req => {
            const requirement = req.getAttribute('data-requirement');
            if (checks[requirement]) {
                req.classList.add('met');
            } else {
                req.classList.remove('met');
            }
        });

        // Calculate strength
        const score = Object.values(checks).filter(Boolean).length;
        const strengthLevels = ['very-weak', 'weak', 'fair', 'good', 'strong'];
        const strengthTexts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];

        if (password.length === 0) {
            strengthBar.className = 'progress-bar password-strength-bar';
            strengthBar.style.width = '0%';
            strengthText.textContent = 'Enter a password';
            strengthText.className = 'password-strength-text text-muted';
        } else {
            const level = Math.min(score, 4);
            strengthBar.className = `progress-bar password-strength-bar ${strengthLevels[level]}`;
            strengthText.textContent = strengthTexts[level];
            strengthText.className = `password-strength-text text-${level < 2 ? 'danger' : level < 4 ? 'warning' : 'success'}`;
        }
    }

    function createCapsLockWarning(wrapper) {
        const warning = document.createElement('div');
        warning.className = 'caps-lock-warning';
        warning.innerHTML = '<i class="ti ti-alert-triangle me-1"></i>Caps Lock is on';
        wrapper.appendChild(warning);
        return warning;
    }

    function showRandomTip(tipsElement) {
        const tips = [
            "Use a mix of letters, numbers, and symbols",
            "Avoid common words and personal information",
            "Consider using a passphrase with spaces",
            "Length is more important than complexity",
            "Use a unique password for each account"
        ];

        const randomTip = tips[Math.floor(Math.random() * tips.length)];
        tipsElement.querySelector('.tip-text').textContent = randomTip;
        tipsElement.classList.add('show');
    }

});
</script>